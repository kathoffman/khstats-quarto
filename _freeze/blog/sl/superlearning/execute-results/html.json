{
  "hash": "a607c9c3a66a443e833a84b2b413fb0c",
  "result": {
    "markdown": "---\ntitle: \"Become a Superlearner! An Illustrated Guide to Superlearning\"\nauthor: \"Katherine Hoffman\"\ndate: 2020-10-10T21:13:14-05:00\nimage: /img/sl_steps/Superlearning_crop.jpg\ntags: [\"R\",\"SuperLearner\",\"superlearning\",\"stacking\",\"stacked generalizations\",\"ensemble learning\",\"sl3\",\"rstats\"]\npage-layout: article\ncategories: [\"statistics\"]\ndescription: \" \"\noutput:\n  blogdown::html_page:\n    toc: false\n    toc_depth: 1\n---\n\n\n<html>\n\n<head>\n\n<title>HTML Image as link</title>\n\n</head>\n\n<body>\n\n<img src=\"/img/sl_steps/Superlearning.jpg\" alt=\"cheatsheet\" width=\"100%&quot;\"/>\n\n<figcaption>***A Visual Guide...*** Over the winter, I read [*Targeted Learning*](https://www.springer.com/gp/book/9781441997814) by Mark van der Laan and Sherri Rose. This \"visual guide\" I made for *Chapter 3: Superlearning* by Rose, van der Laan, and Eric Polley is a condensed version of the following tutorial. It is available as an [8.5x11\" pdf on Github](https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/Superlearner.pdf), should you wish to print it out for reference (or desk decor).</figcaption>\n\n</a>\n\n</body>\n\n</html>\n\n<br>\n\n# Supercuts of superlearning\n\n-   **Superlearning** is a technique for prediction that involves **combining many individual statistical algorithms** (commonly called \"data-adaptive\" or \"machine learning\" algorithms) to **create a new, single prediction algorithm** that is expected to **perform at least as well as any of the individual algorithms**.\n-   The superlearner algorithm \"decides\" how to combine, or weight, the individual algorithms based upon how well each one **minimizes a specified loss function**, for example, the mean squared error (MSE). This is done using cross-validation to avoid overfitting.\n-   The motivation for this type of \"ensembling\" is that **a mix of multiple algorithms may be more optimal for a given data set than any single algorithm**. For example, a tree based model averaged with a linear model (e.g. random forests and LASSO) could smooth some of the model's edges to improve predictive performance.\n-   Superlearning is also called stacking, stacked generalizations, and weighted ensembling by different specializations within the realms of statistics and data science.\n\n![](/img/spiderman_meme.jpg){width=\"42%\"}\n\n# Superlearning, step by step\n\nFirst I'll go through the algorithm one step at a time using a simulated data set.\n\n## Initial set-up: Load libraries, set seed, simulate data\n\nFor simplicity I'll show the concept of superlearning using only four variables (AKA features or predictors) to predict a continuous outcome. Let's first simulate a continuous outcome, `y`, and four potential predictors, `x1`, `x2`, `x3`, and `x4`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(gt)\nset.seed(7)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 5000\nobs <- tibble(\n  id = 1:n,\n  x1 = rnorm(n),\n  x2 = rbinom(n, 1, plogis(10*x1)),\n  x3 = rbinom(n, 1, plogis(x1*x2 + .5*x2)),\n  x4 = rnorm(n, mean=x1*x2, sd=.5*x3),\n  y = x1 + x2 + x2*x3 + sin(x4)\n)\ngt(head(obs)) %>%\n  tab_header(\"Simulated data set\") %>%\n  fmt_number(everything(),decimals=3)\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"epunggiefm\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#epunggiefm table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#epunggiefm thead, #epunggiefm tbody, #epunggiefm tfoot, #epunggiefm tr, #epunggiefm td, #epunggiefm th {\n  border-style: none;\n}\n\n#epunggiefm p {\n  margin: 0;\n  padding: 0;\n}\n\n#epunggiefm .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#epunggiefm .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#epunggiefm .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#epunggiefm .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#epunggiefm .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#epunggiefm .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#epunggiefm .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#epunggiefm .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#epunggiefm .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#epunggiefm .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#epunggiefm .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#epunggiefm .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#epunggiefm .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#epunggiefm .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#epunggiefm .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#epunggiefm .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#epunggiefm .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#epunggiefm .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#epunggiefm .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#epunggiefm .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#epunggiefm .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#epunggiefm .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#epunggiefm .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#epunggiefm .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#epunggiefm .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#epunggiefm .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#epunggiefm .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#epunggiefm .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#epunggiefm .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#epunggiefm .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#epunggiefm .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#epunggiefm .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#epunggiefm .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#epunggiefm .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#epunggiefm .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#epunggiefm .gt_left {\n  text-align: left;\n}\n\n#epunggiefm .gt_center {\n  text-align: center;\n}\n\n#epunggiefm .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#epunggiefm .gt_font_normal {\n  font-weight: normal;\n}\n\n#epunggiefm .gt_font_bold {\n  font-weight: bold;\n}\n\n#epunggiefm .gt_font_italic {\n  font-style: italic;\n}\n\n#epunggiefm .gt_super {\n  font-size: 65%;\n}\n\n#epunggiefm .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#epunggiefm .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#epunggiefm .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#epunggiefm .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#epunggiefm .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#epunggiefm .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#epunggiefm .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"6\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Simulated data set</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"id\">id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"x1\">x1</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"x2\">x2</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"x3\">x3</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"x4\">x4</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"y\">y</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">1.000</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">2.287</td>\n<td headers=\"x2\" class=\"gt_row gt_right\">1.000</td>\n<td headers=\"x3\" class=\"gt_row gt_right\">1.000</td>\n<td headers=\"x4\" class=\"gt_row gt_right\">1.385</td>\n<td headers=\"y\" class=\"gt_row gt_right\">5.270</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">2.000</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">−1.197</td>\n<td headers=\"x2\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"x3\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"x4\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"y\" class=\"gt_row gt_right\">−1.197</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">3.000</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">−0.694</td>\n<td headers=\"x2\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"x3\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"x4\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"y\" class=\"gt_row gt_right\">−0.694</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">4.000</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">−0.412</td>\n<td headers=\"x2\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"x3\" class=\"gt_row gt_right\">1.000</td>\n<td headers=\"x4\" class=\"gt_row gt_right\">−0.541</td>\n<td headers=\"y\" class=\"gt_row gt_right\">−0.928</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">5.000</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">−0.971</td>\n<td headers=\"x2\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"x3\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"x4\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"y\" class=\"gt_row gt_right\">−0.971</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">6.000</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">−0.947</td>\n<td headers=\"x2\" class=\"gt_row gt_right\">0.000</td>\n<td headers=\"x3\" class=\"gt_row gt_right\">1.000</td>\n<td headers=\"x4\" class=\"gt_row gt_right\">−0.160</td>\n<td headers=\"y\" class=\"gt_row gt_right\">−1.107</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\" >\n\n<strong>Step 1: Split data into K folds\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\n![](/img/sl_steps/step1.png){width=\"50%\"} The superlearner algorithm relies on K-fold cross-validation (CV) to avoid overfitting. We will start this process by splitting the data into 10 folds. The easiest way to do this is by creating indices for each CV fold.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nk <- 10 # 10 fold cv\ncv_index <- sample(rep(1:k, each = n/k)) # create indices for each CV fold. We need each fold K to contain n (all the rows of our data set) divided by k rows. in our example this is 5000/10 = 500 rows in each fold\n```\n:::\n\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 2: Fit base learners for first CV-fold\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\n![](/img/sl_steps/step2.png){width=\"50%\"}\n\nRecall that in K-fold CV, each fold serves as the validation set one time. In this first round of CV, we will train all of our base learners on all the CV folds (k = 1,2,...,9) *except* for the very last one: `cv_index == 10`.\n\nThe individual algorithms or **base learners** that we'll use here are three linear regressions with differently specified parameters:\n\n1.  **Learner A**: $Y=\\beta_0 + \\beta_1 X_2 + \\beta_2 X_4 + \\epsilon$\n\n2.  **Learner B**: $Y=\\beta_0 + \\beta_1 X_1 + \\beta_2 X_2 + \\beta_3 X_1 X_3 + \\beta_4 sin(X_4) + \\epsilon$\n\n3.  **Learner C**: $Y=\\beta_0 + \\beta_1 X_1 + \\beta_2 X_2 + \\beta_3 X_3 + \\beta_4 X_1 X_2 + \\beta_5 X_1 X_3 + \\beta_6 X_2 X_3 + \\beta_7 X_1 X_2 X_3 + \\epsilon$\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_train_1 <- obs[-which(cv_index == 10),] # make a data set that contains all observations except those in k=1\nfit_1a <- glm(y ~ x2 + x4, data=cv_train_1) # fit the first linear regression on that training data\nfit_1b <- glm(y ~ x1 + x2 + x1*x3 + sin(x4), data=cv_train_1) # second LR fit on the training data\nfit_1c <- glm(y ~ x1*x2*x3, data=cv_train_1) # and the third LR\n```\n:::\n\n\nI am *only* using the linear regressions so that code for running more complicated regressions does not take away from understanding the general superlearning algorithm.\n\nSuperlearning actually works best if you use a diverse set, or **superlearner library**, of base learners. For example, instead of three linear regressions, we could use a least absolute shrinkage estimator (LASSO), random forest, and multivariate adaptive splines (MARS). Any parametric or non-parametric supervised machine learning algorithm can be included as a base learner.\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 3: Obtain predictions for first CV-fold\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\n![](/img/sl_steps/step3.png){width=\"50%\"}\n\nWe can then get use our validation data, `cv_index == 10`, to obtain our first set of cross-validated predictions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_valid_1 <- obs[which(cv_index == 10),] # make a data set that only contains observations except in k=10\npred_1a <- predict(fit_1a, newdata = cv_valid_1) # use that data set as the validation for all the models in the SL library\npred_1b <- predict(fit_1b, newdata = cv_valid_1) \npred_1c <- predict(fit_1c, newdata = cv_valid_1)\n```\n:::\n\n\nSince we have 5000 `obs`ervations, that gives us three vectors of length 500: a set of predictions for each of our Learners A, B, and C.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(pred_1a) # double check we only have n/k predictions ...we do :-)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 500\n```\n:::\n\n```{.r .cell-code}\nhead(cbind(pred_1a, pred_1b, pred_1c)) %>%\n  as.data.frame() %>% gt() %>%\n  fmt_number(everything(), decimals = 2) %>%\n  tab_header(\"First CV round of predictions\") \n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"uqioxzzkvs\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#uqioxzzkvs table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#uqioxzzkvs thead, #uqioxzzkvs tbody, #uqioxzzkvs tfoot, #uqioxzzkvs tr, #uqioxzzkvs td, #uqioxzzkvs th {\n  border-style: none;\n}\n\n#uqioxzzkvs p {\n  margin: 0;\n  padding: 0;\n}\n\n#uqioxzzkvs .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#uqioxzzkvs .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#uqioxzzkvs .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#uqioxzzkvs .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#uqioxzzkvs .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#uqioxzzkvs .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#uqioxzzkvs .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#uqioxzzkvs .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#uqioxzzkvs .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#uqioxzzkvs .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#uqioxzzkvs .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#uqioxzzkvs .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#uqioxzzkvs .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#uqioxzzkvs .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#uqioxzzkvs .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uqioxzzkvs .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#uqioxzzkvs .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#uqioxzzkvs .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#uqioxzzkvs .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uqioxzzkvs .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#uqioxzzkvs .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uqioxzzkvs .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#uqioxzzkvs .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uqioxzzkvs .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#uqioxzzkvs .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uqioxzzkvs .gt_left {\n  text-align: left;\n}\n\n#uqioxzzkvs .gt_center {\n  text-align: center;\n}\n\n#uqioxzzkvs .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#uqioxzzkvs .gt_font_normal {\n  font-weight: normal;\n}\n\n#uqioxzzkvs .gt_font_bold {\n  font-weight: bold;\n}\n\n#uqioxzzkvs .gt_font_italic {\n  font-style: italic;\n}\n\n#uqioxzzkvs .gt_super {\n  font-size: 65%;\n}\n\n#uqioxzzkvs .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#uqioxzzkvs .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#uqioxzzkvs .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#uqioxzzkvs .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#uqioxzzkvs .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#uqioxzzkvs .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#uqioxzzkvs .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"3\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>First CV round of predictions</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"pred_1a\">pred_1a</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"pred_1b\">pred_1b</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"pred_1c\">pred_1c</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"pred_1a\" class=\"gt_row gt_right\">−0.77</td>\n<td headers=\"pred_1b\" class=\"gt_row gt_right\">−0.81</td>\n<td headers=\"pred_1c\" class=\"gt_row gt_right\">−0.69</td></tr>\n    <tr><td headers=\"pred_1a\" class=\"gt_row gt_right\">2.54</td>\n<td headers=\"pred_1b\" class=\"gt_row gt_right\">1.89</td>\n<td headers=\"pred_1c\" class=\"gt_row gt_right\">1.63</td></tr>\n    <tr><td headers=\"pred_1a\" class=\"gt_row gt_right\">0.19</td>\n<td headers=\"pred_1b\" class=\"gt_row gt_right\">0.60</td>\n<td headers=\"pred_1c\" class=\"gt_row gt_right\">−0.32</td></tr>\n    <tr><td headers=\"pred_1a\" class=\"gt_row gt_right\">2.46</td>\n<td headers=\"pred_1b\" class=\"gt_row gt_right\">2.69</td>\n<td headers=\"pred_1c\" class=\"gt_row gt_right\">2.98</td></tr>\n    <tr><td headers=\"pred_1a\" class=\"gt_row gt_right\">3.63</td>\n<td headers=\"pred_1b\" class=\"gt_row gt_right\">4.04</td>\n<td headers=\"pred_1c\" class=\"gt_row gt_right\">3.73</td></tr>\n    <tr><td headers=\"pred_1a\" class=\"gt_row gt_right\">3.59</td>\n<td headers=\"pred_1b\" class=\"gt_row gt_right\">3.23</td>\n<td headers=\"pred_1c\" class=\"gt_row gt_right\">3.15</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 4: Obtain CV predictions for entire data set\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\n![](/img/sl_steps/step4.png){width=\"32%\"}\n\nWe'll want to get those predictions for *every* fold. So, using your favorite `for` loop, `apply` statement, or `map`ping function, fit the base learners and obtain predictions for each of them, so that there are 1000 predictions -- one for every point in `obs`ervations.\n\nThe way I chose to code this was to make a generic function that combines Step 2 (base learners fit to the training data) and Step 3 (predictions on the validation data), then use `map_dfr()` from the `purrr` package to repeat over all 10 CV folds. I saved the results in a new data frame called `cv_preds`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_folds <- as.list(1:k)\nnames(cv_folds) <- paste0(\"fold\",1:k)\n\nget_preds <- function(fold){   # function that does the same procedure as step 2 and 3 for any CV fold\n  cv_train <- obs[-which(cv_index == fold),]  # make a training data set that contains all data except fold k\n  fit_a <- glm(y ~ x2 + x4, data=cv_train)  # fit all the base learners to that data\n  fit_b <- glm(y ~ x1 + x2 + x1*x3 + sin(x4), data=cv_train)\n  fit_c <- glm(y ~ x1*x2*x3, data=cv_train)\n  cv_valid <- obs[which(cv_index == fold),]  # make a validation data set that only contains data from fold k\n  pred_a <- predict(fit_a, newdata = cv_valid)  # obtain predictions from all the base learners for that validation data\n  pred_b <- predict(fit_b, newdata = cv_valid)\n  pred_c <- predict(fit_c, newdata = cv_valid)\n  return(data.frame(\"obs_id\" = cv_valid$id, \"cv_fold\" = fold, pred_a, pred_b, pred_c))  # save the predictions and the ids of the observations in a data frame\n}\n\ncv_preds <- purrr::map_dfr(cv_folds, ~get_preds(fold = .x)) # map_dfr loops through every fold (1:k) and binds the rows of the listed results together\n\ncv_preds %>% arrange(obs_id) %>% head() %>% as.data.frame() %>% gt() %>%\n  fmt_number(cv_fold:pred_c, decimals=2) %>%\n  tab_header(\"All CV predictions for all three base learners\") \n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"wxklwgczbv\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#wxklwgczbv table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#wxklwgczbv thead, #wxklwgczbv tbody, #wxklwgczbv tfoot, #wxklwgczbv tr, #wxklwgczbv td, #wxklwgczbv th {\n  border-style: none;\n}\n\n#wxklwgczbv p {\n  margin: 0;\n  padding: 0;\n}\n\n#wxklwgczbv .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#wxklwgczbv .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#wxklwgczbv .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#wxklwgczbv .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#wxklwgczbv .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#wxklwgczbv .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#wxklwgczbv .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#wxklwgczbv .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#wxklwgczbv .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#wxklwgczbv .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#wxklwgczbv .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#wxklwgczbv .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#wxklwgczbv .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#wxklwgczbv .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#wxklwgczbv .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wxklwgczbv .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#wxklwgczbv .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#wxklwgczbv .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#wxklwgczbv .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wxklwgczbv .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#wxklwgczbv .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wxklwgczbv .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#wxklwgczbv .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wxklwgczbv .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#wxklwgczbv .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wxklwgczbv .gt_left {\n  text-align: left;\n}\n\n#wxklwgczbv .gt_center {\n  text-align: center;\n}\n\n#wxklwgczbv .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#wxklwgczbv .gt_font_normal {\n  font-weight: normal;\n}\n\n#wxklwgczbv .gt_font_bold {\n  font-weight: bold;\n}\n\n#wxklwgczbv .gt_font_italic {\n  font-style: italic;\n}\n\n#wxklwgczbv .gt_super {\n  font-size: 65%;\n}\n\n#wxklwgczbv .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#wxklwgczbv .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#wxklwgczbv .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#wxklwgczbv .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#wxklwgczbv .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#wxklwgczbv .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#wxklwgczbv .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"5\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>All CV predictions for all three base learners</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"obs_id\">obs_id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"cv_fold\">cv_fold</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"pred_a\">pred_a</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"pred_b\">pred_b</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"pred_c\">pred_c</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"obs_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\"cv_fold\" class=\"gt_row gt_right\">7.00</td>\n<td headers=\"pred_a\" class=\"gt_row gt_right\">3.74</td>\n<td headers=\"pred_b\" class=\"gt_row gt_right\">5.42</td>\n<td headers=\"pred_c\" class=\"gt_row gt_right\">5.28</td></tr>\n    <tr><td headers=\"obs_id\" class=\"gt_row gt_right\">2</td>\n<td headers=\"cv_fold\" class=\"gt_row gt_right\">6.00</td>\n<td headers=\"pred_a\" class=\"gt_row gt_right\">−0.77</td>\n<td headers=\"pred_b\" class=\"gt_row gt_right\">−1.19</td>\n<td headers=\"pred_c\" class=\"gt_row gt_right\">−1.20</td></tr>\n    <tr><td headers=\"obs_id\" class=\"gt_row gt_right\">3</td>\n<td headers=\"cv_fold\" class=\"gt_row gt_right\">10.00</td>\n<td headers=\"pred_a\" class=\"gt_row gt_right\">−0.77</td>\n<td headers=\"pred_b\" class=\"gt_row gt_right\">−0.81</td>\n<td headers=\"pred_c\" class=\"gt_row gt_right\">−0.69</td></tr>\n    <tr><td headers=\"obs_id\" class=\"gt_row gt_right\">4</td>\n<td headers=\"cv_fold\" class=\"gt_row gt_right\">8.00</td>\n<td headers=\"pred_a\" class=\"gt_row gt_right\">−1.39</td>\n<td headers=\"pred_b\" class=\"gt_row gt_right\">−0.77</td>\n<td headers=\"pred_c\" class=\"gt_row gt_right\">−0.41</td></tr>\n    <tr><td headers=\"obs_id\" class=\"gt_row gt_right\">5</td>\n<td headers=\"cv_fold\" class=\"gt_row gt_right\">2.00</td>\n<td headers=\"pred_a\" class=\"gt_row gt_right\">−0.78</td>\n<td headers=\"pred_b\" class=\"gt_row gt_right\">−1.02</td>\n<td headers=\"pred_c\" class=\"gt_row gt_right\">−0.97</td></tr>\n    <tr><td headers=\"obs_id\" class=\"gt_row gt_right\">6</td>\n<td headers=\"cv_fold\" class=\"gt_row gt_right\">9.00</td>\n<td headers=\"pred_a\" class=\"gt_row gt_right\">−0.96</td>\n<td headers=\"pred_b\" class=\"gt_row gt_right\">−1.04</td>\n<td headers=\"pred_c\" class=\"gt_row gt_right\">−0.94</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 5: Choose and compute loss function of interest via metalearner\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\n![](/img/sl_steps/step5.png){width=\"60%\"}\n\n> This is the key step of the superlearner algorithm: we will use a new learner, a **metalearner**, to take information from all of the base learners and create that new algorithm.\n\nNow that we have cross-validated predictions for every observation in the data set, we want to merge those CV predictions back into our main data set...\n\n\n::: {.cell}\n\n```{.r .cell-code}\nobs_preds <- \n  full_join(obs, cv_preds, by=c(\"id\" = \"obs_id\"))\n```\n:::\n\n\n...so that we can minimize a final loss function of interest between the true outcome and each CV prediction. This is how we're going to optimize our overall prediction algorithm: we want to make sure we're \"losing the least\" in the way we combine our base learners' predictions to ultimately make final predictions. We can do this efficiently by choosing a new learner, a metalearner, which reflects the final loss function of interest.\n\nFor simplicity, we'll use another linear regression as our metalearner. Using a linear regression as a metalearner will minimize the Cross-Validated Mean Squared Error (CV-MSE) when combining the base learner predictions. Note that we could use a variety of parametric or non-parametric regressions to minimize the CV-MSE.\n\nNo matter what metalearner we choose, the predictors will always be the cross-validated predictions from each base learner, and the outcome will always be the true outcome, `y`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsl_fit <- glm(y ~ pred_a + pred_b + pred_c, data = obs_preds)\nbroom::tidy(sl_fit) %>% gt() %>%\n  fmt_number(estimate:p.value, decimals=2) %>%\n  tab_header(\"Metalearner regression coefficients\") \n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"lofpihbenx\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#lofpihbenx table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#lofpihbenx thead, #lofpihbenx tbody, #lofpihbenx tfoot, #lofpihbenx tr, #lofpihbenx td, #lofpihbenx th {\n  border-style: none;\n}\n\n#lofpihbenx p {\n  margin: 0;\n  padding: 0;\n}\n\n#lofpihbenx .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#lofpihbenx .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#lofpihbenx .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#lofpihbenx .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#lofpihbenx .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#lofpihbenx .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#lofpihbenx .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#lofpihbenx .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#lofpihbenx .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#lofpihbenx .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#lofpihbenx .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#lofpihbenx .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#lofpihbenx .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#lofpihbenx .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#lofpihbenx .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lofpihbenx .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#lofpihbenx .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#lofpihbenx .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#lofpihbenx .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lofpihbenx .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#lofpihbenx .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lofpihbenx .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#lofpihbenx .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lofpihbenx .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#lofpihbenx .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lofpihbenx .gt_left {\n  text-align: left;\n}\n\n#lofpihbenx .gt_center {\n  text-align: center;\n}\n\n#lofpihbenx .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#lofpihbenx .gt_font_normal {\n  font-weight: normal;\n}\n\n#lofpihbenx .gt_font_bold {\n  font-weight: bold;\n}\n\n#lofpihbenx .gt_font_italic {\n  font-style: italic;\n}\n\n#lofpihbenx .gt_super {\n  font-size: 65%;\n}\n\n#lofpihbenx .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#lofpihbenx .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#lofpihbenx .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#lofpihbenx .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#lofpihbenx .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#lofpihbenx .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#lofpihbenx .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"5\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Metalearner regression coefficients</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"term\">term</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"estimate\">estimate</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"std.error\">std.error</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"statistic\">statistic</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"p.value\">p.value</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"term\" class=\"gt_row gt_left\">(Intercept)</td>\n<td headers=\"estimate\" class=\"gt_row gt_right\">0.00</td>\n<td headers=\"std.error\" class=\"gt_row gt_right\">0.00</td>\n<td headers=\"statistic\" class=\"gt_row gt_right\">−1.42</td>\n<td headers=\"p.value\" class=\"gt_row gt_right\">0.16</td></tr>\n    <tr><td headers=\"term\" class=\"gt_row gt_left\">pred_a</td>\n<td headers=\"estimate\" class=\"gt_row gt_right\">−0.02</td>\n<td headers=\"std.error\" class=\"gt_row gt_right\">0.00</td>\n<td headers=\"statistic\" class=\"gt_row gt_right\">−4.75</td>\n<td headers=\"p.value\" class=\"gt_row gt_right\">0.00</td></tr>\n    <tr><td headers=\"term\" class=\"gt_row gt_left\">pred_b</td>\n<td headers=\"estimate\" class=\"gt_row gt_right\">0.85</td>\n<td headers=\"std.error\" class=\"gt_row gt_right\">0.01</td>\n<td headers=\"statistic\" class=\"gt_row gt_right\">128.15</td>\n<td headers=\"p.value\" class=\"gt_row gt_right\">0.00</td></tr>\n    <tr><td headers=\"term\" class=\"gt_row gt_left\">pred_c</td>\n<td headers=\"estimate\" class=\"gt_row gt_right\">0.17</td>\n<td headers=\"std.error\" class=\"gt_row gt_right\">0.01</td>\n<td headers=\"statistic\" class=\"gt_row gt_right\">30.07</td>\n<td headers=\"p.value\" class=\"gt_row gt_right\">0.00</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\nThis metalearner provides us with the coefficients, or weights, to apply to each of the base learners. In other words, if we have a set of predictions from Learner A, B, and C, we can obtain our best possible predictions by starting with an intercept of -0.003, then adding -0.017 $\\times$ predictions from Learner A, 0.854 $\\times$ predictions from Learner B, and 0.165 $\\times$ predictions from Learner C.\n\n*For more information on the metalearning step, check out the [Appendix](#appendix).*\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 6: Fit base learners on entire data set\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\n![](/img/sl_steps/step6.png){width=\"50%\"}\n\nAfter we fit the metalearner, we officially have our superlearner algorithm, so it's time to input data and obtain predictions! To implement the algorithm and obtain final predictions, we first need to fit the base learners on the full data set.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_a <- glm(y ~ x2 + x4, data=obs)\nfit_b <- glm(y ~ x1 + x2 + x1*x3 + sin(x4), data=obs)\nfit_c <- glm(y ~ x1*x2*x3, data=obs)\n```\n:::\n\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 7: Obtain predictions from each base learner on entire data set\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\n![](/img/sl_steps/step7.png){width=\"40%\"}\n\nWe'll use *those* base learner fits to get predictions from each of the base learners for the entire data set, and then we will plug those predictions into the metalearner fit. Remember, we were previously using cross-validated predictions, rather than fitting the base learners on the whole data set. This was to avoid overfitting.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_a <- predict(fit_a)\npred_b <- predict(fit_b)\npred_c <- predict(fit_c)\nfull_data_preds <- tibble(pred_a, pred_b, pred_c)\n```\n:::\n\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 8: Use metalearner fit to weight base learners\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\n![](/img/sl_steps/step8.png){width=\"60%\"}\n\nOnce we have the predictions from the full data set, we can input them to the metalearner, where the output will be a final prediction for `y`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsl_predictions <- predict(sl_fit, newdata = full_data_preds)\ndata.frame(sl_predictions = head(sl_predictions)) %>%\n  gt() %>% fmt_number(sl_predictions, decimals=2) %>%\ntab_header(\"Final SL predictions (manual)\") \n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"cxoiligfyd\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#cxoiligfyd table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#cxoiligfyd thead, #cxoiligfyd tbody, #cxoiligfyd tfoot, #cxoiligfyd tr, #cxoiligfyd td, #cxoiligfyd th {\n  border-style: none;\n}\n\n#cxoiligfyd p {\n  margin: 0;\n  padding: 0;\n}\n\n#cxoiligfyd .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#cxoiligfyd .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#cxoiligfyd .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#cxoiligfyd .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#cxoiligfyd .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#cxoiligfyd .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#cxoiligfyd .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#cxoiligfyd .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#cxoiligfyd .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#cxoiligfyd .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#cxoiligfyd .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#cxoiligfyd .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#cxoiligfyd .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#cxoiligfyd .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#cxoiligfyd .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#cxoiligfyd .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#cxoiligfyd .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#cxoiligfyd .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#cxoiligfyd .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#cxoiligfyd .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#cxoiligfyd .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#cxoiligfyd .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#cxoiligfyd .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#cxoiligfyd .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#cxoiligfyd .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#cxoiligfyd .gt_left {\n  text-align: left;\n}\n\n#cxoiligfyd .gt_center {\n  text-align: center;\n}\n\n#cxoiligfyd .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#cxoiligfyd .gt_font_normal {\n  font-weight: normal;\n}\n\n#cxoiligfyd .gt_font_bold {\n  font-weight: bold;\n}\n\n#cxoiligfyd .gt_font_italic {\n  font-style: italic;\n}\n\n#cxoiligfyd .gt_super {\n  font-size: 65%;\n}\n\n#cxoiligfyd .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#cxoiligfyd .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#cxoiligfyd .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#cxoiligfyd .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#cxoiligfyd .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#cxoiligfyd .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#cxoiligfyd .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"1\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Final SL predictions (manual)</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"sl_predictions\">sl_predictions</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">5.44</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−1.20</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−0.79</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−0.71</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−1.02</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−1.03</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\nAnd... that's it! Those are our superlearner predictions for the full data set.\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 9: Obtain predictions on new data\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\nWe can now modify Step 7 and Step 8 to accommodate any new observation(s):\n\n> **To predict on new data:**<br> 1. Use the fits from each base learner to obtain base learner predictions for the new observation(s).<br> 2. Plug those base learner predictions into the metalearner fit.\n\nWe can generate a single `new_obs`ervation to see how this would work in practice.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew_obs <- tibble(x1 = .5, x2 = 0, x3 = 0, x4 = -3)\nnew_pred_a <- predict(fit_a, new_obs)\nnew_pred_b <- predict(fit_b, new_obs)\nnew_pred_c <- predict(fit_c, new_obs)\nnew_pred_df <- tibble(\"pred_a\" = new_pred_a, \"pred_b\" = new_pred_b, \"pred_c\" = new_pred_c)\npredict(sl_fit, newdata = new_pred_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        1 \n0.1183103 \n```\n:::\n:::\n\n\nOur superlearner model predicts that an observation with predictors $X_1=.5$, $X_2=0$, $X_3=0$, and $X_4=-3$ will have an outcome of $Y=0.118$.\n\n<html>\n\n<body>\n\n<h2 style=\"color:#c30a0a\">\n\n<strong>Step 10 and beyond...\n\n</h1>\n\n</strong>\n\n</body>\n\n</html>\n\nWe could compute the MSE of the ensemble superlearner predictions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsl_mse <- mean((obs$y - sl_predictions)^2)\nsl_mse\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.01927392\n```\n:::\n:::\n\n\nWe could also add more algorithms to our base learner library (we definitely should, since we only used linear regressions!), and we could write functions to tune these algorithms' hyperparameters over various grids. For example, if we were to include random forest in our library, we may want to tune over a number of trees and maximum bucket sizes.\n\nWe can then cross-validate this entire process to evaluate the predictive performance of our superlearner algorithm. Alternatively, we could leave a hold-out training data set to evaluate the performance.\n\n# Using the `SuperLearner` package\n\nOr... we could use a package and avoid all the hand-coding. Here is how you would build an ensemble superlearner for our data with the base learner libraries of `ranger` (random forests), `glmnet` (LASSO, by default), and `earth` (MARS) using the `SuperLearner` package in `R`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(SuperLearner)\nx_df <- obs %>% select(x1:x4) %>% as.data.frame()\nsl_fit <- SuperLearner(Y = obs$y, X = x_df, family = gaussian(),\n                     SL.library = c(\"SL.ranger\", \"SL.glmnet\", \"SL.earth\"))\n```\n:::\n\n\nYou can specify the metalearner with the `method` argument. The default is [Non-Negative Least Squares](##non-negative-least-squares) (NNLS).\n\n## CV-Risk and Coefficient Weights\n\nWe can examine the cross-validated `Risk` (loss function), and the `Coef`ficient (weight) given to each of the models.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsl_fit\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:  \nSuperLearner(Y = obs$y, X = x_df, family = gaussian(), SL.library = c(\"SL.ranger\",  \n    \"SL.glmnet\", \"SL.earth\")) \n\n                     Risk      Coef\nSL.ranger_All 0.013672503 0.1606329\nSL.glmnet_All 0.097257031 0.0000000\nSL.earth_All  0.003181357 0.8393671\n```\n:::\n:::\n\n\nFrom this summary we can see that the CV-risk (the default risk is MSE) in this library of base learners is smallest for `SL.Earth`. This translates to the largest coefficient, or weight, given to the predictions from `earth`.\n\nThe LASSO model implemented by `glmnet` has the largest CV-risk, and after the metalearning step, those predictions receive a coefficient, or weight, of 0. This means that the predictions from LASSO will not be incorporated into the final predictions at all.\n\n## Obtaining the predictions\n\nWe can extract the predictions easily via the `SL.predict` element of the `SuperLearner` fit object.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(data.frame(sl_predictions = sl_fit$SL.predict)) %>% gt() %>%\n  fmt_number(everything(),decimals=2) %>% tab_header(\"Final SL predictions (package)\") \n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"exzlacqdmx\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#exzlacqdmx table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#exzlacqdmx thead, #exzlacqdmx tbody, #exzlacqdmx tfoot, #exzlacqdmx tr, #exzlacqdmx td, #exzlacqdmx th {\n  border-style: none;\n}\n\n#exzlacqdmx p {\n  margin: 0;\n  padding: 0;\n}\n\n#exzlacqdmx .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#exzlacqdmx .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#exzlacqdmx .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#exzlacqdmx .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#exzlacqdmx .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#exzlacqdmx .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#exzlacqdmx .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#exzlacqdmx .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#exzlacqdmx .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#exzlacqdmx .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#exzlacqdmx .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#exzlacqdmx .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#exzlacqdmx .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#exzlacqdmx .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#exzlacqdmx .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#exzlacqdmx .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#exzlacqdmx .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#exzlacqdmx .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#exzlacqdmx .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#exzlacqdmx .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#exzlacqdmx .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#exzlacqdmx .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#exzlacqdmx .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#exzlacqdmx .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#exzlacqdmx .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#exzlacqdmx .gt_left {\n  text-align: left;\n}\n\n#exzlacqdmx .gt_center {\n  text-align: center;\n}\n\n#exzlacqdmx .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#exzlacqdmx .gt_font_normal {\n  font-weight: normal;\n}\n\n#exzlacqdmx .gt_font_bold {\n  font-weight: bold;\n}\n\n#exzlacqdmx .gt_font_italic {\n  font-style: italic;\n}\n\n#exzlacqdmx .gt_super {\n  font-size: 65%;\n}\n\n#exzlacqdmx .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#exzlacqdmx .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#exzlacqdmx .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#exzlacqdmx .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#exzlacqdmx .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#exzlacqdmx .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#exzlacqdmx .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"1\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Final SL predictions (package)</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"sl_predictions\">sl_predictions</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">5.28</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−1.19</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−0.68</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−0.87</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−0.97</td></tr>\n    <tr><td headers=\"sl_predictions\" class=\"gt_row gt_right\">−1.08</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\n## Cross-validated Superlearner\n\nRecall that we can cross-validate the entire model fitting process to evaluate the predictive performance of our superlearner algorithm. This is easy with the function `CV.SuperLearner()`. Beware, this gets computationally burdensome very quickly!\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_sl_fit <- CV.SuperLearner(Y = obs$y, X = x_df, family = gaussian(),\n                     SL.library = c(\"SL.ranger\", \"SL.glmnet\", \"SL.earth\"))\n```\n:::\n\n\nFor more information on the `SuperLearner` package, take a look at this [vignette](https://cran.r-project.org/web/packages/SuperLearner/vignettes/Guide-to-SuperLearner.html).\n\n## Alternative packages to superlearn\n\nOther packages freely available in `R` that can be used to implement the superlearner algorithm include [`sl3`](https://tlverse.org/tlverse-handbook/sl3.html) (an update to the original `Superlearner` package), [`h2o`](https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/stacked-ensembles.html), and [`caretEnsemble`](https://rdrr.io/cran/caretEnsemble/f/vignettes/caretEnsemble-intro.Rmd). I previously wrote a [brief demo](https://www.khstats.com/blog/sl3_demo/sl/) on using `sl3` for an NYC R-Ladies demo.\n\nThe authors of `tidymodels` -- a suite of packages for machine learning including `recipes`, `parsnip`, and `rsample` -- recently came out with a new package to perform superlearning/stacking called [`stacks`](%5Bhttps://stacks.tidymodels.org/articles/basics.html). Prior to this, Alex Hayes wrote a [blog post](https://www.alexpghayes.com/blog/implementing-the-super-learner-with-tidymodels/) on using `tidymodels` infrastructure to implement superlearning.\n\n# Coming soon... when prediction is not the end goal\n\nWhen prediction is not the end goal, superlearning combines well with semi-parametric estimation methods for statistical inference. This is the reason I was reading *Targeted Learning* in the first place; I am a statistician with collaborators who typically want estimates of treatment effects with confidence intervals, not predictions!\n\nI'm working on a similar visual guide for one such semiparametric estimation method: [Targeted Maximum Likelihood Estimation](https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/TMLE.pdf) (TMLE)). TMLE allows the use of flexible statistical models like the superlearner algorithm when estimating treatment effects. If you found this superlearning tutorial helpful, you may be interested in this [similarly visual tutorial](https://www.khstats.com/blog/tmle/tutorial/) on TMLE.\n\n<html>\n\n<head>\n\n<title>HTML Image as link</title>\n\n</head>\n\n<body><a href=\"https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/TMLE.pdf\"> <img src=\"/img/TMLE.jpg\" alt=\"cheatsheet\" width=\"100%&quot;\"/> </a></body>\n\n</html>\n\n# Appendix {#appendix}\n\nThese sections contain a bit of extra information on the superlearning algorithm, such as: intuition on manually computing the loss function of interest, explanation of the discrete superlearner, brief advice on choosing a metalearner, and a different summary visual provided in the *Targeted Learning* book.\n\n### Manually computing the MSE\n\nLet's say we have chosen our loss function of interest to be the Mean Squared Error (MSE). We could first compute the squared error $(y - \\hat{y})^2$ for each CV prediction A, B, and C.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_sq_error <-\n  obs_preds %>%\n  mutate(cv_sqrd_error_a = (y-pred_a)^2,   # compute squared error for each observation\n         cv_sqrd_error_b = (y-pred_b)^2,\n         cv_sqrd_error_c = (y-pred_c)^2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_sq_error %>% \n  pivot_longer(c(cv_sqrd_error_a, cv_sqrd_error_b, cv_sqrd_error_c), # make the CV squared errors long form for plotting\n               names_to = \"base_learner\",\n               values_to = \"squared_error\") %>%\n  mutate(base_learner = toupper(str_remove(base_learner, \"cv_sqrd_error_\"))) %>%\n  ggplot(aes(base_learner, squared_error, col=base_learner)) + # make box plots\n  geom_boxplot() +\n  theme_bw() +\n  guides(col=F) +\n  labs(x = \"Base Learner\", y=\"Squared Error\", title=\"Squared Errors of Learner A, B, and C\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: The `<scale>` argument of `guides()` cannot be `FALSE`. Use \"none\" instead as\nof ggplot2 3.3.4.\n```\n:::\n\n::: {.cell-output-display}\n![](superlearning_files/figure-html/unnamed-chunk-20-1.png){width=528}\n:::\n:::\n\n\nAnd then take the mean of those three cross-validated squared error columns, grouped by `cv_fold`, to get the CV-MSE for each fold.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_risks <-\n  cv_sq_error %>%\n  group_by(cv_fold) %>%\n  summarise(cv_mse_a = mean(cv_sqrd_error_a),\n            cv_mse_b = mean(cv_sqrd_error_b),\n            cv_mse_c = mean(cv_sqrd_error_c)\n            )\ncv_risks %>%\n  pivot_longer(cv_mse_a:cv_mse_c,\n               names_to = \"base_learner\",\n               values_to = \"mse\") %>%\n  mutate(base_learner = toupper(str_remove(base_learner,\"cv_mse_\")))  %>%\n  ggplot(aes(cv_fold, mse, col=base_learner)) +\n  geom_point() +\n  theme_bw()  +\n    scale_x_continuous(breaks = 1:10) +\n  labs(x = \"Cross-Validation (CV) Fold\", y=\"Mean Squared Error (MSE)\", col = \"Base Learner\", title=\"CV-MSEs for Base Learners A, B, and C\")\n```\n\n::: {.cell-output-display}\n![](superlearning_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\nWe see that across each fold, Learner B consistently has an MSE around 0.02, while Learner C hovers around 0.1, and Learner A varies between 0.35 and 0.45. We can take another mean to get the overall CV-MSE for each learner.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_risks %>%\n  select(-cv_fold) %>%\n  summarise_all(mean) %>%\n  gt() %>%\n  fmt_number(everything(), decimals=2) %>% tab_header(\"CV-MSE for each base learner\")\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"zzlxyntbys\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#zzlxyntbys table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#zzlxyntbys thead, #zzlxyntbys tbody, #zzlxyntbys tfoot, #zzlxyntbys tr, #zzlxyntbys td, #zzlxyntbys th {\n  border-style: none;\n}\n\n#zzlxyntbys p {\n  margin: 0;\n  padding: 0;\n}\n\n#zzlxyntbys .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#zzlxyntbys .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#zzlxyntbys .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#zzlxyntbys .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#zzlxyntbys .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#zzlxyntbys .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#zzlxyntbys .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#zzlxyntbys .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#zzlxyntbys .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#zzlxyntbys .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#zzlxyntbys .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#zzlxyntbys .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#zzlxyntbys .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#zzlxyntbys .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#zzlxyntbys .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzlxyntbys .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#zzlxyntbys .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#zzlxyntbys .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#zzlxyntbys .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzlxyntbys .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#zzlxyntbys .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzlxyntbys .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#zzlxyntbys .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzlxyntbys .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#zzlxyntbys .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzlxyntbys .gt_left {\n  text-align: left;\n}\n\n#zzlxyntbys .gt_center {\n  text-align: center;\n}\n\n#zzlxyntbys .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#zzlxyntbys .gt_font_normal {\n  font-weight: normal;\n}\n\n#zzlxyntbys .gt_font_bold {\n  font-weight: bold;\n}\n\n#zzlxyntbys .gt_font_italic {\n  font-style: italic;\n}\n\n#zzlxyntbys .gt_super {\n  font-size: 65%;\n}\n\n#zzlxyntbys .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#zzlxyntbys .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#zzlxyntbys .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#zzlxyntbys .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#zzlxyntbys .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#zzlxyntbys .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#zzlxyntbys .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"3\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>CV-MSE for each base learner</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"cv_mse_a\">cv_mse_a</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"cv_mse_b\">cv_mse_b</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"cv_mse_c\">cv_mse_c</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"cv_mse_a\" class=\"gt_row gt_right\">0.38</td>\n<td headers=\"cv_mse_b\" class=\"gt_row gt_right\">0.02</td>\n<td headers=\"cv_mse_c\" class=\"gt_row gt_right\">0.11</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\nThe base learner that performs the best using our chosen loss function of interest is clearly Learner B. We can see from our data simulation code why this is true -- Learner B is almost exactly the mimicking the data generating mechanism of `y`.\n\nOur results align with the linear regression fit from our metalearning step; Learner B predictions received a much larger coefficient relative to Learners A and C.\n\n### Discrete Superlearner\n\nWe *could* stop after minimizing our loss function (MSE) and fit Learner B to our full data set, and that would be called using the **discrete superlearner**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndiscrete_sl_predictions <- predict(glm(y ~ x1 + x2 + x1*x3 + sin(x4), data=obs))\n```\n:::\n\n\nHowever, we can almost always create an even better prediction algorithm if we use information from *all* of the algorithms' CV predictions.\n\n### Choosing a metalearner\n\nIn the [Reference](#references) papers on superlearning, the metalearner which yields the best results theoretically and in practice is a **convex combination optimization** of learners. This means fitting the following regression, where $\\alpha_1$, $\\alpha_2$, and $\\alpha_3$ are all non-negative and sum to 1.\n\n$\\mathrm{E}[Y|\\hat{Y}_{LrnrA},\\hat{Y}_{LrnrB},\\hat{Y}_{LrnrC}] = \\alpha_1\\hat{Y}_{LrnrA} + \\alpha_2\\hat{Y}_{LrnrB} + \\alpha_3\\hat{Y}_{LrnrC}$\n\nThe default in the `Superlearner` package is to fit a non-negative least squares (NNLS) regression. NNLS fits the above equation where the $\\alpha$'s must be greater than or equal to 0 but do not necessarily sum to 1. The package then reweights the $\\alpha$'s to force them to sum to 1. This makes the weights a convex combination, but may not yield the same optimal results as an initial convex combination optimization.\n\nThe metalearner should change with the goals of the prediction algorithm and the loss function of interest. In these examples it is the MSE, but if the goal is to build a prediction algorithm that is best for binary classification, the loss function of interest may be the rank loss, or $1-AUC$. It is outside the scope of this post, but for more information, I recommend this [paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4912128/) by Erin Ledell on maximizing the Area Under the Curve (AUC) with superlearner algorithms.\n\n### Another visual guide for superlearning\n\nThe steps of the superlearner algorithm are summarized nicely in this graphic in Chapter 3 of the *Targeted Learning* book:\n\n![](/img/sl_diagram.png)\n\n# Acknowledgments\n\nThank you to Eric Polley, Iván Díaz, Nick Williams, Anjile An, and Adam Peterson for very helpful content (and design!) suggestions for this post.\n\n# References {#references}\n\nMJ Van der Laan, EC Polley, AE Hubbard, Super Learner, Statistical applications in genetics and molecular, 2007\n\nPolley, Eric. \"Chapter 3: Superlearning.\" Targeted Learning: Causal Inference for Observational and Experimental Data, by M. J. van der. Laan and Sherri Rose, Springer, 2011.\n\nPolley E, LeDell E, Kennedy C, van der Laan M. Super Learner: Super Learner Prediction. 2016 URL https://CRAN.R-project.org/package=SuperLearner. R package version 2.0-22.\n\nNaimi AI, Balzer LB. Stacked generalization: an introduction to super learning. *Eur J Epidemiol.* 2018;33(5):459-464. doi:10.1007/s10654-018-0390-z\n\nLeDell, E. (2015). Scalable Ensemble Learning and Computationally Efficient Variance Estimation. UC Berkeley. ProQuest ID: LeDell_berkeley_0028E_15235. Merritt ID: ark:/13030/m5wt1xp7. Retrieved from https://escholarship.org/uc/item/3kb142r2\n\nM. Petersen and L. Balzer. Introduction to Causal Inference. UC Berkeley, August 2014. [www.ucbbiostat.com](www.ucbbiostat.com)\n\n# Session Info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.1.2 (2021-11-01)\nPlatform: x86_64-apple-darwin17.0 (64-bit)\nRunning under: macOS Big Sur 10.16\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.0.dylib\nLAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\nattached base packages:\n[1] splines   stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] SuperLearner_2.0-28 gam_1.22-2          foreach_1.5.2      \n [4] nnls_1.4            gt_0.9.0            forcats_0.5.1      \n [7] stringr_1.5.0       dplyr_1.1.2         purrr_0.3.5        \n[10] readr_2.1.2         tidyr_1.2.1         tibble_3.2.1       \n[13] ggplot2_3.4.0       tidyverse_1.3.2    \n\nloaded via a namespace (and not attached):\n [1] httr_1.4.2          sass_0.4.5          jsonlite_1.8.4     \n [4] modelr_0.1.8        Formula_1.2-4       assertthat_0.2.1   \n [7] googlesheets4_1.0.0 cellranger_1.1.0    yaml_2.3.7         \n[10] pillar_1.9.0        backports_1.4.1     lattice_0.20-45    \n[13] glue_1.6.2          digest_0.6.31       rvest_1.0.2        \n[16] colorspace_2.0-3    htmltools_0.5.4     Matrix_1.3-4       \n[19] pkgconfig_2.0.3     broom_1.0.1         earth_5.3.1        \n[22] haven_2.4.3         scales_1.2.1        ranger_0.14.1      \n[25] TeachingDemos_2.12  tzdb_0.2.0          googledrive_2.0.0  \n[28] farver_2.1.1        generics_0.1.3      ellipsis_0.3.2     \n[31] withr_2.5.0         cli_3.6.1           survival_3.2-13    \n[34] magrittr_2.0.3      crayon_1.5.0        readxl_1.3.1       \n[37] evaluate_0.20       fs_1.6.2            fansi_1.0.3        \n[40] xml2_1.3.3          tools_4.1.2         hms_1.1.1          \n[43] gargle_1.2.0        lifecycle_1.0.3     munsell_0.5.0      \n[46] reprex_2.0.1        glmnet_4.1-3        plotrix_3.8-2      \n[49] compiler_4.1.2      rlang_1.1.1         plotmo_3.6.1       \n[52] grid_4.1.2          iterators_1.0.14    rstudioapi_0.13    \n[55] htmlwidgets_1.6.2   labeling_0.4.2      rmarkdown_2.20     \n[58] gtable_0.3.1        codetools_0.2-18    DBI_1.1.2          \n[61] R6_2.5.1            lubridate_1.8.0     knitr_1.42         \n[64] fastmap_1.1.0       utf8_1.2.2          shape_1.4.6        \n[67] stringi_1.7.12      Rcpp_1.0.10         vctrs_0.6.2        \n[70] dbplyr_2.1.1        tidyselect_1.2.0    xfun_0.39          \n```\n:::\n:::\n",
    "supporting": [
      "superlearning_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}