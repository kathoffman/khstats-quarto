{
  "hash": "1696302bc837686bfc1b4b29e833604f",
  "result": {
    "markdown": "---\ntitle: \"A Condensed Key for A Visual Guide to Targeted Maximum Likelihood Estimation (TMLE)\"\nauthor: \"Katherine Hoffman\"\ndate: 2019-01-09T21:13:14-05:00\ncategories: [\"statistics\",\"R\"]\nimage: \"/img/tmle/1_data_structure.png\"\nweight: 38\nmath: true\ndraft: false\ntags: [\"statistics\",\"causal inference\",\"R\",\"lmtp\",\"TMLE\",\"Targeted Maximum Likelihood Estimation\",\"introduction to TMLE\",\"targeted learning\"]\noutput:\n  blogdown::html_page:\n    toc: false\n---\n\n\nA helper post to *TMLE Part II: The Algorithm* containing only formulas and graphics.\n\n<!--more-->\n\n> A condensed key for my corresponding [TMLE tutorial](www.khstats.com/blog/tmle/tutorial) blog post.\n\n### Initial set up\n\n![](/img/tmle/1_data_structure.png){width=80%}\n**Estimand of interest:**\n\n\n$$ATE = \\Psi = E_W[\\mathrm{E}[Y|A=1,\\mathbf{W}] - \\mathrm{E}[Y|A=0,\\mathbf{W}]]$$\n\n\n<html>\n<body>\n<h2 style=\"color:navy\" > <strong>Step 1: Estimate the Outcome</h1></strong>\n</body>\n</html>\n\nFirst, estimate the expected value of the outcome using treatment and confounders as predictors.\n\n\n$$Q(A,\\mathbf{W}) = \\mathrm{E}[Y|A,\\mathbf{W}]$$\n\n![](/img/tmle/2_outcome_fit.png){width=70%}\n\nThen use that fit to obtain estimates of the expected outcome under varying three different treatment conditions:\n\n**1. If every observation received the treatment they *actually* received.**\n\n\n$$\\hat{Q}(A,\\mathbf{W}) = \\mathrm{\\hat{E}}[Y|A,\\mathbf{W}]$$\n\n\n![](/img/tmle/3_QA.png){width=50%}\n\n\n**2. If every observation received the treatment.**\n\n\n$$\\hat{Q}(1,\\mathbf{W}) = \\mathrm{\\hat{E}}[Y|A=1,\\mathbf{W}]$$\n\n\n![](/img/tmle/4_Q1.png){width=80%}\n\n**3. If every observation received the control.**\n\n\n$$\\hat{Q}(0,\\mathbf{W}) = \\mathrm{\\hat{E}}[Y|A=0,\\mathbf{W}]$$\n\n\n![](/img/tmle/5_Q1.png){width=80%}\n\n<html>\n<body>\n<h2 style=\"color:navy\" > <strong>Step 2: Estimate the Probability of Treatment</h1></strong>\n</body>\n</html>\n\nThe next step is to estimate the probability of treatment, given confounders.\n\n\n$$g(\\mathbf{W}) = \\mathrm{Pr}(A=1|\\mathbf{W})$$\n\n![](/img/tmle/6_treatment_fit.png){width=60%}\n\nThen we need to compute three different quantities from this model fit:\n\n**1. The inverse probability of receiving treatment.**\n\n\n$$H(1,\\mathbf{W}) = \\frac{1}{g(\\mathbf{W})} = \\frac{1}{\\mathrm{Pr}(A=1|\\mathbf{W})}$$\n\n\n![](/img/tmle/7_H1.png){width=60%}\n\n**2. The negative inverse probability of not receiving treatment.**\n\n\n\n$$H(0,\\mathbf{W}) = -\\frac{1}{1-g(\\mathbf{W})}= -\\frac{1}{\\mathrm{Pr}(A=0|\\mathbf{W})}$$\n\n\n![](/img/tmle/8_H0.png){width=70%}\n\n\n\n**3. If the observation was treated, the inverse probability of receiving treatment, and if they were not treated, the negative inverse probability of not receiving treatment.**\n\n\n$$H(A,\\mathbf{W}) = \\frac{\\mathrm{I}(A=1)}{\\mathrm{Pr}(A=1|\\mathbf{W})}-\\frac{\\mathrm{I}(A=0)}{\\mathrm{Pr}(A=0|\\mathbf{W})}$$\n\n\n![](/img/tmle/9_HA.png){width=50%}\n\n\n<html>\n<body>\n<h2 style=\"color:navy\" > <strong>Step 3: Estimate the Fluctuation Parameter</h1></strong>\n</body>\n</html>\n\nEstimating equation we need to solve:\n\n\n$$logit(\\mathrm{E}[Y|A,\\mathbf{W}]) = logit(\\mathrm{\\hat{E}}[Y|A,\\mathbf{W}]) + \\epsilon H(A,\\mathbf{W})$$\n\nTwo technical points for application: we use `qlogis` to transform the probabilities $\\mathrm{\\hat{E}}[Y|A,\\mathbf{W}]$ to the $logit$ scale. Also, the `R` code for a fixed intercept is `-1 + offset(fixed_intercept)`.\n\n![](/img/tmle/10_logistic_regression.png)\n\n\n\nNext we need to save the coefficient from that logistic regression, which we will call $\\hat{\\epsilon}$:\n\n![](/img/tmle/11_epsilon.png){width=40%}\n\n\n<html>\n<body>\n<h2 style=\"color:navy\" > <strong>Step 4: Update the Initial Estimates of the Expected Outcome</h1></strong>\n</body>\n</html>\n\n*Note we can use $expit$ to show the inverse of the $logit$ function, and we will denote updates to the outcome regressions as $\\hat{\\mathrm{E}}^*$.*\n\n**1. Update the expected outcomes of all observations, given the treatment they actually received and their baseline confounders.**\n\n\n$$\\hat{\\mathrm{E}}^*[Y|A,\\mathbf{W}] = expit(logit(\\mathrm{\\hat{E}}[Y|A,\\mathbf{W}]) + \\hat{\\epsilon}H(A,\\mathbf{W}))$$\n\n\n![](/img/tmle/update_qAW.png){width=70%}\n\n**2. Update the expected outcomes, conditional on baseline confounders and everyone receiving the treatment.**\n\n\n$$\\hat{\\mathrm{E}}^*[Y|A=1,\\mathbf{W}] = expit(logit(\\mathrm{\\hat{E}}[Y|A=1,\\mathbf{W}]) + \\hat{\\epsilon}H(A,1))$$\n\n![](/img/tmle/12_update_Q1.png){width=70%}\n\n**3. Update the expected outcomes, conditional on baseline confounders and no one receiving the treatment.**\n\n\n$$\\hat{\\mathrm{E}}^*[Y|A=0,\\mathbf{W}] = expit(logit(\\mathrm{\\hat{E}}[Y|A=0,\\mathbf{W}]) + \\hat{\\epsilon}H(A,0))$$\n\n![](/img/tmle/13_update_Q0.png){width=70%}\n\n<html>\n<body>\n<h2 style=\"color:navy\" > <strong>Step 5: Compute the Statistical Estimand of Interest</h1></strong>\n</body>\n</html>\n\nWe now have updated expected outcomes estimates, so we can compute the ATE as the mean difference in the updated outcome estimates under treatment and no treatment:\n\n\n$$\\hat{ATE}_{TMLE} = \\hat{\\Psi}_{TMLE} = \\sum_{i=1}^{n}[\\hat{E^*}[Y|A=1,\\mathbf{W}] - \\hat{E^*}[Y|A=0,\\mathbf{W}]]$$\n\n\n![](/img/tmle/14_compute_ATE.png){width=60%}\n\n<html>\n<body>\n<h2 style=\"color:navy\" > <strong>Step 6: Calculate the Standard Errors, Confidence Intervals, and P-values</h1></strong>\n</body>\n</html>\n\nTo obtain the standard errors, we first need to compute the **Influence Curve** (IC). The equation for the IC looks like this:\n\n\n$$\\hat{IC} = (Y-\\hat{E^*}[Y|A,\\mathbf{W}])H(A,\\mathbf{W}) + \\hat{E^*}[Y|A=1,\\mathbf{W}] - \\hat{E^*}[Y|A=0,\\mathbf{W}] - \\hat{ATE}$$\n\n\nOnce we have the IC, we can take the square-root of its variance divided by the number of observations to get the standard error of our estimate.\n\n\n$$\\hat{SE} = \\sqrt{\\frac{var(\\hat{IC})}{N}} $$\n\n\n\n![](/img/tmle/15_ses.png){width=100%}\nOnce we have that standard error, we can easily get the 95% confidence interval and p-value of our estimate.\n\n***\n\n*A visual guide designed as a printable reference is available on my [Github](https://github.com/kathoffman/CI-visual-guides/blob/master/visual-guides/TMLE.pdf):*\n\n![](/img/TMLE.jpg)",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}