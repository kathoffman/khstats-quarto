{
  "hash": "d7ae4f59519bcf35345d5b797ae75dbe",
  "result": {
    "markdown": "---\ntitle: \"Alluvial Plots (Sankey Diagrams) for Time-Varying Survival Data\"\nauthor: \"Katherine Hoffman\"\ndate: \"2023-01-02\"\ncategories: [programming]\nimage: \"image.png\"\ndraft: true\ndescription: \" \"\n---\n\n```{=tex}\n\\usepackage{amsmath}\n\\DeclareMathOperator*{\\argmax}{arg\\,max}\n```\n\n\n\n\nAlluvial plots, or Sankey diagrams, can be used to show the movement of individual units across a single variable, such as time. This post will first explain how to use the `ggalluvial` R package with a straightforward use-case: showing how an illness severity score changes in a population of critically ill patients by day.\n\nThen, we will use the same package and ideas to walk through how to show data we typically use for survival analyses in an alluvial chart. I'll use `ggalluvial` to show the movement of:\n\n- categorical, time-varying exposure\n- time-to-event outcome\n- competing event\n- loss to follow up\n\nover time. These plots can be organized to look similar to Kaplan Meier plots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(ggalluvial)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n## Step 0: Load the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsofa_wide <- read_csv(here::here(\"blog/alluvial/pseudo_sofa_khstats.csv\")) |>\n  mutate(across(starts_with(\"day\"), ~factor(.x, levels=c(\"Deceased\", 0:4,\"Missing\",\"Discharged\"))))\n```\n:::\n\n\nThe data structure we will use for each alluvial plot is **wide format**, i.e. one row per unit, and one column per time period.\n\nThe `sofa_wide` data set shows this wide format data with one row for each of the six SOFA subscore per patient. We will subset this data for now to one subscore, the pulmonary SOFA score, and use this data to make our first plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsofa_pulm <- sofa_wide |> filter(score_type == \"pulmonary_sofa\")\nhead(sofa_pulm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 6\n     id score_type     day0  day1  day2    day3   \n  <dbl> <chr>          <fct> <fct> <fct>   <fct>  \n1     1 pulmonary_sofa 0     0     0       0      \n2     2 pulmonary_sofa 0     1     Missing Missing\n3     3 pulmonary_sofa 0     0     0       0      \n4     4 pulmonary_sofa 0     2     0       0      \n5     5 pulmonary_sofa 0     1     1       0      \n6     6 pulmonary_sofa 0     2     2       2      \n```\n:::\n\n```{.r .cell-code}\nglimpse(sofa_pulm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 100\nColumns: 6\n$ id         <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …\n$ score_type <chr> \"pulmonary_sofa\", \"pulmonary_sofa\", \"pulmonary_sofa\", \"pulm…\n$ day0       <fct> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0,…\n$ day1       <fct> 0, 1, 0, 2, 1, 2, 0, 1, 2, 0, 2, 0, 2, 0, 0, 1, 2, 1, 0, 0,…\n$ day2       <fct> 0, Missing, 0, 0, 1, 2, 0, 0, 2, 0, 2, 1, Missing, 0, 0, 0,…\n$ day3       <fct> 0, Missing, 0, 0, 0, 2, 0, 0, 1, 0, 2, 1, Missing, 0, Disch…\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(sofa_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 600\nColumns: 6\n$ id         <dbl> 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4,…\n$ score_type <chr> \"pulmonary_sofa\", \"coagulation_sofa\", \"neurologic_sofa\", \"h…\n$ day0       <fct> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ day1       <fct> 0, 2, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 2, 2,…\n$ day2       <fct> 0, 2, 0, 0, 0, 1, Missing, 0, 0, 0, 1, 0, 0, 2, 0, 0, 0, 0,…\n$ day3       <fct> 0, 1, 0, 0, 0, 0, Missing, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,…\n```\n:::\n\n```{.r .cell-code}\nhead(sofa_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 6\n     id score_type          day0  day1  day2  day3 \n  <dbl> <chr>               <fct> <fct> <fct> <fct>\n1     1 pulmonary_sofa      0     0     0     0    \n2     1 coagulation_sofa    0     2     2     1    \n3     1 neurologic_sofa     0     0     0     0    \n4     1 hepatic_sofa        0     0     0     0    \n5     1 cardiovascular_sofa 0     0     0     0    \n6     1 renal_sofa          0     1     1     0    \n```\n:::\n:::\n\n\n## Step 2\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsofa_wide |>\n    filter(score_type == subscore) |>\n      group_by(day0, day1, day2, day3) |>\n    count(.drop = F) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 32 × 5\n# Groups:   day0, day1, day2, day3 [32]\n   day0  day1  day2       day3           n\n   <fct> <fct> <fct>      <fct>      <int>\n 1 0     0     0          0             45\n 2 0     0     0          1              1\n 3 0     0     0          Discharged     7\n 4 0     0     1          0              1\n 5 0     0     1          1              2\n 6 0     0     Discharged Discharged     1\n 7 0     1     0          0              7\n 8 0     1     0          1              1\n 9 0     1     1          0              3\n10 0     1     1          1              2\n# … with 22 more rows\n```\n:::\n:::\n\n\n# Step 3\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsofa_wide |>\n    filter(score_type == subscore) |>\n    group_by(day0, day1, day2, day3) |>\n    count(.drop = F) |>\n    ungroup() |>\n    to_lodes_form(key = \"day\", axes = 1:4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 128 × 4\n       n alluvium day   stratum\n   <int>    <int> <fct> <fct>  \n 1    45        1 day0  0      \n 2     1        2 day0  0      \n 3     7        3 day0  0      \n 4     1        4 day0  0      \n 5     2        5 day0  0      \n 6     1        6 day0  0      \n 7     7        7 day0  0      \n 8     1        8 day0  0      \n 9     3        9 day0  0      \n10     2       10 day0  0      \n# … with 118 more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsofa_wide |>\n    filter(score_type == subscore) |>\n    group_by(day0, day1, day2, day3) |>\n    count(.drop = F) |>\n    ungroup() |>\n    to_lodes_form(key = \"day\", axes = 1:4)  |>\n    mutate(day = case_when(day == \"day0\" ~ \"B\",\n                           TRUE ~ as.character(parse_number(as.character(day)))),\n           day = fct_relevel(day, \"B\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 128 × 4\n       n alluvium day   stratum\n   <int>    <int> <fct> <fct>  \n 1    45        1 B     0      \n 2     1        2 B     0      \n 3     7        3 B     0      \n 4     1        4 B     0      \n 5     2        5 B     0      \n 6     1        6 B     0      \n 7     7        7 B     0      \n 8     1        8 B     0      \n 9     3        9 B     0      \n10     2       10 B     0      \n# … with 118 more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsofa_alluv <- sofa_wide |>\n    filter(score_type == subscore) |>\n    group_by(day0, day1, day2, day3) |>\n    count(.drop = F) |>\n    ungroup() |>\n    to_lodes_form(key = \"day\", axes = 1:4)  |>\n    mutate(day = case_when(day == \"day0\" ~ \"B\",\n                           TRUE ~ as.character(parse_number(as.character(day)))),\n           day = fct_relevel(day, \"B\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np <-\n  sofa_alluv |>\n    ggplot(aes(x = day,\n               y = n,\n               stratum = stratum,\n               alluvium = alluvium,\n               fill = stratum))\np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np <- p + geom_flow() \np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np <- p + geom_stratum() \np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np <- p + theme_classic() \np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np <- p + coord_cartesian(xlim = c(.5,4.5),\n                         ylim = c(0,100),\n                         expand=F) \np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np <- p +\n  labs(x = \"Day\",\n       y = \"Count\",\n       fill = \"Subscore\", \n       title = paste0(snakecase::to_title_case(subscore)))\np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_pal <- ggsci::pal_nejm(\"default\", alpha = 0.6)(8)\n\np <- p +   scale_fill_manual(values = my_pal, drop=F) \np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsubscore <- \"pulmonary_sofa\"\np <- sofa_wide |>\n    filter(score_type == subscore) |>\n    group_by(day0, day1, day2, day3) |>\n    count(.drop = F) |>\n    ungroup() |>\n    to_lodes_form(key = \"day\", axes = 1:4)  |>\n    mutate(day = case_when(day == \"day0\" ~ \"B\",\n                           TRUE ~ as.character(parse_number(as.character(day)))),\n           day = fct_relevel(day, \"B\")) |>\n    ggplot(aes(x = day, y = n,\n               stratum = stratum,\n               alluvium = alluvium,\n               fill = stratum)) +\n    geom_flow() +\n    geom_stratum() +\n    theme_classic() +\n    scale_x_discrete(expand = c(0.1,0.1)) +\n    scale_fill_manual(values = my_pal, drop=F) +\n    labs(x = \"Day\", y = \"Count\",\n         fill = \"Subscore\", title = paste0(snakecase::to_title_case(subscore)))\n\np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsofa_trend_alluvial <- function(df, subscore){\n  df |>\n    filter(score_type == subscore) |>\n    group_by(day0, day1, day2, day3) |>\n    count(.drop = F) |>\n    ungroup() |>\n    to_lodes_form(key = \"day\", axes = 1:4)  |>\n    mutate(day = case_when(day == \"day0\" ~ \"B\",\n                           TRUE ~ as.character(parse_number(as.character(day)))),\n           day = fct_relevel(day, \"B\")) |>\n    ggplot(aes(x = day, y = n,\n               stratum = stratum,\n               alluvium = alluvium,\n               fill = stratum)) +\n    geom_flow() +\n    geom_stratum() +\n    theme_classic() +\n    scale_x_discrete(expand = c(0.1,0.1)) +\n    scale_fill_manual(values = my_pal, drop=F) +\n    labs(x = \"Day\", y = \"Count\",\n         fill = \"Subscore\", title = paste0(snakecase::to_title_case(str_remove(subscore,\"_sofa\"))))\n}\n```\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}