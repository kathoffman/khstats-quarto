{
  "hash": "0784392ee0c378525e58120018643290",
  "result": {
    "markdown": "---\ntitle: \"Rethinking Conditional and Iterated Expectations as Linear Regression Models\"\nauthor: \"Katherine Hoffman\"\nweight: 28\ndate: 2020-07-31T21:13:14-05:00\nimage: /img/expectations.png\ncategories: [\"R\", \"statistics\"]\ntags: [\"R\",\"statistics\",\"expectations\"]\nmath: true\noutput: \n  blogdown::html_page:\n    toc: false\n    smart: false\n    df_print: \"paged\"\n---\n\n\n\n\nIf you cringe when you see hear \"take the expectation,\" this post is for you!!\n\n<!--more-->\n\n***August 10, 2021.***\n\n# TLDR\n\n1. You can a regress an outcome on a grouping variable *plus any other variable(s)* and the unadjusted and adjusted group means will be identical.\n\n2. We can see this in a simple example using the [`palmerpenguins`](https://github.com/allisonhorst/palmerpenguins) data:\n\n\n\n```{.r .cell-code}\n#remotes::install_github(\"allisonhorst/palmerpenguins\")\nlibrary(palmerpenguins)\nlibrary(tidyverse)\nlibrary(gt)\n\n# use complete cases for simplicity\npenguins <- drop_na(penguins)\n\npenguins %>%\n  # fit a linear regression for bill length given bill depth and species\n  # make a new column containing the fitted values for bill length\n  mutate(preds = predict(lm(bill_length_mm ~ bill_depth_mm + species, data = .))) %>%\n  # compute unadjusted and adjusted group means\n  group_by(species) %>%\n  summarise(mean_bill_length = mean(bill_length_mm),\n            mean_predicted_bill_length = mean(preds)) %>%\n  gt()\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"qgwctxwrwm\" style=\"overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#qgwctxwrwm .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#qgwctxwrwm .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#qgwctxwrwm .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#qgwctxwrwm .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#qgwctxwrwm .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#qgwctxwrwm .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#qgwctxwrwm .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#qgwctxwrwm .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#qgwctxwrwm .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#qgwctxwrwm .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#qgwctxwrwm .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#qgwctxwrwm .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#qgwctxwrwm .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qgwctxwrwm .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#qgwctxwrwm .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#qgwctxwrwm .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qgwctxwrwm .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#qgwctxwrwm .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qgwctxwrwm .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#qgwctxwrwm .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qgwctxwrwm .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#qgwctxwrwm .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qgwctxwrwm .gt_left {\n  text-align: left;\n}\n\n#qgwctxwrwm .gt_center {\n  text-align: center;\n}\n\n#qgwctxwrwm .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#qgwctxwrwm .gt_font_normal {\n  font-weight: normal;\n}\n\n#qgwctxwrwm .gt_font_bold {\n  font-weight: bold;\n}\n\n#qgwctxwrwm .gt_font_italic {\n  font-style: italic;\n}\n\n#qgwctxwrwm .gt_super {\n  font-size: 65%;\n}\n\n#qgwctxwrwm .gt_two_val_uncert {\n  display: inline-block;\n  line-height: 1em;\n  text-align: right;\n  font-size: 60%;\n  vertical-align: -0.25em;\n  margin-left: 0.1em;\n}\n\n#qgwctxwrwm .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#qgwctxwrwm .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#qgwctxwrwm .gt_slash_mark {\n  font-size: 0.7em;\n  line-height: 0.7em;\n  vertical-align: 0.15em;\n}\n\n#qgwctxwrwm .gt_fraction_numerator {\n  font-size: 0.6em;\n  line-height: 0.6em;\n  vertical-align: 0.45em;\n}\n\n#qgwctxwrwm .gt_fraction_denominator {\n  font-size: 0.6em;\n  line-height: 0.6em;\n  vertical-align: -0.05em;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\">species</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\">mean_bill_length</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\">mean_predicted_bill_length</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td class=\"gt_row gt_center\">Adelie</td>\n<td class=\"gt_row gt_right\">38.82397</td>\n<td class=\"gt_row gt_right\">38.82397</td></tr>\n    <tr><td class=\"gt_row gt_center\">Chinstrap</td>\n<td class=\"gt_row gt_right\">48.83382</td>\n<td class=\"gt_row gt_right\">48.83382</td></tr>\n    <tr><td class=\"gt_row gt_center\">Gentoo</td>\n<td class=\"gt_row gt_right\">47.56807</td>\n<td class=\"gt_row gt_right\">47.56807</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n\n\n\n3. This is because $E[E[Y|X,Z]|Z=z]=E[Y|Z=z]$.\n\n4. We can view a fitted value from the regression, $E[Y|X,Z]$, as a random variable to help us see this.\n\n***[Skip to the end](#step-by-step-proof) to see the proof.***\n\n***\n\n![](/img/expectations.png)\n\n\nI'll admit I spent many weeks of my first probability theory course struggling to understand when and why my professor was writing $X$ versus $x$. When I finally learned all the rules for expectations of random variables, I still had zero appreciation for their implications in my future work as an applied statistician.\n\nI recently found myself in a rabbit hole of expectation properties while trying to write a seemingly simple function in `R`. Now that I have the output of my function all sorted out, I have a newfound appreciation for how I can use regressions -- a framework I'm very comfortable with -- to rethink some of the properties I learned in my probability theory courses.\n\nIn the function, I was regressing an outcome on a few variables plus a grouping variable, and then returning the group means of the fitted values. My function kept outputting adjusted group means that were *identical* to the unadjusted group means.\n\nI soon realized that for what I needed to do, my grouping variable should not be in the regression model. However, I was still perplexed as to how the adjusted and unadjusted group means could be the same.\n\nI created a very basic example to test this unexpected result. I regressed a variable from the new `penguins` data set, `bill_length_mm`, on another variable  called `bill_depth_mm` and a grouping variable `species`. I then looked at the mean within each category of `species` for both the unadjusted `bill_depth_mm` and fitted values from my linear regression model for `bill_depth_mm`.\n\n\n\n\n```{.r .cell-code}\npenguins %>%\n  # fit a linear regression for bill length given bill depth and species\n  # make a new column containing the fitted values for bill length\n  mutate(preds = predict(lm(bill_length_mm ~ bill_depth_mm + species, data = .))) %>%\n  # compute unadjusted and adjusted group means\n  group_by(species) %>%\n  summarise(mean_bill_length = mean(bill_length_mm),\n            mean_predicted_bill_length = mean(preds)) %>%\n  gt()\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"ajaaquebhh\" style=\"overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#ajaaquebhh .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#ajaaquebhh .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#ajaaquebhh .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#ajaaquebhh .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#ajaaquebhh .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#ajaaquebhh .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#ajaaquebhh .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#ajaaquebhh .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ajaaquebhh .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ajaaquebhh .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#ajaaquebhh .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#ajaaquebhh .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#ajaaquebhh .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ajaaquebhh .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#ajaaquebhh .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#ajaaquebhh .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ajaaquebhh .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#ajaaquebhh .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ajaaquebhh .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#ajaaquebhh .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ajaaquebhh .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ajaaquebhh .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ajaaquebhh .gt_left {\n  text-align: left;\n}\n\n#ajaaquebhh .gt_center {\n  text-align: center;\n}\n\n#ajaaquebhh .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#ajaaquebhh .gt_font_normal {\n  font-weight: normal;\n}\n\n#ajaaquebhh .gt_font_bold {\n  font-weight: bold;\n}\n\n#ajaaquebhh .gt_font_italic {\n  font-style: italic;\n}\n\n#ajaaquebhh .gt_super {\n  font-size: 65%;\n}\n\n#ajaaquebhh .gt_two_val_uncert {\n  display: inline-block;\n  line-height: 1em;\n  text-align: right;\n  font-size: 60%;\n  vertical-align: -0.25em;\n  margin-left: 0.1em;\n}\n\n#ajaaquebhh .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#ajaaquebhh .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#ajaaquebhh .gt_slash_mark {\n  font-size: 0.7em;\n  line-height: 0.7em;\n  vertical-align: 0.15em;\n}\n\n#ajaaquebhh .gt_fraction_numerator {\n  font-size: 0.6em;\n  line-height: 0.6em;\n  vertical-align: 0.45em;\n}\n\n#ajaaquebhh .gt_fraction_denominator {\n  font-size: 0.6em;\n  line-height: 0.6em;\n  vertical-align: -0.05em;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\">species</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\">mean_bill_length</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\">mean_predicted_bill_length</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td class=\"gt_row gt_center\">Adelie</td>\n<td class=\"gt_row gt_right\">38.82397</td>\n<td class=\"gt_row gt_right\">38.82397</td></tr>\n    <tr><td class=\"gt_row gt_center\">Chinstrap</td>\n<td class=\"gt_row gt_right\">48.83382</td>\n<td class=\"gt_row gt_right\">48.83382</td></tr>\n    <tr><td class=\"gt_row gt_center\">Gentoo</td>\n<td class=\"gt_row gt_right\">47.56807</td>\n<td class=\"gt_row gt_right\">47.56807</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n\n\nI saw the same strange output, even in my simple example. I realized this must be some statistics property I'd learned about and since forgotten, so I decided to write out what I was doing in expectations.\n\nFirst, I wrote down the unadjusted group means in the form of an expectation. I wrote down a conditional expectation, since we are looking at the mean of `bill_length_mm` when `species` is restricted to a certain category. We can explicitly show this by taking the expectation of a random variable, $\\mathrm{Bill Length}$, while setting another random variable, $\\mathrm{Species}$, equal to only one category at a time.\n\n$E[\\mathrm{BillLength}|\\mathrm{Species}=Adelie]$\n\n$E[\\mathrm{BillLength}|\\mathrm{Species}=Chinstrap]$\n\n$E[\\mathrm{BillLength}|\\mathrm{Species}=Gentoo]$\n\nMore generally, we could write out the unadjusted group mean using a group indicator variable, $\\mathrm{Species}$, which can take on all possible values $species$.\n\n$E[\\mathrm{BillLength}|\\mathrm{Species}=species]$\n\nSo that's our unadjusted group means. What about the adjusted group mean? We can start by writing out the linear regression model, which is the expected value of $\\mathrm{BillLength}$, conditional on the random variables $\\mathrm{BillDepth}$ and $\\mathrm{Species}$.\n\n$E[\\mathrm{BillLength}|\\mathrm{BillDepth},\\mathrm{Species}]$\n\nWhen I used the `predict` function on the fit of that linear regression model, I obtained the fitted values from that expectation, before I separated the fitted values by group to get the grouped means. We can see those fitted values as random variables themselves, and write out another conditional mean using a group indicator variable, just as we did for the unadjusted group means earlier.\n\n\n$$E[E[\\mathrm{BillLength}|\\mathrm{BillDepth},\\mathrm{Species}]|\\mathrm{Species}=species]$$\n\n\nMy table of unadjusted and adjusted Bill Length means thus showed me that:\n\n\n$$E[E[\\mathrm{BillLength}|\\mathrm{BillDepth},\\mathrm{Species}]|\\mathrm{Species}=species] \\\\ = E[\\mathrm{BillLength}|\\mathrm{Species}=species]$$\n\n\nOr, in more general notation:\n\n\n$$E[E[Y|X,Z]|Z=z] = E[Y|Z=z]$$\n\n\nIs it true?! Spoiler alert -- yes. Let's work through the steps of the proof one by one.\n\n***\n\n# Proof set-up\n\n*Let's pretend for the proof that both our $Y$ (outcome), $X$ (adjustment variable), and $Z$ (grouping variable) are categorical (discrete) variables. This is just to make the math a bit cleaner, since the expectation of a discrete variable (a weighted summation) is a little easier to show than the expectation of a continuous variable (the integral of a probability density function times the realization of the random variable).*\n\n*A few fundamental expectation results we'll need:*\n\n#### Conditional probability\n\n$P(A|B) = \\frac{P(A ∩ B)}{P(B)}$\n\n#### Partition theorem\n\n$E[A|B] = \\sum_Ba \\cdot P(A=a|B=b)$\n\n#### Marginal distribution from a joint distribution\n\n$\\sum_A\\sum_Ba\\cdot P(A=a,B=b) = \\sum_Aa\\sum_B\\cdot P(A=a,B=b) = \\sum_Aa\\cdot P(A=a)=E[A]$\n\n***\n\n# Step-by-step Proof\n\nClick on the superscript number after each step for more information.\n\n$E[E[Y|X,Z]|Z=z]$ \n\n$=E[E[Y|X,Z=z]|Z=z]$ ^[Because we're making our outer expectation conditional on $Z=z$, we can also move $Z=z$ into our inner expectation. This becomes obvious in the `penguins` example, since we only use the fitted values from one category of `species` to get the adjusted group mean for that category.]\n\n$=\\sum_{X}E[Y|X=x,Z=z]\\cdot P(X=x|Z=z)$ ^[We can rewrite $E[Y|X,Z=z]$ as the weighted summation of all possible values $X$ can take. $E[Y|X,Z=z]$ will only ever be able to take values of $X$ that vary over the range of $x$, $E[Y|X=x,Z=z]$ since our value $z$ is already fixed. We can weight each of these possible $E[Y|X=x,Z=z]$ values by $P(X=x|Z=z)$, since that's the probabilty $X$ will take value $x$ at our already-fixed $z$. Thus, we can start to find $E[E[Y|X,Z=z]|Z=z]$ by weighting each $E[Y|X=x,Z=z]$ by $P(X=x|Z=z)$ and adding them all up (see Partition Theorem).]\n\n$=\\sum_{X}\\sum_{Y}y P(Y=y|X=x,Z=z)\\cdot P(X=x|Z=z)$ ^[We can get the expectation of $Y$ at each of those possible values of $X$ by a similar process as step 2 (weighting each $y$ by $P(Y=y|X=x, Z=z)$.]\n\n$=\\sum_{X}\\sum_{Y}y \\frac{P(Y=y,X=x,Z=z)}{P(X=x,Z=z)}\\cdot \\frac{P(X=x,Z=z)}{P(Z=z)}$ ^[By the Law of Conditional Probability, we can rewrite our conditional probabilities as joint distributions.]\n\n$=\\sum_{X}\\sum_{Y}y \\frac{P(Y=y,X=x,Z=z)}{P(Z=z)}$ ^[The denominator of the first fraction cancels out with the numerator of the second fraction.]\n\n$=\\sum_{Y}y\\sum_{X}\\frac{P(Y=y,X=x,Z=z)}{P(Z=z)}$ ^[We can switch the summations around so that $y$ is outside the summation over all values of $X$. This lets us get the joint distribution of only $Y$ and $Z$.]\n\n$=\\sum_{Y}y\\frac{P(Y=y,Z=z)}{P(Z=z)}$ ^[This is a conditional expectation, written in the form of a joint distribution.]\n\n$=\\sum_{Y}y P(Y=y|Z=z)$ ^[By the Partition Theorem.]\n\n$=E[Y|Z=z]$ ^[Rewriting the previous equation as an expectation.]\n\n\nSo, we've proved that:\n\n$E[E[Y|X,Z]|Z=z] = E[Y|Z=z]$\n\nwhich, thankfully, means I have an answer to my function output confusion. It was a lightbulb moment for me to realize I should think of an inner expectation as a random variable, and all the rules I learned about conditional and iterated expectations can be revisited in the regressions I fit on a daily basis.\n\nHere's hoping you too feel inspired to revisit probability theory from time to time, even if your work is very applied. It is, after all, a perfect activity for social distancing! 😷\n\n# References\n\nGorman KB, Williams TD, Fraser WR (2014) Ecological Sexual Dimorphism and Environmental Variability within a Community of Antarctic Penguins (Genus Pygoscelis). PLoS ONE 9(3): e90081. https://doi.org/10.1371/journal.pone.0090081\n\n[A Conditional Expectation - Arizona Math](https://www.math.arizona.edu/~tgk/464_07/cond_exp.pdf)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}