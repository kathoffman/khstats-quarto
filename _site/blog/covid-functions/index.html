<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Katherine Hoffman">
<meta name="dcterms.date" content="2020-07-10">

<title>KHstats - Silver Linings: five coding tricks learned during Lockdown</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-136820093-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<style>html{ scroll-behavior: smooth; }</style>

  </head><body class="docked nav-fixed">true





<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">KHstats</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks.html">
 <span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-illustrations" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Illustrations</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-illustrations">    
        <li>
    <a class="dropdown-item" href="../../art/illustrations_viz.html">
 <span class="dropdown-text">Visual Guides for Causal Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../art/illustrations_draw.html">
 <span class="dropdown-text">Educational Drawings and Comics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-research" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Research</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-research">    
        <li>
    <a class="dropdown-item" href="../../pubs/pubs_methods.html">
 <span class="dropdown-text">Statistics Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubs/pubs_applications.html">
 <span class="dropdown-text">Clinical Applications</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://scholar.google.com/citations?user=73RvTUoAAAAJ&amp;hl=en">
 <span class="dropdown-text">Google Scholar Profile</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/kat_hoffman_"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kathoffman"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../static/KatherineHoffman_CV_Dec2022.pdf">
 <span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:kathoffman.stats@gmail.com"><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Silver Linings: five coding tricks learned during Lockdown</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Katherine Hoffman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 10, 2020</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#a-tibble-5-9" id="toc-a-tibble-5-9" class="nav-link active" data-scroll-target="#a-tibble-5-9">A tibble: 5 × 9</a></li>
  <li><a href="#a-tibble-1623-4" id="toc-a-tibble-1623-4" class="nav-link" data-scroll-target="#a-tibble-1623-4">A tibble: 1,623 × 4</a></li>
  <li><a href="#tidylog" id="toc-tidylog" class="nav-link" data-scroll-target="#tidylog">1. <code>tidylog</code></a></li>
  <li><a href="#a-tibble-630-11" id="toc-a-tibble-630-11" class="nav-link" data-scroll-target="#a-tibble-630-11">A tibble: 630 × 11</a></li>
  <li><a href="#gtsummarytbl_summary-labelledadd_variable_labels-snakecaseto_title_case" id="toc-gtsummarytbl_summary-labelledadd_variable_labels-snakecaseto_title_case" class="nav-link" data-scroll-target="#gtsummarytbl_summary-labelledadd_variable_labels-snakecaseto_title_case">2. <code>gtsummary::tbl_summary()</code> + <code>labelled::add_variable_labels</code> + <code>snakecase::to_title_case</code></a></li>
  <li><a href="#dplyrfilter-stringrstr_detect-tolower" id="toc-dplyrfilter-stringrstr_detect-tolower" class="nav-link" data-scroll-target="#dplyrfilter-stringrstr_detect-tolower">3. <code>dplyr::filter()</code> + <code>stringr::str_detect()</code> + <code>tolower()</code></a></li>
  <li><a href="#readrparse_number" id="toc-readrparse_number" class="nav-link" data-scroll-target="#readrparse_number">4. <code>readr::parse_number()</code></a></li>
  <li><a href="#a-tibble-94-4" id="toc-a-tibble-94-4" class="nav-link" data-scroll-target="#a-tibble-94-4">A tibble: 94 × 4</a></li>
  <li><a href="#lubridates-within-interval-hours" id="toc-lubridates-within-interval-hours" class="nav-link" data-scroll-target="#lubridates-within-interval-hours">5. <code>lubridate</code>’s <code>%within%</code> + <code>interval()</code> + <code>hours()</code></a></li>
  <li><a href="#a-tibble-7-11" id="toc-a-tibble-7-11" class="nav-link" data-scroll-target="#a-tibble-7-11">A tibble: 7 × 11</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Tips for using {tidylog}, {gtsummary}, {labelled}, {snakecase}, and more.</p>
<!--more-->
<p><strong><em>July 10, 2020.</em></strong></p>
<p>In non-coronavirus times, I am the biostatistician for a team of NYC pulmonologists and intensivists. When the pandemic hit NYC in mid-March, I immediately became a <strike>100%</strike> 200% COVID-19 statistician. I received many analysis requests, though not all of them from official investigators:</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
My family recently learned I am the statistician for my hospital’s pulmonologists and now I get COVID-19 analysis requests from them, too <a href="https://t.co/wlHmUaBh6Y">pic.twitter.com/wlHmUaBh6Y</a>
</p>
— Kat Hoffman (<span class="citation" data-cites="rkatlady">@rkatlady</span>) <a href="https://twitter.com/rkatlady/status/1248746176834306056?ref_src=twsrc%5Etfw">April 10, 2020</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>Jokes aside, I was really busy during the Spring 2020 outbreak. While doing work for both hospital operations and rapidly moving COVID-19 academic research, it was especially important to code efficiently and accurately while working with a deluge of Electronic Health Record (EHR) data.</p>
<p>This post contains my favorite (because they were either the most useful or most used) lines of <code>R</code> code for turning very raw-form EHR data into analytical files for descriptive reporting and statistical inference. For the examples, I’ve created data that is a simplified version of my actual data sets – just in case you too would like to pretend you are a COVID-19 biostatistician!</p>
<p>The first data set contains some basic demographic and clinical outcome information for all COVID-19 positive patients who arrived at a hospital. The second data set contains laboratory results for all patients who arrived at the hospital during a certain window of time. In theory, the first data set (<code>patients</code>) should be a subset of the second (<code>labs</code>).</p>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load tidyverse for data creation and set seed for reproducible data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># data set of basic patient demographics</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tribble</span>(</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>id, <span class="sc">~</span>admit_dt, <span class="sc">~</span>death_or_discharge_dt,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>age, <span class="sc">~</span>sex, <span class="sc">~</span>height, <span class="sc">~</span>weight, <span class="sc">~</span>current_smoker, <span class="sc">~</span>immunosuppressed, </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span>, <span class="st">"2020-03-21 00:10"</span>, <span class="st">"2020-05-13 12:10"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="dv">64</span>, <span class="st">"Male"</span>, <span class="dv">68</span>, <span class="dv">199</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>, </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">104</span>, <span class="st">"2020-04-03 12:15"</span>, <span class="st">"2020-04-29 18:34"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="dv">25</span>, <span class="st">"Male"</span>, <span class="dv">72</span>, <span class="cn">NA</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>, </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="dv">106</span>, <span class="st">"2020-03-28 12:22"</span>, <span class="st">"2020-04-05 19:18"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="dv">49</span>, <span class="st">"Female"</span>, <span class="dv">64</span>, <span class="dv">189</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span>, </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>     <span class="dv">107</span>, <span class="st">"2020-04-10 18:15"</span>,<span class="st">"2020-04-14 19:12"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a> <span class="dv">88</span>, <span class="st">"Male"</span>, <span class="dv">62</span>, <span class="dv">111</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span>, </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="dv">111</span>, <span class="st">"2020-04-18 00:49"</span>, <span class="st">"2020-04-25 19:18"</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="dv">61</span>, <span class="st">"Female"</span>, <span class="dv">67</span>, <span class="dv">156</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set time zone for date time variables</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">ends_with</span>(<span class="st">"_dt"</span>)), <span class="sc">~</span><span class="fu">as.POSIXct</span>(., <span class="at">tz=</span><span class="st">"America/New_York"</span>))</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># generate labs data</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>labs <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="dv">100</span><span class="sc">:</span><span class="dv">110</span>, <span class="cf">function</span>(x){</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  lab_time <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2020-03-01 00:00"</span>), <span class="fu">as.POSIXct</span>(<span class="st">"2020-05-30 00:00"</span>), <span class="at">by=</span><span class="st">"hours"</span>), <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">50</span>, <span class="dv">200</span>))</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  id <span class="ot">&lt;-</span> <span class="fu">rep</span>(x, <span class="at">length.out=</span><span class="fu">length</span>(lab_time))</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  lab_name <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"D-Dimer"</span>,<span class="st">"Platelet Count"</span>,<span class="st">"C-Reactive Protein"</span>,<span class="st">"Lactate Dehydrogenase"</span>,<span class="st">"LYMPHOCYTE PERC"</span>,<span class="st">"Absolute Lymphocyte Count"</span>), <span class="at">size =</span> <span class="fu">length</span>(lab_time), <span class="at">replace =</span> T)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  lab_value <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">length</span>(lab_time), <span class="dv">100</span>, <span class="dv">1200</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  lab_value <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(lab_value <span class="sc">&gt;</span> <span class="dv">1000</span>, <span class="st">"&gt;1000"</span>, <span class="fu">as.character</span>(<span class="fu">round</span>(lab_value)))</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(id, lab_time, lab_name, lab_value)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>}) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>patients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="a-tibble-5-9" class="level1">
<h1>A tibble: 5 × 9</h1>
<pre><code> id admit_dt            death_or_discharge_dt   age sex    height weight</code></pre>
<p><dbl> <dttm> <dttm> <dbl> <chr> <dbl> <dbl> 1 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male 68 199 2 104 2020-04-03 12:15:00 2020-04-29 18:34:00 25 Male 72 NA 3 106 2020-03-28 12:22:00 2020-04-05 19:18:00 49 Female 64 189 4 107 2020-04-10 18:15:00 2020-04-14 19:12:00 88 Male 62 111 5 111 2020-04-18 00:49:00 2020-04-25 19:18:00 61 Female 67 156 # … with 2 more variables: current_smoker <chr>, immunosuppressed <chr></chr></chr></dbl></dbl></chr></dbl></dttm></dttm></dbl></p>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>labs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a-tibble-1623-4" class="level1">
<h1>A tibble: 1,623 × 4</h1>
<pre><code>  id lab_time            lab_name                  lab_value</code></pre>
<p><int> <dttm> <chr> <chr><br>
1 100 2020-05-02 03:00:00 Platelet Count 245<br>
2 100 2020-03-20 20:00:00 C-Reactive Protein &gt;1000<br>
3 100 2020-05-15 07:00:00 C-Reactive Protein 620<br>
4 100 2020-04-29 00:00:00 Absolute Lymphocyte Count 937<br>
5 100 2020-05-02 08:00:00 Platelet Count 984<br>
6 100 2020-04-13 14:00:00 Absolute Lymphocyte Count 177<br>
7 100 2020-04-30 15:00:00 LYMPHOCYTE PERC 227<br>
8 100 2020-03-24 19:00:00 LYMPHOCYTE PERC 405<br>
9 100 2020-03-12 04:00:00 C-Reactive Protein 878<br>
10 100 2020-04-09 11:00:00 Platelet Count 711<br>
# … with 1,613 more rows</chr></chr></dttm></int></p>
</section>
<section id="tidylog" class="level1">
<h1>1. <code>tidylog</code></h1>
<p>The first line of <code>R</code> code I found most useful was actually just loading an entire package. It sounds crazy, but that’s all you have to do! You simply load the package, <code>tidylog</code>, after <code>tidyverse</code> (or <code>dplyr</code> or <code>tidyr</code>):</p>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidylog, <span class="at">warn.conflicts =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, whenever you use one of the previously mentioned packages to wrangle data, <code>tidylog</code> will give you super helpful information about what just happened. For example, if you use <code>mutate</code> on a column, it will tell you how many new <code>NA</code> values were created, if any. It will also remind you which variables you removed, and will give you feedback after you’ve grouped or ungrouped by a certain variable.</p>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  patients <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute BMI</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bmi =</span> weight <span class="sc">/</span> height<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="dv">703</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove the patients height and weight from the data frame</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>height, <span class="sc">-</span>weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>mutate: new variable 'bmi' (double) with 5 unique values and 20% NA</code></pre>
<pre><code>select: dropped 2 variables (height, weight)</code></pre>
<p>It’s especially helpful for joining data, because it will tell you how many rows matched in the right and left hand side of your data. In this example, we can see that about 50% of the lab values in <code>labs</code> have a match in patients – as expected. However, one patient in <code>patients</code> does not have any labs in <code>labs</code> – not good! This would be a scenario I would need to follow up with my data source (the Informatics team I work with) to figure out.</p>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>patient_labs <span class="ot">&lt;-</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  patients <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(labs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>Joining, by = "id"
left_join: added 3 columns (lab_time, lab_name, lab_value)
&gt; rows only in x 1
&gt; rows only in y (994)
&gt; matched rows 629 (includes duplicates)
&gt; =====
&gt; rows total 630</code></pre>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>patient_labs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a-tibble-630-11" class="level1">
<h1>A tibble: 630 × 11</h1>
<pre><code>  id admit_dt            death_or_discharge_dt   age sex   current…¹ immun…²</code></pre>
<p><dbl> <dttm> <dttm> <dbl> <chr> <chr> <chr><br>
1 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
2 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
3 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
4 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
5 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
6 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
7 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
8 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
9 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
10 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
# … with 620 more rows, 4 more variables: bmi <dbl>, lab_time <dttm>, # lab_name <chr>, lab_value <chr>, and abbreviated variable names # ¹​current_smoker, ²​immunosuppressed</chr></chr></dttm></dbl></chr></chr></chr></dbl></dttm></dttm></dbl></p>
<p><code>library(tidylog)</code> has singlehandedly helped me detect countless errors while working with rapidly changing COVID-19 data from many different sources. My coworker once summed it up perfectly by saying, “<code>tidylog</code> isn’t just a package, it’s a lifestyle.”</p>
</section>
<section id="gtsummarytbl_summary-labelledadd_variable_labels-snakecaseto_title_case" class="level1">
<h1>2. <code>gtsummary::tbl_summary()</code> + <code>labelled::add_variable_labels</code> + <code>snakecase::to_title_case</code></h1>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
efficiently labeling variables: a useful skill if you make a lot of <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> tables👩🏼‍💻<br><br>feat. labelled, snakecase, stringr &amp; gtsummary 📦s <a href="https://t.co/YmiYZEjVKS">pic.twitter.com/YmiYZEjVKS</a>
</p>
— Kat Hoffman (<span class="citation" data-cites="kat_hoffman_">@kat_hoffman_</span>) <a href="https://twitter.com/kat_hoffman_/status/1305218425732595713?ref_src=twsrc%5Etfw">September 13, 2020</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><code>gtsummary</code>’s <code>tbl_summary()</code> is hands down my favorite function for making summary tables. It is so smooth and flexible to use, and it works seamlessly with the new <code>gt</code> package for making tables. You simply input a dataset containing the variables you want to summarize, and, optionally, a grouping variable to stratify those summary statistics by, and you’ll immediately have a clean and clear descriptive table!</p>
<p>In this example, I’ll use <code>tbl_summary()</code> to summarize the median and IQR or number and percent of all the demographic variables in our <code>patients</code> data set. We <em>could</em> use this code: the barebones function truly only needs a data set containing the variables of interest, and then <code>gtsummary</code> does all the formatting work:</p>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtsummary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>
Attaching package: 'gtsummary'</code></pre>
<pre><code>The following objects are masked from 'package:tidylog':

    mutate, select</code></pre>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>patients <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select vars of interest for tables</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, sex, bmi, current_smoker, immunosuppressed) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make sure all numeric variables are reported as continuous</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">list</span>(<span class="fu">all_numeric</span>() <span class="sc">~</span> <span class="st">"continuous"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That’d be fine, but what I <em>really</em> found to be useful during the NYC outbreak was the <code>labelled</code> function. Since I was constantly presenting data to clinicians, it was important that the tables and figures I showed were clear and concise. I try to always eliminate the “ugly” variable names from my presentations and reports, as a rule… but while doing that as automatically as possible.</p>
<p>It was incredibly helpful to use <code>set_variable_labels()</code> from the <code>labelled</code> package to make the variable names ready for reporting. My favorite trick was to combine this function with the <code>to_title_case()</code> function from the <code>snakecase</code> package. The latter will take any variable of the format <strong><code>snake_case</code></strong> (i.e.&nbsp;all lowercase, with underscores between words), remove the underscores, and capitalize the first letter of each word – just like a title.</p>
<p>If you use <code>to_title_case(names(.))</code> in the <code>.labels</code> global argument of the <code>set_variable_names()</code> function, it’ll clean up most variables in an extremely intuitive and readable way. Then if there are variables (such as acronyms) that are still not labelled the way you’d prefer them to be, you can directly change them by listing the variable name and the character string you’d like it to say instead. We can do this for BMI, so it does not read “Bmi” when <code>to_title_case</code> transforms the label.</p>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>patients <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select vars of interest for tables</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, sex, bmi, current_smoker, immunosuppressed) <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># edit variable names using labelled package</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  labelled<span class="sc">::</span><span class="fu">set_variable_labels</span>(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change all variable labels to "Title Case"</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.labels =</span> snakecase<span class="sc">::</span><span class="fu">to_title_case</span>(<span class="fu">names</span>(.)),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change any extra variables that are not title case, like BMI</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">bmi =</span> <span class="st">"BMI"</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># don't show missing (unknown) values</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing =</span> <span class="st">"no"</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make sure all numeric variables are reported as continuous</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">list</span>(<span class="fu">all_numeric</span>() <span class="sc">~</span> <span class="st">"continuous"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bold the labels</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>Warning: `all_numeric()` was deprecated in gtsummary 1.3.6.
The {tidyselect} and {dplyr} packages have implemented functions to select variables by class and type, and the {gtsummary} version is now deprecated.

Use `where(is.numeric)` instead.
This warning is displayed once every 8 hours.
Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
<pre><code>Warning: The `fmt_missing()` function is deprecated and will soon be removed
* Use the `sub_missing()` function instead</code></pre>
<div class="cell-output-display">

<div id="uwvdhggpza" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

:where(#uwvdhggpza) .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

:where(#uwvdhggpza) .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

:where(#uwvdhggpza) .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

:where(#uwvdhggpza) .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

:where(#uwvdhggpza) .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

:where(#uwvdhggpza) .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

:where(#uwvdhggpza) .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

:where(#uwvdhggpza) .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

:where(#uwvdhggpza) .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

:where(#uwvdhggpza) .gt_from_md > :first-child {
  margin-top: 0;
}

:where(#uwvdhggpza) .gt_from_md > :last-child {
  margin-bottom: 0;
}

:where(#uwvdhggpza) .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

:where(#uwvdhggpza) .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uwvdhggpza) .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

:where(#uwvdhggpza) .gt_row_group_first td {
  border-top-width: 2px;
}

:where(#uwvdhggpza) .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uwvdhggpza) .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_first_summary_row.thick {
  border-top-width: 2px;
}

:where(#uwvdhggpza) .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uwvdhggpza) .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

:where(#uwvdhggpza) .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uwvdhggpza) .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#uwvdhggpza) .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uwvdhggpza) .gt_left {
  text-align: left;
}

:where(#uwvdhggpza) .gt_center {
  text-align: center;
}

:where(#uwvdhggpza) .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

:where(#uwvdhggpza) .gt_font_normal {
  font-weight: normal;
}

:where(#uwvdhggpza) .gt_font_bold {
  font-weight: bold;
}

:where(#uwvdhggpza) .gt_font_italic {
  font-style: italic;
}

:where(#uwvdhggpza) .gt_super {
  font-size: 65%;
}

:where(#uwvdhggpza) .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

:where(#uwvdhggpza) .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

:where(#uwvdhggpza) .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

:where(#uwvdhggpza) .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

:where(#uwvdhggpza) .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

:where(#uwvdhggpza) .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1"><strong>Characteristic</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>N = 5</strong><sup class="gt_footnote_marks">1</sup></th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_left" style="font-weight: bold;">Age</td>
<td class="gt_row gt_center">61 (49, 64)</td></tr>
    <tr><td class="gt_row gt_left" style="font-weight: bold;">Sex</td>
<td class="gt_row gt_center"></td></tr>
    <tr><td class="gt_row gt_left" style="text-align: left; text-indent: 10px;">Female</td>
<td class="gt_row gt_center">2 (40%)</td></tr>
    <tr><td class="gt_row gt_left" style="text-align: left; text-indent: 10px;">Male</td>
<td class="gt_row gt_center">3 (60%)</td></tr>
    <tr><td class="gt_row gt_left" style="font-weight: bold;">BMI</td>
<td class="gt_row gt_center">27.3 (23.4, 30.8)</td></tr>
    <tr><td class="gt_row gt_left" style="font-weight: bold;">Current Smoker</td>
<td class="gt_row gt_center">2 (40%)</td></tr>
    <tr><td class="gt_row gt_left" style="font-weight: bold;">Immunosuppressed</td>
<td class="gt_row gt_center">3 (60%)</td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="2"><sup class="gt_footnote_marks">1</sup> Median (IQR); n (%)</td>
    </tr>
  </tfoot>
</table>
</div>
</div>
<p>So clean and readable, with such little effort! A few other lines of code I usually add to make the tables nicer with very little effort are <code>missing = "no"</code> to the main <code>tbl_summary()</code> argument, and <code>bold_labels()</code> after.</p>
</section>
<section id="dplyrfilter-stringrstr_detect-tolower" class="level1">
<h1>3. <code>dplyr::filter()</code> + <code>stringr::str_detect()</code> + <code>tolower()</code></h1>
<p>This has been <em>such</em> a life saver when searching through very long-form COVID-19 data for a particular lab, vital sign, medication, or order of interest. I often don’t know the exact word, much less capitalization, of the string I’m looking for in a data set, but this combination of functions really saves the day.</p>
<p>Here we can use it to figure out the name of patients’ absolute lymphocyte count labs. Of course we could just do something like:</p>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sort</span>(<span class="fu">unique</span>(labs<span class="sc">$</span>lab_name))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>[1] “Absolute Lymphocyte Count” “C-Reactive Protein”<br>
[3] “D-Dimer” “Lactate Dehydrogenase”<br>
[5] “LYMPHOCYTE PERC” “Platelet Count”</p>
<p>But in my actual data sets of upwards of 50 million rows, this would return thousands of results! I discovered the easiest way to find what I was looking for was to first convert the <code>lab_name</code> to all lowercase using <code>tolower(lab_name)</code>, and then search for strings using <code>str_detect()</code>, only keeping rows that matched using <code>filter()</code> and then looking at <em>those</em> unique values using <code>pull()</code>* and <code>unique()</code>.</p>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>labs <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">tolower</span>(lab_name), <span class="st">"lymph"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(lab_name) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>filter: removed 1,078 rows (66%), 545 rows remaining</code></pre>
<p>[1] “Absolute Lymphocyte Count” “LYMPHOCYTE PERC”</p>
<p>Although you don’t have to use pipes to do this, I often used those filtered rows for other exploratory data checks, such as looking at the units or distributions of the tests, so it was helpful to have it in the “tidy” format.</p>
<p>*<code>pull()</code> is a somewhat lesser known function of <code>dplyr</code> that extracts a column as a dimensionless vector from a data frame, rather than <code>select</code>ing a single column, which <code>R</code> still treats as a data frame.</p>
</section>
<section id="readrparse_number" class="level1">
<h1>4. <code>readr::parse_number()</code></h1>
<p>This is handy whenever I’m dealing with test results that can contain values above or below a detection range. Instead of using <code>as.numeric()</code> on a vector, I’ve switched to always using <code>readr</code>’s <code>parse_number()</code> function. This is because <code>as.numeric()</code> will turn values with meaningful information (such as “&gt;1,000”) into <code>NA</code>.</p>
<p>Let’s look at this with the D-Dimer values in <code>patients_labs</code>. If you’ve been keeping up with any of the cytokine storm in COVID-19 headlines, you’ll know that D-Dimers are often sky-high in severely ill COVID-19 patients. So high, that they’re sometimes out of detectable ranges*!</p>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>patient_labs <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">tolower</span>(lab_name), <span class="st">"dimer"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(lab_name, lab_value) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lab_value_numeric =</span> <span class="fu">as.numeric</span>(lab_value),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">lab_value_parsed_number =</span> readr<span class="sc">::</span><span class="fu">parse_number</span>(lab_value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>filter: removed 536 rows (85%), 94 rows remaining</code></pre>
<pre><code>Warning in mask$eval_all_mutate(quo): NAs introduced by coercion</code></pre>
</section>
<section id="a-tibble-94-4" class="level1">
<h1>A tibble: 94 × 4</h1>
<p>lab_name lab_value lab_value_numeric lab_value_parsed_number <chr> <chr> <dbl> <dbl> 1 D-Dimer 642 642 642 2 D-Dimer 531 531 531 3 D-Dimer 674 674 674 4 D-Dimer 751 751 751 5 D-Dimer 436 436 436 6 D-Dimer 181 181 181 7 D-Dimer 107 107 107 8 D-Dimer &gt;1000 NA 1000 9 D-Dimer 251 251 251 10 D-Dimer 148 148 148 # … with 84 more rows</dbl></dbl></chr></chr></p>
<p>When we use <code>as.numeric()</code> to switch the values from strings, we lose those out of range values. Those are our sickest patients, so if we continue with the analysis, we’ll definitely bias our results. However, if we use <code>parse_number()</code> we can at least evaluate those patients conservatively, using the upper bound of the test detection range.</p>
<p>*Detectable range is usually &gt;55,000 ng/mL, but for the sake of demonstration, let’s pretend it’s &gt;1,000 of the mystery units in my fake data set.</p>
</section>
<section id="lubridates-within-interval-hours" class="level1">
<h1>5. <code>lubridate</code>’s <code>%within%</code> + <code>interval()</code> + <code>hours()</code></h1>
<p>Last but not least is two beautiful functions from the <code>lubridate</code> package. If you ever find yourself working with time-stamped data, you should definitely check it out. I tried multiple functions and packages at the beginning of the outbreak, and in the end, nothing compared to <code>lubridate</code>, at least for my use-cases.</p>
<p>The <code>%within%</code> function allows you to determine whether a time value (stored in <code>R</code> as a <code>POSIXct</code> object) falls within a window of time. You can specify this window of time using the <code>interval()</code> function. If you have only the start or the end time of the window of interest, you can add or subtract using supplemental functions like <code>days()</code> or <code>hours()</code>.</p>
<p>For my COVID-19 research, the pulmonologists were often interested in snapshots of patients relative to a certain time in their disease course, for example, within the first 24 hours after intubation. The <code>lubridate</code> functions made it super easy to extract the labs, vital signs, or other information that happened relative to another date.</p>
<p>Here’s how we could use the aforementioned functions in the <code>patient_labs</code> dataset we made previously. We can extract all the labs relative to 24 hours after the hospital admission date.</p>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>
Attaching package: 'lubridate'</code></pre>
<pre><code>The following objects are masked from 'package:base':

    date, intersect, setdiff, union</code></pre>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>patient_labs <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lab_time <span class="sc">%within%</span> <span class="fu">interval</span>(admit_dt, admit_dt <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>filter: removed 623 rows (99%), 7 rows remaining</code></pre>
</section>
<section id="a-tibble-7-11" class="level1">
<h1>A tibble: 7 × 11</h1>
<pre><code> id admit_dt            death_or_discharge_dt   age sex    current…¹ immun…²</code></pre>
<p><dbl> <dttm> <dttm> <dbl> <chr> <chr> <chr><br>
1 100 2020-03-21 00:10:00 2020-05-13 12:10:00 64 Male Yes No<br>
2 104 2020-04-03 12:15:00 2020-04-29 18:34:00 25 Male Yes No<br>
3 106 2020-03-28 12:22:00 2020-04-05 19:18:00 49 Female No Yes<br>
4 106 2020-03-28 12:22:00 2020-04-05 19:18:00 49 Female No Yes<br>
5 106 2020-03-28 12:22:00 2020-04-05 19:18:00 49 Female No Yes<br>
6 106 2020-03-28 12:22:00 2020-04-05 19:18:00 49 Female No Yes<br>
7 107 2020-04-10 18:15:00 2020-04-14 19:12:00 88 Male No Yes<br>
# … with 4 more variables: bmi <dbl>, lab_time <dttm>, lab_name <chr>, # lab_value <chr>, and abbreviated variable names ¹​current_smoker, # ²​immunosuppressed</chr></chr></dttm></dbl></chr></chr></chr></dbl></dttm></dttm></dbl></p>
<p>Perfect! I could go on to informatively join this data to another using <code>tidylog</code>, make tables with clean labels using <code>tbl_summary()</code>, <code>set_variable_labels()</code>, and <code>to_title_case()</code>, find further labs of interest with <code>filter()</code>, <code>str_detect()</code>, and <code>tolower()</code>, and make the lab values numeric with <code>parse_number()</code>… the possibilities are endless!</p>
<p>I hope you enjoyed a quick insight into the data side of COVID-19 research, and/or perhaps picked up some useful function combinations for your own applied work with <code>R</code>.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/www\.khstats\.com/);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb33" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Silver Linings: five coding tricks learned during Lockdown"</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Katherine Hoffman"</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2020-07-10T21:13:14-05:00</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> ["programming"]</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> /img/covid_fx/gtsummary_tweet-crop.png</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="an">tags:</span><span class="co"> ["R","Electronic Health Record","COVID-19","data wrangling","tidyverse","tidylog","gtsummary"]</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="an">math:</span><span class="co"> true</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> " "</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">  blogdown::html_page:</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: false</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co">    smart: false</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">    df_print: "paged"</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">echo =</span> <span class="cn">TRUE</span>, <span class="at">results=</span><span class="st">"asis"</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>In non-coronavirus times, I am the biostatistician for a team of NYC pulmonologists and intensivists. When the pandemic hit NYC in mid-March, I immediately became a <span class="kw">&lt;strike&gt;</span>100%<span class="kw">&lt;/strike&gt;</span> 200% COVID-19 statistician. I received many analysis requests, though not all of them from official investigators:</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;blockquote</span> <span class="er">class</span><span class="ot">=</span><span class="st">"twitter-tweet"</span><span class="kw">&gt;</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p</span> <span class="er">lang</span><span class="ot">=</span><span class="st">"en"</span> <span class="er">dir</span><span class="ot">=</span><span class="st">"ltr"</span><span class="kw">&gt;</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>My family recently learned I am the statistician for my hospital's pulmonologists and now I get COVID-19 analysis requests from them, too <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://t.co/wlHmUaBh6Y"</span><span class="kw">&gt;</span>pic.twitter.com/wlHmUaBh6Y<span class="kw">&lt;/a&gt;</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/p&gt;</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>--- Kat Hoffman (@rkatlady) <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://twitter.com/rkatlady/status/1248746176834306056?ref_src=twsrc%5Etfw"</span><span class="kw">&gt;</span>April 10, 2020<span class="kw">&lt;/a&gt;</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/blockquote&gt;</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;script async src="https://platform.twitter.com/widgets.js" charset="utf-8"&gt;&lt;/script&gt;</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>Jokes aside, I was really busy during the Spring 2020 outbreak. While doing work for both hospital operations and rapidly moving COVID-19 academic research, it was especially important to code efficiently and accurately while working with a deluge of Electronic Health Record (EHR) data.</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>This post contains my favorite (because they were either the most useful or most used) lines of <span class="in">`R`</span> code for turning very raw-form EHR data into analytical files for descriptive reporting and statistical inference. For the examples, I've created data that is a simplified version of my actual data sets -- just in case you too would like to pretend you are a COVID-19 biostatistician!</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>The first data set contains some basic demographic and clinical outcome information for all COVID-19 positive patients who arrived at a hospital. The second data set contains laboratory results for all patients who arrived at the hospital during a certain window of time. In theory, the first data set (<span class="in">`patients`</span>) should be a subset of the second (<span class="in">`labs`</span>).</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=F, warning=F}</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="co"># load tidyverse for data creation and set seed for reproducible data</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7</span>)</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a><span class="co"># data set of basic patient demographics</span></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tribble</span>(</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>id, <span class="sc">~</span>admit_dt, <span class="sc">~</span>death_or_discharge_dt,</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>age, <span class="sc">~</span>sex, <span class="sc">~</span>height, <span class="sc">~</span>weight, <span class="sc">~</span>current_smoker, <span class="sc">~</span>immunosuppressed, </span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span>, <span class="st">"2020-03-21 00:10"</span>, <span class="st">"2020-05-13 12:10"</span>,</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="dv">64</span>, <span class="st">"Male"</span>, <span class="dv">68</span>, <span class="dv">199</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>, </span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>    <span class="dv">104</span>, <span class="st">"2020-04-03 12:15"</span>, <span class="st">"2020-04-29 18:34"</span>,</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a><span class="dv">25</span>, <span class="st">"Male"</span>, <span class="dv">72</span>, <span class="cn">NA</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>, </span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    <span class="dv">106</span>, <span class="st">"2020-03-28 12:22"</span>, <span class="st">"2020-04-05 19:18"</span>,</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a><span class="dv">49</span>, <span class="st">"Female"</span>, <span class="dv">64</span>, <span class="dv">189</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span>, </span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>     <span class="dv">107</span>, <span class="st">"2020-04-10 18:15"</span>,<span class="st">"2020-04-14 19:12"</span>,</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a> <span class="dv">88</span>, <span class="st">"Male"</span>, <span class="dv">62</span>, <span class="dv">111</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span>, </span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>    <span class="dv">111</span>, <span class="st">"2020-04-18 00:49"</span>, <span class="st">"2020-04-25 19:18"</span>,</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a><span class="dv">61</span>, <span class="st">"Female"</span>, <span class="dv">67</span>, <span class="dv">156</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span></span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set time zone for date time variables</span></span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">ends_with</span>(<span class="st">"_dt"</span>)), <span class="sc">~</span><span class="fu">as.POSIXct</span>(., <span class="at">tz=</span><span class="st">"America/New_York"</span>))</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a><span class="co"># generate labs data</span></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>labs <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="dv">100</span><span class="sc">:</span><span class="dv">110</span>, <span class="cf">function</span>(x){</span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>  lab_time <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2020-03-01 00:00"</span>), <span class="fu">as.POSIXct</span>(<span class="st">"2020-05-30 00:00"</span>), <span class="at">by=</span><span class="st">"hours"</span>), <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">50</span>, <span class="dv">200</span>))</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>  id <span class="ot">&lt;-</span> <span class="fu">rep</span>(x, <span class="at">length.out=</span><span class="fu">length</span>(lab_time))</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>  lab_name <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"D-Dimer"</span>,<span class="st">"Platelet Count"</span>,<span class="st">"C-Reactive Protein"</span>,<span class="st">"Lactate Dehydrogenase"</span>,<span class="st">"LYMPHOCYTE PERC"</span>,<span class="st">"Absolute Lymphocyte Count"</span>), <span class="at">size =</span> <span class="fu">length</span>(lab_time), <span class="at">replace =</span> T)</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>  lab_value <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">length</span>(lab_time), <span class="dv">100</span>, <span class="dv">1200</span>)</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>  lab_value <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(lab_value <span class="sc">&gt;</span> <span class="dv">1000</span>, <span class="st">"&gt;1000"</span>, <span class="fu">as.character</span>(<span class="fu">round</span>(lab_value)))</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(id, lab_time, lab_name, lab_value)</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>}) </span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>patients</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>labs</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a><span class="fu"># 1. `tidylog`</span></span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>The first line of <span class="in">`R`</span> code I found most useful was actually just loading an entire package. It sounds crazy, but that's all you have to do! You simply load the package, <span class="in">`tidylog`</span>, after <span class="in">`tidyverse`</span> (or <span class="in">`dplyr`</span> or <span class="in">`tidyr`</span>):</span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidylog, <span class="at">warn.conflicts =</span> F)</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>Then, whenever you use one of the previously mentioned packages to wrangle data, <span class="in">`tidylog`</span> will give you super helpful information about what just happened. For example, if you use <span class="in">`mutate`</span> on a column, it will tell you how many new <span class="in">`NA`</span> values were created, if any. It will also remind you which variables you removed, and will give you feedback after you've grouped or ungrouped by a certain variable.</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span></span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a>  patients <span class="sc">%&gt;%</span></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute BMI</span></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bmi =</span> weight <span class="sc">/</span> height<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="dv">703</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove the patients height and weight from the data frame</span></span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>height, <span class="sc">-</span>weight)</span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a>It's especially helpful for joining data, because it will tell you how many rows matched in the right and left hand side of your data. In this example, we can see that about 50% of the lab values in <span class="in">`labs`</span> have a match in patients -- as expected. However, one patient in <span class="in">`patients`</span> does not have any labs in <span class="in">`labs`</span> -- not good! This would be a scenario I would need to follow up with my data source (the Informatics team I work with) to figure out.</span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a>patient_labs <span class="ot">&lt;-</span></span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a>  patients <span class="sc">%&gt;%</span></span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(labs)</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>patient_labs</span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a><span class="in">`library(tidylog)`</span> has singlehandedly helped me detect countless errors while working with rapidly changing COVID-19 data from many different sources. My coworker once summed it up perfectly by saying, "<span class="in">`tidylog`</span> isn't just a package, it's a lifestyle."</span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2. `gtsummary::tbl_summary()` + `labelled::add_variable_labels` + `snakecase::to_title_case`</span></span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;blockquote</span> <span class="er">class</span><span class="ot">=</span><span class="st">"twitter-tweet"</span><span class="kw">&gt;</span></span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p</span> <span class="er">lang</span><span class="ot">=</span><span class="st">"en"</span> <span class="er">dir</span><span class="ot">=</span><span class="st">"ltr"</span><span class="kw">&gt;</span></span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>efficiently labeling variables: a useful skill if you make a lot of <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://twitter.com/hashtag/rstats?src=hash</span><span class="dv">&amp;amp;</span><span class="st">ref_src=twsrc%5Etfw"</span><span class="kw">&gt;</span>#rstats<span class="kw">&lt;/a&gt;</span> tables👩🏼‍💻<span class="kw">&lt;br&gt;&lt;br&gt;</span>feat. labelled, snakecase, stringr &amp; gtsummary 📦s <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://t.co/YmiYZEjVKS"</span><span class="kw">&gt;</span>pic.twitter.com/YmiYZEjVKS<span class="kw">&lt;/a&gt;</span></span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/p&gt;</span></span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a>--- Kat Hoffman (@kat_hoffman_) <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://twitter.com/kat_hoffman_/status/1305218425732595713?ref_src=twsrc%5Etfw"</span><span class="kw">&gt;</span>September 13, 2020<span class="kw">&lt;/a&gt;</span></span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/blockquote&gt;</span></span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;script async src="https://platform.twitter.com/widgets.js" charset="utf-8"&gt;&lt;/script&gt;</span></span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a><span class="in">`gtsummary`</span>'s <span class="in">`tbl_summary()`</span> is hands down my favorite function for making summary tables. It is so smooth and flexible to use, and it works seamlessly with the new <span class="in">`gt`</span> package for making tables. You simply input a dataset containing the variables you want to summarize, and, optionally, a grouping variable to stratify those summary statistics by, and you'll immediately have a clean and clear descriptive table!</span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a>In this example, I'll use <span class="in">`tbl_summary()`</span> to summarize the median and IQR or number and percent of all the demographic variables in our <span class="in">`patients`</span> data set. We *could* use this code: the barebones function truly only needs a data set containing the variables of interest, and then <span class="in">`gtsummary`</span> does all the formatting work:</span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a>patients <span class="sc">%&gt;%</span> </span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select vars of interest for tables</span></span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, sex, bmi, current_smoker, immunosuppressed) <span class="sc">%&gt;%</span></span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(</span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make sure all numeric variables are reported as continuous</span></span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">list</span>(<span class="fu">all_numeric</span>() <span class="sc">~</span> <span class="st">"continuous"</span>)</span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a>That'd be fine, but what I *really* found to be useful during the NYC outbreak was the <span class="in">`labelled`</span> function. Since I was constantly presenting data to clinicians, it was important that the tables and figures I showed were clear and concise. I try to always eliminate the "ugly" variable names from my presentations and reports, as a rule... but while doing that as automatically as possible.</span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a>It was incredibly helpful to use <span class="in">`set_variable_labels()`</span> from the <span class="in">`labelled`</span> package to make the variable names ready for reporting. My favorite trick was to combine this function with the <span class="in">`to_title_case()`</span> function from the <span class="in">`snakecase`</span> package. The latter will take any variable of the format **`snake_case`** (i.e. all lowercase, with underscores between words), remove the underscores, and capitalize the first letter of each word -- just like a title.</span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a>If you use <span class="in">`to_title_case(names(.))`</span> in the <span class="in">`.labels`</span> global argument of the <span class="in">`set_variable_names()`</span> function, it'll clean up most variables in an extremely intuitive and readable way. Then if there are variables (such as acronyms) that are still not labelled the way you'd prefer them to be, you can directly change them by listing the variable name and the character string you'd like it to say instead. We can do this for BMI, so it does not read "Bmi" when <span class="in">`to_title_case`</span> transforms the label.</span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a>patients <span class="sc">%&gt;%</span> </span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select vars of interest for tables</span></span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, sex, bmi, current_smoker, immunosuppressed) <span class="sc">%&gt;%</span></span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a>  <span class="co"># edit variable names using labelled package</span></span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a>  labelled<span class="sc">::</span><span class="fu">set_variable_labels</span>(</span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change all variable labels to "Title Case"</span></span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">.labels =</span> snakecase<span class="sc">::</span><span class="fu">to_title_case</span>(<span class="fu">names</span>(.)),</span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change any extra variables that are not title case, like BMI</span></span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">bmi =</span> <span class="st">"BMI"</span></span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(</span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a>    <span class="co"># don't show missing (unknown) values</span></span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing =</span> <span class="st">"no"</span>,</span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make sure all numeric variables are reported as continuous</span></span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">list</span>(<span class="fu">all_numeric</span>() <span class="sc">~</span> <span class="st">"continuous"</span>)</span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bold the labels</span></span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a>So clean and readable, with such little effort! A few other lines of code I usually add to make the tables nicer with very little effort are <span class="in">`missing = "no"`</span> to the main <span class="in">`tbl_summary()`</span> argument, and <span class="in">`bold_labels()`</span> after.</span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3. `dplyr::filter()` + `stringr::str_detect()` + `tolower()`</span></span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a>This has been *such* a life saver when searching through very long-form COVID-19 data for a particular lab, vital sign, medication, or order of interest. I often don't know the exact word, much less capitalization, of the string I'm looking for in a data set, but this combination of functions really saves the day.</span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a>Here we can use it to figure out the name of patients' absolute lymphocyte count labs. Of course we could just do something like:</span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a><span class="fu">sort</span>(<span class="fu">unique</span>(labs<span class="sc">$</span>lab_name))</span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a>But in my actual data sets of upwards of 50 million rows, this would return thousands of results! I discovered the easiest way to find what I was looking for was to first convert the <span class="in">`lab_name`</span> to all lowercase using <span class="in">`tolower(lab_name)`</span>, and then search for strings using <span class="in">`str_detect()`</span>, only keeping rows that matched using <span class="in">`filter()`</span> and then looking at *those* unique values using <span class="in">`pull()`</span><span class="sc">\*</span> and <span class="in">`unique()`</span>.</span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-207"><a href="#cb33-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-208"><a href="#cb33-208" aria-hidden="true" tabindex="-1"></a>labs <span class="sc">%&gt;%</span></span>
<span id="cb33-209"><a href="#cb33-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">tolower</span>(lab_name), <span class="st">"lymph"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb33-210"><a href="#cb33-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(lab_name) <span class="sc">%&gt;%</span></span>
<span id="cb33-211"><a href="#cb33-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span>
<span id="cb33-212"><a href="#cb33-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-213"><a href="#cb33-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-214"><a href="#cb33-214" aria-hidden="true" tabindex="-1"></a>Although you don't have to use pipes to do this, I often used those filtered rows for other exploratory data checks, such as looking at the units or distributions of the tests, so it was helpful to have it in the "tidy" format.</span>
<span id="cb33-215"><a href="#cb33-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-216"><a href="#cb33-216" aria-hidden="true" tabindex="-1"></a><span class="sc">\*</span><span class="in">`pull()`</span> is a somewhat lesser known function of <span class="in">`dplyr`</span> that extracts a column as a dimensionless vector from a data frame, rather than <span class="in">`select`</span>ing a single column, which <span class="in">`R`</span> still treats as a data frame.</span>
<span id="cb33-217"><a href="#cb33-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-218"><a href="#cb33-218" aria-hidden="true" tabindex="-1"></a><span class="fu"># 4. `readr::parse_number()`</span></span>
<span id="cb33-219"><a href="#cb33-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-220"><a href="#cb33-220" aria-hidden="true" tabindex="-1"></a>This is handy whenever I'm dealing with test results that can contain values above or below a detection range. Instead of using <span class="in">`as.numeric()`</span> on a vector, I've switched to always using <span class="in">`readr`</span>'s <span class="in">`parse_number()`</span> function. This is because <span class="in">`as.numeric()`</span> will turn values with meaningful information (such as "<span class="sc">\&gt;</span>1,000") into <span class="in">`NA`</span>.</span>
<span id="cb33-221"><a href="#cb33-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-222"><a href="#cb33-222" aria-hidden="true" tabindex="-1"></a>Let's look at this with the D-Dimer values in <span class="in">`patients_labs`</span>. If you've been keeping up with any of the cytokine storm in COVID-19 headlines, you'll know that D-Dimers are often sky-high in severely ill COVID-19 patients. So high, that they're sometimes out of detectable ranges<span class="sc">\*</span>!</span>
<span id="cb33-223"><a href="#cb33-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-226"><a href="#cb33-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-227"><a href="#cb33-227" aria-hidden="true" tabindex="-1"></a>patient_labs <span class="sc">%&gt;%</span></span>
<span id="cb33-228"><a href="#cb33-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">tolower</span>(lab_name), <span class="st">"dimer"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb33-229"><a href="#cb33-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(lab_name, lab_value) <span class="sc">%&gt;%</span></span>
<span id="cb33-230"><a href="#cb33-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lab_value_numeric =</span> <span class="fu">as.numeric</span>(lab_value),</span>
<span id="cb33-231"><a href="#cb33-231" aria-hidden="true" tabindex="-1"></a>         <span class="at">lab_value_parsed_number =</span> readr<span class="sc">::</span><span class="fu">parse_number</span>(lab_value))</span>
<span id="cb33-232"><a href="#cb33-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-233"><a href="#cb33-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-234"><a href="#cb33-234" aria-hidden="true" tabindex="-1"></a>When we use <span class="in">`as.numeric()`</span> to switch the values from strings, we lose those out of range values. Those are our sickest patients, so if we continue with the analysis, we'll definitely bias our results. However, if we use <span class="in">`parse_number()`</span> we can at least evaluate those patients conservatively, using the upper bound of the test detection range.</span>
<span id="cb33-235"><a href="#cb33-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-236"><a href="#cb33-236" aria-hidden="true" tabindex="-1"></a><span class="sc">\*</span>Detectable range is usually <span class="sc">\&gt;</span>55,000 ng/mL, but for the sake of demonstration, let's pretend it's <span class="sc">\&gt;</span>1,000 of the mystery units in my fake data set.</span>
<span id="cb33-237"><a href="#cb33-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-238"><a href="#cb33-238" aria-hidden="true" tabindex="-1"></a><span class="fu"># 5. `lubridate`'s `%within%` + `interval()` + `hours()`</span></span>
<span id="cb33-239"><a href="#cb33-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-240"><a href="#cb33-240" aria-hidden="true" tabindex="-1"></a>Last but not least is two beautiful functions from the <span class="in">`lubridate`</span> package. If you ever find yourself working with time-stamped data, you should definitely check it out. I tried multiple functions and packages at the beginning of the outbreak, and in the end, nothing compared to <span class="in">`lubridate`</span>, at least for my use-cases.</span>
<span id="cb33-241"><a href="#cb33-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-242"><a href="#cb33-242" aria-hidden="true" tabindex="-1"></a>The <span class="in">`%within%`</span> function allows you to determine whether a time value (stored in <span class="in">`R`</span> as a <span class="in">`POSIXct`</span> object) falls within a window of time. You can specify this window of time using the <span class="in">`interval()`</span> function. If you have only the start or the end time of the window of interest, you can add or subtract using supplemental functions like <span class="in">`days()`</span> or <span class="in">`hours()`</span>.</span>
<span id="cb33-243"><a href="#cb33-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-244"><a href="#cb33-244" aria-hidden="true" tabindex="-1"></a>For my COVID-19 research, the pulmonologists were often interested in snapshots of patients relative to a certain time in their disease course, for example, within the first 24 hours after intubation. The <span class="in">`lubridate`</span> functions made it super easy to extract the labs, vital signs, or other information that happened relative to another date.</span>
<span id="cb33-245"><a href="#cb33-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-246"><a href="#cb33-246" aria-hidden="true" tabindex="-1"></a>Here's how we could use the aforementioned functions in the <span class="in">`patient_labs`</span> dataset we made previously. We can extract all the labs relative to 24 hours after the hospital admission date.</span>
<span id="cb33-247"><a href="#cb33-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-250"><a href="#cb33-250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb33-251"><a href="#cb33-251" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb33-252"><a href="#cb33-252" aria-hidden="true" tabindex="-1"></a>patient_labs <span class="sc">%&gt;%</span></span>
<span id="cb33-253"><a href="#cb33-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lab_time <span class="sc">%within%</span> <span class="fu">interval</span>(admit_dt, admit_dt <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">1</span>)))</span>
<span id="cb33-254"><a href="#cb33-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-255"><a href="#cb33-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-256"><a href="#cb33-256" aria-hidden="true" tabindex="-1"></a>Perfect! I could go on to informatively join this data to another using <span class="in">`tidylog`</span>, make tables with clean labels using <span class="in">`tbl_summary()`</span>, <span class="in">`set_variable_labels()`</span>, and <span class="in">`to_title_case()`</span>, find further labs of interest with <span class="in">`filter()`</span>, <span class="in">`str_detect()`</span>, and <span class="in">`tolower()`</span>, and make the lab values numeric with <span class="in">`parse_number()`</span>... the possibilities are endless!</span>
<span id="cb33-257"><a href="#cb33-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-258"><a href="#cb33-258" aria-hidden="true" tabindex="-1"></a>I hope you enjoyed a quick insight into the data side of COVID-19 research, and/or perhaps picked up some useful function combinations for your own applied work with <span class="in">`R`</span>.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>