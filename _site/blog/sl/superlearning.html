<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Katherine Hoffman">
<meta name="dcterms.date" content="2020-10-10">

<title>KHstats - Become a Superlearner! An Illustrated Guide to Superlearning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-136820093-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<style>html{ scroll-behavior: smooth; }</style>

  </head><body class="docked nav-fixed">true





<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">KHstats</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks.html">
 <span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-illustrations" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Illustrations</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-illustrations">    
        <li>
    <a class="dropdown-item" href="../../art/illustrations_viz.html">
 <span class="dropdown-text">Visual Guides for Causal Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../art/illustrations_draw.html">
 <span class="dropdown-text">Educational Drawings and Comics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-research" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Research</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-research">    
        <li>
    <a class="dropdown-item" href="../../pubs/pubs_methods.html">
 <span class="dropdown-text">Statistics Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubs/pubs_applications.html">
 <span class="dropdown-text">Clinical Applications</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://scholar.google.com/citations?user=73RvTUoAAAAJ&amp;hl=en">
 <span class="dropdown-text">Google Scholar Profile</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/kat_hoffman_"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kathoffman"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../static/KatherineHoffman_CV_Dec2022.pdf">
 <span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:kathoffman.stats@gmail.com"><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Become a Superlearner! An Illustrated Guide to Superlearning</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Katherine Hoffman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 10, 2020</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#supercuts-of-superlearning" id="toc-supercuts-of-superlearning" class="nav-link active" data-scroll-target="#supercuts-of-superlearning">Supercuts of superlearning</a></li>
  <li><a href="#superlearning-step-by-step" id="toc-superlearning-step-by-step" class="nav-link" data-scroll-target="#superlearning-step-by-step">Superlearning, step by step</a>
  <ul class="collapse">
  <li><a href="#initial-set-up-load-libraries-set-seed-simulate-data" id="toc-initial-set-up-load-libraries-set-seed-simulate-data" class="nav-link" data-scroll-target="#initial-set-up-load-libraries-set-seed-simulate-data">Initial set-up: Load libraries, set seed, simulate data</a></li>
  </ul></li>
  <li><a href="#using-the-superlearner-package" id="toc-using-the-superlearner-package" class="nav-link" data-scroll-target="#using-the-superlearner-package">Using the <code>SuperLearner</code> package</a>
  <ul class="collapse">
  <li><a href="#cv-risk-and-coefficient-weights" id="toc-cv-risk-and-coefficient-weights" class="nav-link" data-scroll-target="#cv-risk-and-coefficient-weights">CV-Risk and Coefficient Weights</a></li>
  <li><a href="#obtaining-the-predictions" id="toc-obtaining-the-predictions" class="nav-link" data-scroll-target="#obtaining-the-predictions">Obtaining the predictions</a></li>
  <li><a href="#cross-validated-superlearner" id="toc-cross-validated-superlearner" class="nav-link" data-scroll-target="#cross-validated-superlearner">Cross-validated Superlearner</a></li>
  <li><a href="#alternative-packages-to-superlearn" id="toc-alternative-packages-to-superlearn" class="nav-link" data-scroll-target="#alternative-packages-to-superlearn">Alternative packages to superlearn</a></li>
  </ul></li>
  <li><a href="#coming-soon-when-prediction-is-not-the-end-goal" id="toc-coming-soon-when-prediction-is-not-the-end-goal" class="nav-link" data-scroll-target="#coming-soon-when-prediction-is-not-the-end-goal">Coming soon… when prediction is not the end goal</a></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a>
  <ul class="collapse">
  <li><a href="#manually-computing-the-mse" id="toc-manually-computing-the-mse" class="nav-link" data-scroll-target="#manually-computing-the-mse">Manually computing the MSE</a></li>
  <li><a href="#discrete-superlearner" id="toc-discrete-superlearner" class="nav-link" data-scroll-target="#discrete-superlearner">Discrete Superlearner</a></li>
  <li><a href="#choosing-a-metalearner" id="toc-choosing-a-metalearner" class="nav-link" data-scroll-target="#choosing-a-metalearner">Choosing a metalearner</a></li>
  <li><a href="#another-visual-guide-for-superlearning" id="toc-another-visual-guide-for-superlearning" class="nav-link" data-scroll-target="#another-visual-guide-for-superlearning">Another visual guide for superlearning</a></li>
  </ul></li>
  <li><a href="#acknowledgments" id="toc-acknowledgments" class="nav-link" data-scroll-target="#acknowledgments">Acknowledgments</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Why use <em>one</em> machine learning algorithm when you could use all of them?! This post contains a step-by-step walkthrough of how to build a superlearner prediction algorithm in <code>R</code>.</p>
<!--more-->
<p><strong>October 10, 2020.</strong></p>


<title>
HTML Image as link
</title>


<img alt="cheatsheet" src="../../img/sl_steps/Superlearning.jpg" width="100%&quot;">
<figcaption>
<strong><em>A Visual Guide…</em></strong> Over the winter, I read <a href="https://www.springer.com/gp/book/9781441997814"><em>Targeted Learning</em></a> by Mark van der Laan and Sherri Rose. This “visual guide” I made for <em>Chapter 3: Superlearning</em> by Rose, van der Laan, and Eric Polley is a condensed version of the following tutorial. It is available as an <a href="https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/Superlearner.pdf">8.5x11” pdf on Github</a>, should you wish to print it out for reference (or desk decor).
</figcaption>



<p><br></p>
<section id="supercuts-of-superlearning" class="level1">
<h1>Supercuts of superlearning</h1>
<ul>
<li><strong>Superlearning</strong> is a technique for prediction that involves <strong>combining many individual statistical algorithms</strong> (commonly called “data-adaptive” or “machine learning” algorithms) to <strong>create a new, single prediction algorithm</strong> that is expected to <strong>perform at least as well as any of the individual algorithms</strong>.</li>
<li>The superlearner algorithm “decides” how to combine, or weight, the individual algorithms based upon how well each one <strong>minimizes a specified loss function</strong>, for example, the mean squared error (MSE). This is done using cross-validation to avoid overfitting.</li>
<li>The motivation for this type of “ensembling” is that <strong>a mix of multiple algorithms may be more optimal for a given data set than any single algorithm</strong>. For example, a tree based model averaged with a linear model (e.g.&nbsp;random forests and LASSO) could smooth some of the model’s edges to improve predictive performance.</li>
<li>Superlearning is also called stacking, stacked generalizations, and weighted ensembling by different specializations within the realms of statistics and data science.</li>
</ul>
<p><img src="../../img/spiderman_meme.jpg" class="img-fluid" style="width:42.0%"></p>
</section>
<section id="superlearning-step-by-step" class="level1">
<h1>Superlearning, step by step</h1>
<p>First I’ll go through the algorithm one step at a time using a simulated data set.</p>
<section id="initial-set-up-load-libraries-set-seed-simulate-data" class="level2">
<h2 class="anchored" data-anchor-id="initial-set-up-load-libraries-set-seed-simulate-data">Initial set-up: Load libraries, set seed, simulate data</h2>
<p>For simplicity I’ll show the concept of superlearning using only four variables (AKA features or predictors) to predict a continuous outcome. Let’s first simulate a continuous outcome, <code>y</code>, and four potential predictors, <code>x1</code>, <code>x2</code>, <code>x3</code>, and <code>x4</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(n),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="dv">10</span><span class="sc">*</span>x1)),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(x1<span class="sc">*</span>x2 <span class="sc">+</span> .<span class="dv">5</span><span class="sc">*</span>x2)),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">x4 =</span> <span class="fu">rnorm</span>(n, <span class="at">mean=</span>x1<span class="sc">*</span>x2, <span class="at">sd=</span>.<span class="dv">5</span><span class="sc">*</span>x3),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x2<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">gt</span>(<span class="fu">head</span>(obs)) <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="st">"Simulated data set"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="fu">everything</span>(),<span class="at">decimals=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="epunggiefm" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

:where(#epunggiefm) .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

:where(#epunggiefm) .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#epunggiefm) .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

:where(#epunggiefm) .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

:where(#epunggiefm) .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#epunggiefm) .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#epunggiefm) .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

:where(#epunggiefm) .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

:where(#epunggiefm) .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

:where(#epunggiefm) .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

:where(#epunggiefm) .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

:where(#epunggiefm) .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

:where(#epunggiefm) .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

:where(#epunggiefm) .gt_from_md > :first-child {
  margin-top: 0;
}

:where(#epunggiefm) .gt_from_md > :last-child {
  margin-bottom: 0;
}

:where(#epunggiefm) .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

:where(#epunggiefm) .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#epunggiefm) .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

:where(#epunggiefm) .gt_row_group_first td {
  border-top-width: 2px;
}

:where(#epunggiefm) .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#epunggiefm) .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

:where(#epunggiefm) .gt_first_summary_row.thick {
  border-top-width: 2px;
}

:where(#epunggiefm) .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#epunggiefm) .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#epunggiefm) .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

:where(#epunggiefm) .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

:where(#epunggiefm) .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#epunggiefm) .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#epunggiefm) .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#epunggiefm) .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#epunggiefm) .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#epunggiefm) .gt_left {
  text-align: left;
}

:where(#epunggiefm) .gt_center {
  text-align: center;
}

:where(#epunggiefm) .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

:where(#epunggiefm) .gt_font_normal {
  font-weight: normal;
}

:where(#epunggiefm) .gt_font_bold {
  font-weight: bold;
}

:where(#epunggiefm) .gt_font_italic {
  font-style: italic;
}

:where(#epunggiefm) .gt_super {
  font-size: 65%;
}

:where(#epunggiefm) .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

:where(#epunggiefm) .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

:where(#epunggiefm) .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

:where(#epunggiefm) .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

:where(#epunggiefm) .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

:where(#epunggiefm) .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="6" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">Simulated data set</th>
    </tr>
    
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">x1</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">x2</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">x3</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">x4</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">y</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right">1.000</td>
<td class="gt_row gt_right">2.287</td>
<td class="gt_row gt_right">1.000</td>
<td class="gt_row gt_right">1.000</td>
<td class="gt_row gt_right">1.385</td>
<td class="gt_row gt_right">5.270</td></tr>
    <tr><td class="gt_row gt_right">2.000</td>
<td class="gt_row gt_right">−1.197</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">−1.197</td></tr>
    <tr><td class="gt_row gt_right">3.000</td>
<td class="gt_row gt_right">−0.694</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">−0.694</td></tr>
    <tr><td class="gt_row gt_right">4.000</td>
<td class="gt_row gt_right">−0.412</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">1.000</td>
<td class="gt_row gt_right">−0.541</td>
<td class="gt_row gt_right">−0.928</td></tr>
    <tr><td class="gt_row gt_right">5.000</td>
<td class="gt_row gt_right">−0.971</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">−0.971</td></tr>
    <tr><td class="gt_row gt_right">6.000</td>
<td class="gt_row gt_right">−0.947</td>
<td class="gt_row gt_right">0.000</td>
<td class="gt_row gt_right">1.000</td>
<td class="gt_row gt_right">−0.160</td>
<td class="gt_row gt_right">−1.107</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 1: Split data into K folds
</strong></h2><strong>
</strong>


<p><img src="../../img/sl_steps/step1.png" class="img-fluid" style="width:50.0%"> The superlearner algorithm relies on K-fold cross-validation (CV) to avoid overfitting. We will start this process by splitting the data into 10 folds. The easiest way to do this is by creating indices for each CV fold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># 10 fold cv</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>cv_index <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>k, <span class="at">each =</span> n<span class="sc">/</span>k)) <span class="co"># create indices for each CV fold. We need each fold K to contain n (all the rows of our data set) divided by k rows. in our example this is 5000/10 = 500 rows in each fold</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 2: Fit base learners for first CV-fold
</strong></h2><strong>
</strong>


<p><img src="../../img/sl_steps/step2.png" class="img-fluid" style="width:50.0%"></p>
<p>Recall that in K-fold CV, each fold serves as the validation set one time. In this first round of CV, we will train all of our base learners on all the CV folds (k = 1,2,…,9) <em>except</em> for the very last one: <code>cv_index == 10</code>.</p>
<p>The individual algorithms or <strong>base learners</strong> that we’ll use here are three linear regressions with differently specified parameters:</p>
<ol type="1">
<li><p><strong>Learner A</strong>: <span class="math inline">\(Y=\beta_0 + \beta_1 X_2 + \beta_2 X_4 + \epsilon\)</span></p></li>
<li><p><strong>Learner B</strong>: <span class="math inline">\(Y=\beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_1 X_3 + \beta_4 sin(X_4) + \epsilon\)</span></p></li>
<li><p><strong>Learner C</strong>: <span class="math inline">\(Y=\beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_3 + \beta_4 X_1 X_2 + \beta_5 X_1 X_3 + \beta_6 X_2 X_3 + \beta_7 X_1 X_2 X_3 + \epsilon\)</span></p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cv_train_1 <span class="ot">&lt;-</span> obs[<span class="sc">-</span><span class="fu">which</span>(cv_index <span class="sc">==</span> <span class="dv">10</span>),] <span class="co"># make a data set that contains all observations except those in k=1</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>fit_1a <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x2 <span class="sc">+</span> x4, <span class="at">data=</span>cv_train_1) <span class="co"># fit the first linear regression on that training data</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>fit_1b <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x1<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4), <span class="at">data=</span>cv_train_1) <span class="co"># second LR fit on the training data</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>fit_1c <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1<span class="sc">*</span>x2<span class="sc">*</span>x3, <span class="at">data=</span>cv_train_1) <span class="co"># and the third LR</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I am <em>only</em> using the linear regressions so that code for running more complicated regressions does not take away from understanding the general superlearning algorithm.</p>
<p>Superlearning actually works best if you use a diverse set, or <strong>superlearner library</strong>, of base learners. For example, instead of three linear regressions, we could use a least absolute shrinkage estimator (LASSO), random forest, and multivariate adaptive splines (MARS). Any parametric or non-parametric supervised machine learning algorithm can be included as a base learner.</p>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 3: Obtain predictions for first CV-fold
</strong></h2><strong>
</strong>


<p><img src="../../img/sl_steps/step3.png" class="img-fluid" style="width:50.0%"></p>
<p>We can then get use our validation data, <code>cv_index == 10</code>, to obtain our first set of cross-validated predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>cv_valid_1 <span class="ot">&lt;-</span> obs[<span class="fu">which</span>(cv_index <span class="sc">==</span> <span class="dv">10</span>),] <span class="co"># make a data set that only contains observations except in k=10</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>pred_1a <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1a, <span class="at">newdata =</span> cv_valid_1) <span class="co"># use that data set as the validation for all the models in the SL library</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>pred_1b <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1b, <span class="at">newdata =</span> cv_valid_1) </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>pred_1c <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1c, <span class="at">newdata =</span> cv_valid_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we have 5000 <code>obs</code>ervations, that gives us three vectors of length 500: a set of predictions for each of our Learners A, B, and C.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(pred_1a) <span class="co"># double check we only have n/k predictions ...we do :-)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 500</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">cbind</span>(pred_1a, pred_1b, pred_1c)) <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="fu">everything</span>(), <span class="at">decimals =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="st">"First CV round of predictions"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="uqioxzzkvs" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

:where(#uqioxzzkvs) .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

:where(#uqioxzzkvs) .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

:where(#uqioxzzkvs) .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

:where(#uqioxzzkvs) .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

:where(#uqioxzzkvs) .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

:where(#uqioxzzkvs) .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

:where(#uqioxzzkvs) .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

:where(#uqioxzzkvs) .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

:where(#uqioxzzkvs) .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

:where(#uqioxzzkvs) .gt_from_md > :first-child {
  margin-top: 0;
}

:where(#uqioxzzkvs) .gt_from_md > :last-child {
  margin-bottom: 0;
}

:where(#uqioxzzkvs) .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

:where(#uqioxzzkvs) .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uqioxzzkvs) .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

:where(#uqioxzzkvs) .gt_row_group_first td {
  border-top-width: 2px;
}

:where(#uqioxzzkvs) .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uqioxzzkvs) .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_first_summary_row.thick {
  border-top-width: 2px;
}

:where(#uqioxzzkvs) .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uqioxzzkvs) .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

:where(#uqioxzzkvs) .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uqioxzzkvs) .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#uqioxzzkvs) .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#uqioxzzkvs) .gt_left {
  text-align: left;
}

:where(#uqioxzzkvs) .gt_center {
  text-align: center;
}

:where(#uqioxzzkvs) .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

:where(#uqioxzzkvs) .gt_font_normal {
  font-weight: normal;
}

:where(#uqioxzzkvs) .gt_font_bold {
  font-weight: bold;
}

:where(#uqioxzzkvs) .gt_font_italic {
  font-style: italic;
}

:where(#uqioxzzkvs) .gt_super {
  font-size: 65%;
}

:where(#uqioxzzkvs) .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

:where(#uqioxzzkvs) .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

:where(#uqioxzzkvs) .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

:where(#uqioxzzkvs) .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

:where(#uqioxzzkvs) .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

:where(#uqioxzzkvs) .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="3" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">First CV round of predictions</th>
    </tr>
    
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">pred_1a</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">pred_1b</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">pred_1c</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right">−0.77</td>
<td class="gt_row gt_right">−0.81</td>
<td class="gt_row gt_right">−0.69</td></tr>
    <tr><td class="gt_row gt_right">2.54</td>
<td class="gt_row gt_right">1.89</td>
<td class="gt_row gt_right">1.63</td></tr>
    <tr><td class="gt_row gt_right">0.19</td>
<td class="gt_row gt_right">0.60</td>
<td class="gt_row gt_right">−0.32</td></tr>
    <tr><td class="gt_row gt_right">2.46</td>
<td class="gt_row gt_right">2.69</td>
<td class="gt_row gt_right">2.98</td></tr>
    <tr><td class="gt_row gt_right">3.63</td>
<td class="gt_row gt_right">4.04</td>
<td class="gt_row gt_right">3.73</td></tr>
    <tr><td class="gt_row gt_right">3.59</td>
<td class="gt_row gt_right">3.23</td>
<td class="gt_row gt_right">3.15</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 4: Obtain CV predictions for entire data set
</strong></h2><strong>
</strong>


<p><img src="../../img/sl_steps/step4.png" class="img-fluid" style="width:32.0%"></p>
<p>We’ll want to get those predictions for <em>every</em> fold. So, using your favorite <code>for</code> loop, <code>apply</code> statement, or <code>map</code>ping function, fit the base learners and obtain predictions for each of them, so that there are 1000 predictions – one for every point in <code>obs</code>ervations.</p>
<p>The way I chose to code this was to make a generic function that combines Step 2 (base learners fit to the training data) and Step 3 (predictions on the validation data), then use <code>map_dfr()</code> from the <code>purrr</code> package to repeat over all 10 CV folds. I saved the results in a new data frame called <code>cv_preds</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>cv_folds <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="dv">1</span><span class="sc">:</span>k)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cv_folds) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"fold"</span>,<span class="dv">1</span><span class="sc">:</span>k)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>get_preds <span class="ot">&lt;-</span> <span class="cf">function</span>(fold){   <span class="co"># function that does the same procedure as step 2 and 3 for any CV fold</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  cv_train <span class="ot">&lt;-</span> obs[<span class="sc">-</span><span class="fu">which</span>(cv_index <span class="sc">==</span> fold),]  <span class="co"># make a training data set that contains all data except fold k</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  fit_a <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x2 <span class="sc">+</span> x4, <span class="at">data=</span>cv_train)  <span class="co"># fit all the base learners to that data</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  fit_b <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x1<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4), <span class="at">data=</span>cv_train)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  fit_c <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1<span class="sc">*</span>x2<span class="sc">*</span>x3, <span class="at">data=</span>cv_train)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  cv_valid <span class="ot">&lt;-</span> obs[<span class="fu">which</span>(cv_index <span class="sc">==</span> fold),]  <span class="co"># make a validation data set that only contains data from fold k</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  pred_a <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_a, <span class="at">newdata =</span> cv_valid)  <span class="co"># obtain predictions from all the base learners for that validation data</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  pred_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_b, <span class="at">newdata =</span> cv_valid)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  pred_c <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_c, <span class="at">newdata =</span> cv_valid)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="st">"obs_id"</span> <span class="ot">=</span> cv_valid<span class="sc">$</span>id, <span class="st">"cv_fold"</span> <span class="ot">=</span> fold, pred_a, pred_b, pred_c))  <span class="co"># save the predictions and the ids of the observations in a data frame</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>cv_preds <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dfr</span>(cv_folds, <span class="sc">~</span><span class="fu">get_preds</span>(<span class="at">fold =</span> .x)) <span class="co"># map_dfr loops through every fold (1:k) and binds the rows of the listed results together</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>cv_preds <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(obs_id) <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(cv_fold<span class="sc">:</span>pred_c, <span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="st">"All CV predictions for all three base learners"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="wxklwgczbv" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

:where(#wxklwgczbv) .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

:where(#wxklwgczbv) .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

:where(#wxklwgczbv) .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

:where(#wxklwgczbv) .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

:where(#wxklwgczbv) .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

:where(#wxklwgczbv) .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

:where(#wxklwgczbv) .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

:where(#wxklwgczbv) .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

:where(#wxklwgczbv) .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

:where(#wxklwgczbv) .gt_from_md > :first-child {
  margin-top: 0;
}

:where(#wxklwgczbv) .gt_from_md > :last-child {
  margin-bottom: 0;
}

:where(#wxklwgczbv) .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

:where(#wxklwgczbv) .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#wxklwgczbv) .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

:where(#wxklwgczbv) .gt_row_group_first td {
  border-top-width: 2px;
}

:where(#wxklwgczbv) .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#wxklwgczbv) .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_first_summary_row.thick {
  border-top-width: 2px;
}

:where(#wxklwgczbv) .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#wxklwgczbv) .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

:where(#wxklwgczbv) .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#wxklwgczbv) .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#wxklwgczbv) .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#wxklwgczbv) .gt_left {
  text-align: left;
}

:where(#wxklwgczbv) .gt_center {
  text-align: center;
}

:where(#wxklwgczbv) .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

:where(#wxklwgczbv) .gt_font_normal {
  font-weight: normal;
}

:where(#wxklwgczbv) .gt_font_bold {
  font-weight: bold;
}

:where(#wxklwgczbv) .gt_font_italic {
  font-style: italic;
}

:where(#wxklwgczbv) .gt_super {
  font-size: 65%;
}

:where(#wxklwgczbv) .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

:where(#wxklwgczbv) .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

:where(#wxklwgczbv) .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

:where(#wxklwgczbv) .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

:where(#wxklwgczbv) .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

:where(#wxklwgczbv) .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="5" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">All CV predictions for all three base learners</th>
    </tr>
    
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">obs_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">cv_fold</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">pred_a</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">pred_b</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">pred_c</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right">1</td>
<td class="gt_row gt_right">7.00</td>
<td class="gt_row gt_right">3.74</td>
<td class="gt_row gt_right">5.42</td>
<td class="gt_row gt_right">5.28</td></tr>
    <tr><td class="gt_row gt_right">2</td>
<td class="gt_row gt_right">6.00</td>
<td class="gt_row gt_right">−0.77</td>
<td class="gt_row gt_right">−1.19</td>
<td class="gt_row gt_right">−1.20</td></tr>
    <tr><td class="gt_row gt_right">3</td>
<td class="gt_row gt_right">10.00</td>
<td class="gt_row gt_right">−0.77</td>
<td class="gt_row gt_right">−0.81</td>
<td class="gt_row gt_right">−0.69</td></tr>
    <tr><td class="gt_row gt_right">4</td>
<td class="gt_row gt_right">8.00</td>
<td class="gt_row gt_right">−1.39</td>
<td class="gt_row gt_right">−0.77</td>
<td class="gt_row gt_right">−0.41</td></tr>
    <tr><td class="gt_row gt_right">5</td>
<td class="gt_row gt_right">2.00</td>
<td class="gt_row gt_right">−0.78</td>
<td class="gt_row gt_right">−1.02</td>
<td class="gt_row gt_right">−0.97</td></tr>
    <tr><td class="gt_row gt_right">6</td>
<td class="gt_row gt_right">9.00</td>
<td class="gt_row gt_right">−0.96</td>
<td class="gt_row gt_right">−1.04</td>
<td class="gt_row gt_right">−0.94</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 5: Choose and compute loss function of interest via metalearner
</strong></h2><strong>
</strong>


<p><img src="../../img/sl_steps/step5.png" class="img-fluid" style="width:60.0%"></p>
<blockquote class="blockquote">
<p>This is the key step of the superlearner algorithm: we will use a new learner, a <strong>metalearner</strong>, to take information from all of the base learners and create that new algorithm.</p>
</blockquote>
<p>Now that we have cross-validated predictions for every observation in the data set, we want to merge those CV predictions back into our main data set…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>obs_preds <span class="ot">&lt;-</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(obs, cv_preds, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"obs_id"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…so that we can minimize a final loss function of interest between the true outcome and each CV prediction. This is how we’re going to optimize our overall prediction algorithm: we want to make sure we’re “losing the least” in the way we combine our base learners’ predictions to ultimately make final predictions. We can do this efficiently by choosing a new learner, a metalearner, which reflects the final loss function of interest.</p>
<p>For simplicity, we’ll use another linear regression as our metalearner. Using a linear regression as a metalearner will minimize the Cross-Validated Mean Squared Error (CV-MSE) when combining the base learner predictions. Note that we could use a variety of parametric or non-parametric regressions to minimize the CV-MSE.</p>
<p>No matter what metalearner we choose, the predictors will always be the cross-validated predictions from each base learner, and the outcome will always be the true outcome, <code>y</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sl_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> pred_a <span class="sc">+</span> pred_b <span class="sc">+</span> pred_c, <span class="at">data =</span> obs_preds)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(sl_fit) <span class="sc">%&gt;%</span> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(estimate<span class="sc">:</span>p.value, <span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="st">"Metalearner regression coefficients"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="lofpihbenx" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

:where(#lofpihbenx) .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

:where(#lofpihbenx) .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

:where(#lofpihbenx) .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

:where(#lofpihbenx) .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

:where(#lofpihbenx) .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

:where(#lofpihbenx) .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

:where(#lofpihbenx) .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

:where(#lofpihbenx) .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

:where(#lofpihbenx) .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

:where(#lofpihbenx) .gt_from_md > :first-child {
  margin-top: 0;
}

:where(#lofpihbenx) .gt_from_md > :last-child {
  margin-bottom: 0;
}

:where(#lofpihbenx) .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

:where(#lofpihbenx) .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#lofpihbenx) .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

:where(#lofpihbenx) .gt_row_group_first td {
  border-top-width: 2px;
}

:where(#lofpihbenx) .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#lofpihbenx) .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_first_summary_row.thick {
  border-top-width: 2px;
}

:where(#lofpihbenx) .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#lofpihbenx) .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

:where(#lofpihbenx) .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#lofpihbenx) .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#lofpihbenx) .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#lofpihbenx) .gt_left {
  text-align: left;
}

:where(#lofpihbenx) .gt_center {
  text-align: center;
}

:where(#lofpihbenx) .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

:where(#lofpihbenx) .gt_font_normal {
  font-weight: normal;
}

:where(#lofpihbenx) .gt_font_bold {
  font-weight: bold;
}

:where(#lofpihbenx) .gt_font_italic {
  font-style: italic;
}

:where(#lofpihbenx) .gt_super {
  font-size: 65%;
}

:where(#lofpihbenx) .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

:where(#lofpihbenx) .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

:where(#lofpihbenx) .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

:where(#lofpihbenx) .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

:where(#lofpihbenx) .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

:where(#lofpihbenx) .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="5" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">Metalearner regression coefficients</th>
    </tr>
    
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">std.error</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">statistic</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">p.value</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_left">(Intercept)</td>
<td class="gt_row gt_right">0.00</td>
<td class="gt_row gt_right">0.00</td>
<td class="gt_row gt_right">−1.42</td>
<td class="gt_row gt_right">0.16</td></tr>
    <tr><td class="gt_row gt_left">pred_a</td>
<td class="gt_row gt_right">−0.02</td>
<td class="gt_row gt_right">0.00</td>
<td class="gt_row gt_right">−4.75</td>
<td class="gt_row gt_right">0.00</td></tr>
    <tr><td class="gt_row gt_left">pred_b</td>
<td class="gt_row gt_right">0.85</td>
<td class="gt_row gt_right">0.01</td>
<td class="gt_row gt_right">128.15</td>
<td class="gt_row gt_right">0.00</td></tr>
    <tr><td class="gt_row gt_left">pred_c</td>
<td class="gt_row gt_right">0.17</td>
<td class="gt_row gt_right">0.01</td>
<td class="gt_row gt_right">30.07</td>
<td class="gt_row gt_right">0.00</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>This metalearner provides us with the coefficients, or weights, to apply to each of the base learners. In other words, if we have a set of predictions from Learner A, B, and C, we can obtain our best possible predictions by starting with an intercept of -0.003, then adding -0.017 <span class="math inline">\(\times\)</span> predictions from Learner A, 0.854 <span class="math inline">\(\times\)</span> predictions from Learner B, and 0.165 <span class="math inline">\(\times\)</span> predictions from Learner C.</p>
<p><em>For more information on the metalearning step, check out the <a href="#appendix">Appendix</a>.</em></p>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 6: Fit base learners on entire data set
</strong></h2><strong>
</strong>


<p><img src="../../img/sl_steps/step6.png" class="img-fluid" style="width:50.0%"></p>
<p>After we fit the metalearner, we officially have our superlearner algorithm, so it’s time to input data and obtain predictions! To implement the algorithm and obtain final predictions, we first need to fit the base learners on the full data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fit_a <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x2 <span class="sc">+</span> x4, <span class="at">data=</span>obs)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>fit_b <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x1<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4), <span class="at">data=</span>obs)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>fit_c <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1<span class="sc">*</span>x2<span class="sc">*</span>x3, <span class="at">data=</span>obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 7: Obtain predictions from each base learner on entire data set
</strong></h2><strong>
</strong>


<p><img src="../../img/sl_steps/step7.png" class="img-fluid" style="width:40.0%"></p>
<p>We’ll use <em>those</em> base learner fits to get predictions from each of the base learners for the entire data set, and then we will plug those predictions into the metalearner fit. Remember, we were previously using cross-validated predictions, rather than fitting the base learners on the whole data set. This was to avoid overfitting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pred_a <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_a)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>pred_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_b)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>pred_c <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_c)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>full_data_preds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(pred_a, pred_b, pred_c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 8: Use metalearner fit to weight base learners
</strong></h2><strong>
</strong>


<p><img src="../../img/sl_steps/step8.png" class="img-fluid" style="width:60.0%"></p>
<p>Once we have the predictions from the full data set, we can input them to the metalearner, where the output will be a final prediction for <code>y</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>sl_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(sl_fit, <span class="at">newdata =</span> full_data_preds)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">sl_predictions =</span> <span class="fu">head</span>(sl_predictions)) <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> <span class="fu">fmt_number</span>(sl_predictions, <span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tab_header</span>(<span class="st">"Final SL predictions (manual)"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="cxoiligfyd" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

:where(#cxoiligfyd) .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

:where(#cxoiligfyd) .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

:where(#cxoiligfyd) .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

:where(#cxoiligfyd) .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

:where(#cxoiligfyd) .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

:where(#cxoiligfyd) .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

:where(#cxoiligfyd) .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

:where(#cxoiligfyd) .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

:where(#cxoiligfyd) .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

:where(#cxoiligfyd) .gt_from_md > :first-child {
  margin-top: 0;
}

:where(#cxoiligfyd) .gt_from_md > :last-child {
  margin-bottom: 0;
}

:where(#cxoiligfyd) .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

:where(#cxoiligfyd) .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#cxoiligfyd) .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

:where(#cxoiligfyd) .gt_row_group_first td {
  border-top-width: 2px;
}

:where(#cxoiligfyd) .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#cxoiligfyd) .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_first_summary_row.thick {
  border-top-width: 2px;
}

:where(#cxoiligfyd) .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#cxoiligfyd) .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

:where(#cxoiligfyd) .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#cxoiligfyd) .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#cxoiligfyd) .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#cxoiligfyd) .gt_left {
  text-align: left;
}

:where(#cxoiligfyd) .gt_center {
  text-align: center;
}

:where(#cxoiligfyd) .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

:where(#cxoiligfyd) .gt_font_normal {
  font-weight: normal;
}

:where(#cxoiligfyd) .gt_font_bold {
  font-weight: bold;
}

:where(#cxoiligfyd) .gt_font_italic {
  font-style: italic;
}

:where(#cxoiligfyd) .gt_super {
  font-size: 65%;
}

:where(#cxoiligfyd) .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

:where(#cxoiligfyd) .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

:where(#cxoiligfyd) .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

:where(#cxoiligfyd) .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

:where(#cxoiligfyd) .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

:where(#cxoiligfyd) .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="1" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">Final SL predictions (manual)</th>
    </tr>
    
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">sl_predictions</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right">5.44</td></tr>
    <tr><td class="gt_row gt_right">−1.20</td></tr>
    <tr><td class="gt_row gt_right">−0.79</td></tr>
    <tr><td class="gt_row gt_right">−0.71</td></tr>
    <tr><td class="gt_row gt_right">−1.02</td></tr>
    <tr><td class="gt_row gt_right">−1.03</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>And… that’s it! Those are our superlearner predictions for the full data set.</p>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 9: Obtain predictions on new data
</strong></h2><strong>
</strong>


<p>We can now modify Step 7 and Step 8 to accommodate any new observation(s):</p>
<blockquote class="blockquote">
<p><strong>To predict on new data:</strong><br>&nbsp;1. Use the fits from each base learner to obtain base learner predictions for the new observation(s).<br>&nbsp;2. Plug those base learner predictions into the metalearner fit.</p>
</blockquote>
<p>We can generate a single <code>new_obs</code>ervation to see how this would work in practice.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>new_obs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x1 =</span> .<span class="dv">5</span>, <span class="at">x2 =</span> <span class="dv">0</span>, <span class="at">x3 =</span> <span class="dv">0</span>, <span class="at">x4 =</span> <span class="sc">-</span><span class="dv">3</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>new_pred_a <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_a, new_obs)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>new_pred_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_b, new_obs)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>new_pred_c <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_c, new_obs)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>new_pred_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">"pred_a"</span> <span class="ot">=</span> new_pred_a, <span class="st">"pred_b"</span> <span class="ot">=</span> new_pred_b, <span class="st">"pred_c"</span> <span class="ot">=</span> new_pred_c)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(sl_fit, <span class="at">newdata =</span> new_pred_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1 
0.1183103 </code></pre>
</div>
</div>
<p>Our superlearner model predicts that an observation with predictors <span class="math inline">\(X_1=.5\)</span>, <span class="math inline">\(X_2=0\)</span>, <span class="math inline">\(X_3=0\)</span>, and <span class="math inline">\(X_4=-3\)</span> will have an outcome of <span class="math inline">\(Y=0.118\)</span>.</p>


<h2 style="color:#c30a0a" class="anchored">
<strong>Step 10 and beyond…
</strong></h2><strong>
</strong>


<p>We could compute the MSE of the ensemble superlearner predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>sl_mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((obs<span class="sc">$</span>y <span class="sc">-</span> sl_predictions)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>sl_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01927392</code></pre>
</div>
</div>
<p>We could also add more algorithms to our base learner library (we definitely should, since we only used linear regressions!), and we could write functions to tune these algorithms’ hyperparameters over various grids. For example, if we were to include random forest in our library, we may want to tune over a number of trees and maximum bucket sizes.</p>
<p>We can then cross-validate this entire process to evaluate the predictive performance of our superlearner algorithm. Alternatively, we could leave a hold-out training data set to evaluate the performance.</p>
</section>
</section>
<section id="using-the-superlearner-package" class="level1">
<h1>Using the <code>SuperLearner</code> package</h1>
<p>Or… we could use a package and avoid all the hand-coding. Here is how you would build an ensemble superlearner for our data with the base learner libraries of <code>ranger</code> (random forests), <code>glmnet</code> (LASSO, by default), and <code>earth</code> (MARS) using the <code>SuperLearner</code> package in <code>R</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>x_df <span class="ot">&lt;-</span> obs <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1<span class="sc">:</span>x4) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>sl_fit <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> obs<span class="sc">$</span>y, <span class="at">X =</span> x_df, <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.ranger"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.earth"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can specify the metalearner with the <code>method</code> argument. The default is <a href="##non-negative-least-squares">Non-Negative Least Squares</a> (NNLS).</p>
<section id="cv-risk-and-coefficient-weights" class="level2">
<h2 class="anchored" data-anchor-id="cv-risk-and-coefficient-weights">CV-Risk and Coefficient Weights</h2>
<p>We can examine the cross-validated <code>Risk</code> (loss function), and the <code>Coef</code>ficient (weight) given to each of the models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>sl_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
SuperLearner(Y = obs$y, X = x_df, family = gaussian(), SL.library = c("SL.ranger",  
    "SL.glmnet", "SL.earth")) 

                     Risk      Coef
SL.ranger_All 0.013672503 0.1606329
SL.glmnet_All 0.097257031 0.0000000
SL.earth_All  0.003181357 0.8393671</code></pre>
</div>
</div>
<p>From this summary we can see that the CV-risk (the default risk is MSE) in this library of base learners is smallest for <code>SL.Earth</code>. This translates to the largest coefficient, or weight, given to the predictions from <code>earth</code>.</p>
<p>The LASSO model implemented by <code>glmnet</code> has the largest CV-risk, and after the metalearning step, those predictions receive a coefficient, or weight, of 0. This means that the predictions from LASSO will not be incorporated into the final predictions at all.</p>
</section>
<section id="obtaining-the-predictions" class="level2">
<h2 class="anchored" data-anchor-id="obtaining-the-predictions">Obtaining the predictions</h2>
<p>We can extract the predictions easily via the <code>SL.predict</code> element of the <code>SuperLearner</code> fit object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">sl_predictions =</span> sl_fit<span class="sc">$</span>SL.predict)) <span class="sc">%&gt;%</span> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="fu">everything</span>(),<span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">tab_header</span>(<span class="st">"Final SL predictions (package)"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="exzlacqdmx" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

:where(#exzlacqdmx) .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

:where(#exzlacqdmx) .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

:where(#exzlacqdmx) .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

:where(#exzlacqdmx) .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

:where(#exzlacqdmx) .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

:where(#exzlacqdmx) .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

:where(#exzlacqdmx) .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

:where(#exzlacqdmx) .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

:where(#exzlacqdmx) .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

:where(#exzlacqdmx) .gt_from_md > :first-child {
  margin-top: 0;
}

:where(#exzlacqdmx) .gt_from_md > :last-child {
  margin-bottom: 0;
}

:where(#exzlacqdmx) .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

:where(#exzlacqdmx) .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#exzlacqdmx) .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

:where(#exzlacqdmx) .gt_row_group_first td {
  border-top-width: 2px;
}

:where(#exzlacqdmx) .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#exzlacqdmx) .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_first_summary_row.thick {
  border-top-width: 2px;
}

:where(#exzlacqdmx) .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#exzlacqdmx) .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

:where(#exzlacqdmx) .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#exzlacqdmx) .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#exzlacqdmx) .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#exzlacqdmx) .gt_left {
  text-align: left;
}

:where(#exzlacqdmx) .gt_center {
  text-align: center;
}

:where(#exzlacqdmx) .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

:where(#exzlacqdmx) .gt_font_normal {
  font-weight: normal;
}

:where(#exzlacqdmx) .gt_font_bold {
  font-weight: bold;
}

:where(#exzlacqdmx) .gt_font_italic {
  font-style: italic;
}

:where(#exzlacqdmx) .gt_super {
  font-size: 65%;
}

:where(#exzlacqdmx) .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

:where(#exzlacqdmx) .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

:where(#exzlacqdmx) .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

:where(#exzlacqdmx) .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

:where(#exzlacqdmx) .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

:where(#exzlacqdmx) .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="1" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">Final SL predictions (package)</th>
    </tr>
    
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">sl_predictions</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right">5.28</td></tr>
    <tr><td class="gt_row gt_right">−1.19</td></tr>
    <tr><td class="gt_row gt_right">−0.68</td></tr>
    <tr><td class="gt_row gt_right">−0.87</td></tr>
    <tr><td class="gt_row gt_right">−0.97</td></tr>
    <tr><td class="gt_row gt_right">−1.08</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</section>
<section id="cross-validated-superlearner" class="level2">
<h2 class="anchored" data-anchor-id="cross-validated-superlearner">Cross-validated Superlearner</h2>
<p>Recall that we can cross-validate the entire model fitting process to evaluate the predictive performance of our superlearner algorithm. This is easy with the function <code>CV.SuperLearner()</code>. Beware, this gets computationally burdensome very quickly!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cv_sl_fit <span class="ot">&lt;-</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> obs<span class="sc">$</span>y, <span class="at">X =</span> x_df, <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.ranger"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.earth"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For more information on the <code>SuperLearner</code> package, take a look at this <a href="https://cran.r-project.org/web/packages/SuperLearner/vignettes/Guide-to-SuperLearner.html">vignette</a>.</p>
</section>
<section id="alternative-packages-to-superlearn" class="level2">
<h2 class="anchored" data-anchor-id="alternative-packages-to-superlearn">Alternative packages to superlearn</h2>
<p>Other packages freely available in <code>R</code> that can be used to implement the superlearner algorithm include <a href="https://tlverse.org/tlverse-handbook/sl3.html"><code>sl3</code></a> (an update to the original <code>Superlearner</code> package), <a href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/stacked-ensembles.html"><code>h2o</code></a>, and <a href="https://rdrr.io/cran/caretEnsemble/f/vignettes/caretEnsemble-intro.Rmd"><code>caretEnsemble</code></a>. I previously wrote a <a href="https://www.khstats.com/blog/sl3_demo/sl/">brief demo</a> on using <code>sl3</code> for an NYC R-Ladies demo.</p>
<p>The authors of <code>tidymodels</code> – a suite of packages for machine learning including <code>recipes</code>, <code>parsnip</code>, and <code>rsample</code> – recently came out with a new package to perform superlearning/stacking called <a href="[https://stacks.tidymodels.org/articles/basics.html"><code>stacks</code></a>. Prior to this, Alex Hayes wrote a <a href="https://www.alexpghayes.com/blog/implementing-the-super-learner-with-tidymodels/">blog post</a> on using <code>tidymodels</code> infrastructure to implement superlearning.</p>
</section>
</section>
<section id="coming-soon-when-prediction-is-not-the-end-goal" class="level1">
<h1>Coming soon… when prediction is not the end goal</h1>
<p>When prediction is not the end goal, superlearning combines well with semi-parametric estimation methods for statistical inference. This is the reason I was reading <em>Targeted Learning</em> in the first place; I am a statistician with collaborators who typically want estimates of treatment effects with confidence intervals, not predictions!</p>
<p>I’m working on a similar visual guide for one such semiparametric estimation method: <a href="https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/TMLE.pdf">Targeted Maximum Likelihood Estimation</a> (TMLE)). TMLE allows the use of flexible statistical models like the superlearner algorithm when estimating treatment effects. If you found this superlearning tutorial helpful, you may be interested in this <a href="https://www.khstats.com/blog/tmle/tutorial/">similarly visual tutorial</a> on TMLE.</p>


<title>
HTML Image as link
</title>


<a href="https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/TMLE.pdf"> <img alt="cheatsheet" src="../../img/TMLE.jpg" width="100%&quot;"> </a>


</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<p>These sections contain a bit of extra information on the superlearning algorithm, such as: intuition on manually computing the loss function of interest, explanation of the discrete superlearner, brief advice on choosing a metalearner, and a different summary visual provided in the <em>Targeted Learning</em> book.</p>
<section id="manually-computing-the-mse" class="level3">
<h3 class="anchored" data-anchor-id="manually-computing-the-mse">Manually computing the MSE</h3>
<p>Let’s say we have chosen our loss function of interest to be the Mean Squared Error (MSE). We could first compute the squared error <span class="math inline">\((y - \hat{y})^2\)</span> for each CV prediction A, B, and C.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>cv_sq_error <span class="ot">&lt;-</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  obs_preds <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cv_sqrd_error_a =</span> (y<span class="sc">-</span>pred_a)<span class="sc">^</span><span class="dv">2</span>,   <span class="co"># compute squared error for each observation</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">cv_sqrd_error_b =</span> (y<span class="sc">-</span>pred_b)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">cv_sqrd_error_c =</span> (y<span class="sc">-</span>pred_c)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>cv_sq_error <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(cv_sqrd_error_a, cv_sqrd_error_b, cv_sqrd_error_c), <span class="co"># make the CV squared errors long form for plotting</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"base_learner"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"squared_error"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">base_learner =</span> <span class="fu">toupper</span>(<span class="fu">str_remove</span>(base_learner, <span class="st">"cv_sqrd_error_"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(base_learner, squared_error, <span class="at">col=</span>base_learner)) <span class="sc">+</span> <span class="co"># make box plots</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">col=</span>F) <span class="sc">+</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Base Learner"</span>, <span class="at">y=</span><span class="st">"Squared Error"</span>, <span class="at">title=</span><span class="st">"Squared Errors of Learner A, B, and C"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =
"none")` instead.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="superlearning_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="528"></p>
</div>
</div>
<p>And then take the mean of those three cross-validated squared error columns, grouped by <code>cv_fold</code>, to get the CV-MSE for each fold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>cv_risks <span class="ot">&lt;-</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  cv_sq_error <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cv_fold) <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">cv_mse_a =</span> <span class="fu">mean</span>(cv_sqrd_error_a),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">cv_mse_b =</span> <span class="fu">mean</span>(cv_sqrd_error_b),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">cv_mse_c =</span> <span class="fu">mean</span>(cv_sqrd_error_c)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>cv_risks <span class="sc">%&gt;%</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(cv_mse_a<span class="sc">:</span>cv_mse_c,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"base_learner"</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"mse"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">base_learner =</span> <span class="fu">toupper</span>(<span class="fu">str_remove</span>(base_learner,<span class="st">"cv_mse_"</span>)))  <span class="sc">%&gt;%</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(cv_fold, mse, <span class="at">col=</span>base_learner)) <span class="sc">+</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()  <span class="sc">+</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Cross-Validation (CV) Fold"</span>, <span class="at">y=</span><span class="st">"Mean Squared Error (MSE)"</span>, <span class="at">col =</span> <span class="st">"Base Learner"</span>, <span class="at">title=</span><span class="st">"CV-MSEs for Base Learners A, B, and C"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="superlearning_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that across each fold, Learner B consistently has an MSE around 0.02, while Learner C hovers around 0.1, and Learner A varies between 0.35 and 0.45. We can take another mean to get the overall CV-MSE for each learner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cv_risks <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>cv_fold) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(mean) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="fu">everything</span>(), <span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">tab_header</span>(<span class="st">"CV-MSE for each base learner"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="zzlxyntbys" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

:where(#zzlxyntbys) .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

:where(#zzlxyntbys) .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

:where(#zzlxyntbys) .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

:where(#zzlxyntbys) .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

:where(#zzlxyntbys) .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

:where(#zzlxyntbys) .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

:where(#zzlxyntbys) .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

:where(#zzlxyntbys) .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

:where(#zzlxyntbys) .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

:where(#zzlxyntbys) .gt_from_md > :first-child {
  margin-top: 0;
}

:where(#zzlxyntbys) .gt_from_md > :last-child {
  margin-bottom: 0;
}

:where(#zzlxyntbys) .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

:where(#zzlxyntbys) .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#zzlxyntbys) .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

:where(#zzlxyntbys) .gt_row_group_first td {
  border-top-width: 2px;
}

:where(#zzlxyntbys) .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#zzlxyntbys) .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_first_summary_row.thick {
  border-top-width: 2px;
}

:where(#zzlxyntbys) .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#zzlxyntbys) .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

:where(#zzlxyntbys) .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#zzlxyntbys) .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

:where(#zzlxyntbys) .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

:where(#zzlxyntbys) .gt_left {
  text-align: left;
}

:where(#zzlxyntbys) .gt_center {
  text-align: center;
}

:where(#zzlxyntbys) .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

:where(#zzlxyntbys) .gt_font_normal {
  font-weight: normal;
}

:where(#zzlxyntbys) .gt_font_bold {
  font-weight: bold;
}

:where(#zzlxyntbys) .gt_font_italic {
  font-style: italic;
}

:where(#zzlxyntbys) .gt_super {
  font-size: 65%;
}

:where(#zzlxyntbys) .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

:where(#zzlxyntbys) .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

:where(#zzlxyntbys) .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

:where(#zzlxyntbys) .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

:where(#zzlxyntbys) .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

:where(#zzlxyntbys) .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="3" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">CV-MSE for each base learner</th>
    </tr>
    
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">cv_mse_a</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">cv_mse_b</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">cv_mse_c</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right">0.38</td>
<td class="gt_row gt_right">0.02</td>
<td class="gt_row gt_right">0.11</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>The base learner that performs the best using our chosen loss function of interest is clearly Learner B. We can see from our data simulation code why this is true – Learner B is almost exactly the mimicking the data generating mechanism of <code>y</code>.</p>
<p>Our results align with the linear regression fit from our metalearning step; Learner B predictions received a much larger coefficient relative to Learners A and C.</p>
</section>
<section id="discrete-superlearner" class="level3">
<h3 class="anchored" data-anchor-id="discrete-superlearner">Discrete Superlearner</h3>
<p>We <em>could</em> stop after minimizing our loss function (MSE) and fit Learner B to our full data set, and that would be called using the <strong>discrete superlearner</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>discrete_sl_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="fu">glm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x1<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4), <span class="at">data=</span>obs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, we can almost always create an even better prediction algorithm if we use information from <em>all</em> of the algorithms’ CV predictions.</p>
</section>
<section id="choosing-a-metalearner" class="level3">
<h3 class="anchored" data-anchor-id="choosing-a-metalearner">Choosing a metalearner</h3>
<p>In the <a href="#references">Reference</a> papers on superlearning, the metalearner which yields the best results theoretically and in practice is a <strong>convex combination optimization</strong> of learners. This means fitting the following regression, where <span class="math inline">\(\alpha_1\)</span>, <span class="math inline">\(\alpha_2\)</span>, and <span class="math inline">\(\alpha_3\)</span> are all non-negative and sum to 1.</p>
<p><span class="math inline">\(\mathrm{E}[Y|\hat{Y}_{LrnrA},\hat{Y}_{LrnrB},\hat{Y}_{LrnrC}] = \alpha_1\hat{Y}_{LrnrA} + \alpha_2\hat{Y}_{LrnrB} + \alpha_3\hat{Y}_{LrnrC}\)</span></p>
<p>The default in the <code>Superlearner</code> package is to fit a non-negative least squares (NNLS) regression. NNLS fits the above equation where the <span class="math inline">\(\alpha\)</span>’s must be greater than or equal to 0 but do not necessarily sum to 1. The package then reweights the <span class="math inline">\(\alpha\)</span>’s to force them to sum to 1. This makes the weights a convex combination, but may not yield the same optimal results as an initial convex combination optimization.</p>
<p>The metalearner should change with the goals of the prediction algorithm and the loss function of interest. In these examples it is the MSE, but if the goal is to build a prediction algorithm that is best for binary classification, the loss function of interest may be the rank loss, or <span class="math inline">\(1-AUC\)</span>. It is outside the scope of this post, but for more information, I recommend this <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4912128/">paper</a> by Erin Ledell on maximizing the Area Under the Curve (AUC) with superlearner algorithms.</p>
</section>
<section id="another-visual-guide-for-superlearning" class="level3">
<h3 class="anchored" data-anchor-id="another-visual-guide-for-superlearning">Another visual guide for superlearning</h3>
<p>The steps of the superlearner algorithm are summarized nicely in this graphic in Chapter 3 of the <em>Targeted Learning</em> book:</p>
<p><img src="../../img/sl_diagram.png" class="img-fluid"></p>
</section>
</section>
<section id="acknowledgments" class="level1">
<h1>Acknowledgments</h1>
<p>Thank you to Eric Polley, Iván Díaz, Nick Williams, Anjile An, and Adam Peterson for very helpful content (and design!) suggestions for this post.</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<p>MJ Van der Laan, EC Polley, AE Hubbard, Super Learner, Statistical applications in genetics and molecular, 2007</p>
<p>Polley, Eric. “Chapter 3: Superlearning.” Targeted Learning: Causal Inference for Observational and Experimental Data, by M. J. van der. Laan and Sherri Rose, Springer, 2011.</p>
<p>Polley E, LeDell E, Kennedy C, van der Laan M. Super Learner: Super Learner Prediction. 2016 URL https://CRAN.R-project.org/package=SuperLearner. R package version 2.0-22.</p>
<p>Naimi AI, Balzer LB. Stacked generalization: an introduction to super learning. <em>Eur J Epidemiol.</em> 2018;33(5):459-464. doi:10.1007/s10654-018-0390-z</p>
<p>LeDell, E. (2015). Scalable Ensemble Learning and Computationally Efficient Variance Estimation. UC Berkeley. ProQuest ID: LeDell_berkeley_0028E_15235. Merritt ID: ark:/13030/m5wt1xp7. Retrieved from https://escholarship.org/uc/item/3kb142r2</p>
<p>M. Petersen and L. Balzer. Introduction to Causal Inference. UC Berkeley, August 2014. <a href="www.ucbbiostat.com">www.ucbbiostat.com</a></p>
</section>
<section id="session-info" class="level1">
<h1>Session Info</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.1.3 (2022-03-10)
Platform: x86_64-apple-darwin17.0 (64-bit)
Running under: macOS Catalina 10.15.7

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.0.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] splines   stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
 [1] SuperLearner_2.0-28 gam_1.20.2          foreach_1.5.2      
 [4] nnls_1.4            gt_0.6.0            forcats_0.5.1      
 [7] stringr_1.4.1       dplyr_1.0.9         purrr_0.3.4        
[10] readr_2.1.2         tidyr_1.2.0         tibble_3.1.8       
[13] ggplot2_3.3.6       tidyverse_1.3.1    

loaded via a namespace (and not attached):
 [1] httr_1.4.2         sass_0.4.1         jsonlite_1.8.0     modelr_0.1.8      
 [5] Formula_1.2-4      assertthat_0.2.1   cellranger_1.1.0   yaml_2.3.5        
 [9] pillar_1.8.1       backports_1.4.1    lattice_0.20-45    glue_1.6.2        
[13] digest_0.6.29      checkmate_2.0.0    rvest_1.0.2        colorspace_2.0-3  
[17] htmltools_0.5.2    Matrix_1.4-0       pkgconfig_2.0.3    broom_0.8.0       
[21] earth_5.3.1        haven_2.5.0        scales_1.2.1       ranger_0.14.1     
[25] TeachingDemos_2.12 tzdb_0.3.0         farver_2.1.1       generics_0.1.3    
[29] ellipsis_0.3.2     withr_2.5.0        cli_3.3.0          survival_3.2-13   
[33] magrittr_2.0.3     crayon_1.5.1       readxl_1.4.0       evaluate_0.15     
[37] fs_1.5.2           fansi_1.0.3        xml2_1.3.3         cabinets_0.6.0    
[41] tools_4.1.3        hms_1.1.1          lifecycle_1.0.1    munsell_0.5.0     
[45] reprex_2.0.1       glmnet_4.1-4       plotrix_3.8-2      compiler_4.1.3    
[49] rlang_1.0.4        plotmo_3.6.2       grid_4.1.3         iterators_1.0.14  
[53] rstudioapi_0.13    htmlwidgets_1.5.4  labeling_0.4.2     rmarkdown_2.13    
[57] gtable_0.3.0       codetools_0.2-18   DBI_1.1.2          R6_2.5.1          
[61] lubridate_1.8.0    knitr_1.38         fastmap_1.1.0      utf8_1.2.2        
[65] shape_1.4.6        stringi_1.7.8      Rcpp_1.0.9         vctrs_0.4.1       
[69] dbplyr_2.1.1       tidyselect_1.1.2   xfun_0.32         </code></pre>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/www\.khstats\.com/);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Become a Superlearner! An Illustrated Guide to Superlearning"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Katherine Hoffman"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2020-10-10T21:13:14-05:00</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> ["statistics"]</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> /img/sl_steps/Superlearning_crop.jpg</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co"> false</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="an">math:</span><span class="co"> true</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> " "</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="an">tags:</span><span class="co"> ["R","SuperLearner","superlearning","stacking","stacked generalizations","ensemble learning","sl3","rstats"]</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">  html_document:</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_float: true</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">    smart: false</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">    print_df: paged</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;head&gt;</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;title&gt;</span>HTML Image as link<span class="kw">&lt;/title&gt;</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/head&gt;</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">"/img/sl_steps/Superlearning.jpg"</span> <span class="er">alt</span><span class="ot">=</span><span class="st">"cheatsheet"</span> <span class="er">width</span><span class="ot">=</span><span class="st">"100%</span><span class="dv">&amp;quot;</span><span class="st">"</span><span class="kw">/&gt;</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;figcaption&gt;</span>***A Visual Guide...*** Over the winter, I read <span class="co">[</span><span class="ot">*Targeted Learning*</span><span class="co">](https://www.springer.com/gp/book/9781441997814)</span> by Mark van der Laan and Sherri Rose. This "visual guide" I made for *Chapter 3: Superlearning* by Rose, van der Laan, and Eric Polley is a condensed version of the following tutorial. It is available as an <span class="co">[</span><span class="ot">8.5x11" pdf on Github</span><span class="co">](https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/Superlearner.pdf)</span>, should you wish to print it out for reference (or desk decor).<span class="kw">&lt;/figcaption&gt;</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/a&gt;</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;br&gt;</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="fu"># Supercuts of superlearning</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Superlearning** is a technique for prediction that involves **combining many individual statistical algorithms** (commonly called "data-adaptive" or "machine learning" algorithms) to **create a new, single prediction algorithm** that is expected to **perform at least as well as any of the individual algorithms**.</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The superlearner algorithm "decides" how to combine, or weight, the individual algorithms based upon how well each one **minimizes a specified loss function**, for example, the mean squared error (MSE). This is done using cross-validation to avoid overfitting.</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The motivation for this type of "ensembling" is that **a mix of multiple algorithms may be more optimal for a given data set than any single algorithm**. For example, a tree based model averaged with a linear model (e.g. random forests and LASSO) could smooth some of the model's edges to improve predictive performance.</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Superlearning is also called stacking, stacked generalizations, and weighted ensembling by different specializations within the realms of statistics and data science.</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/spiderman_meme.jpg)</span>{width="42%"}</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="fu"># Superlearning, step by step</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>First I'll go through the algorithm one step at a time using a simulated data set.</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a><span class="fu">## Initial set-up: Load libraries, set seed, simulate data</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>For simplicity I'll show the concept of superlearning using only four variables (AKA features or predictors) to predict a continuous outcome. Let's first simulate a continuous outcome, <span class="in">`y`</span>, and four potential predictors, <span class="in">`x1`</span>, <span class="in">`x2`</span>, <span class="in">`x3`</span>, and <span class="in">`x4`</span>.</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, results="hide", message=F, warning=F}</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7</span>)</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(n),</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="dv">10</span><span class="sc">*</span>x1)),</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">plogis</span>(x1<span class="sc">*</span>x2 <span class="sc">+</span> .<span class="dv">5</span><span class="sc">*</span>x2)),</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">x4 =</span> <span class="fu">rnorm</span>(n, <span class="at">mean=</span>x1<span class="sc">*</span>x2, <span class="at">sd=</span>.<span class="dv">5</span><span class="sc">*</span>x3),</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x2<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4)</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a><span class="fu">gt</span>(<span class="fu">head</span>(obs)) <span class="sc">%&gt;%</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="st">"Simulated data set"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="fu">everything</span>(),<span class="at">decimals=</span><span class="dv">3</span>)</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span> <span class="kw">&gt;</span></span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 1: Split data into K folds</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_steps/step1.png)</span>{width="50%"} The superlearner algorithm relies on K-fold cross-validation (CV) to avoid overfitting. We will start this process by splitting the data into 10 folds. The easiest way to do this is by creating indices for each CV fold.</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># 10 fold cv</span></span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>cv_index <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>k, <span class="at">each =</span> n<span class="sc">/</span>k)) <span class="co"># create indices for each CV fold. We need each fold K to contain n (all the rows of our data set) divided by k rows. in our example this is 5000/10 = 500 rows in each fold</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 2: Fit base learners for first CV-fold</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_steps/step2.png)</span>{width="50%"}</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>Recall that in K-fold CV, each fold serves as the validation set one time. In this first round of CV, we will train all of our base learners on all the CV folds (k = 1,2,...,9) *except* for the very last one: <span class="in">`cv_index == 10`</span>.</span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>The individual algorithms or **base learners** that we'll use here are three linear regressions with differently specified parameters:</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Learner A**: $Y=\beta_0 + \beta_1 X_2 + \beta_2 X_4 + \epsilon$</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Learner B**: $Y=\beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_1 X_3 + \beta_4 sin(X_4) + \epsilon$</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Learner C**: $Y=\beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_3 + \beta_4 X_1 X_2 + \beta_5 X_1 X_3 + \beta_6 X_2 X_3 + \beta_7 X_1 X_2 X_3 + \epsilon$</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>cv_train_1 <span class="ot">&lt;-</span> obs[<span class="sc">-</span><span class="fu">which</span>(cv_index <span class="sc">==</span> <span class="dv">10</span>),] <span class="co"># make a data set that contains all observations except those in k=1</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>fit_1a <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x2 <span class="sc">+</span> x4, <span class="at">data=</span>cv_train_1) <span class="co"># fit the first linear regression on that training data</span></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>fit_1b <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x1<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4), <span class="at">data=</span>cv_train_1) <span class="co"># second LR fit on the training data</span></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>fit_1c <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1<span class="sc">*</span>x2<span class="sc">*</span>x3, <span class="at">data=</span>cv_train_1) <span class="co"># and the third LR</span></span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>I am *only* using the linear regressions so that code for running more complicated regressions does not take away from understanding the general superlearning algorithm.</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>Superlearning actually works best if you use a diverse set, or **superlearner library**, of base learners. For example, instead of three linear regressions, we could use a least absolute shrinkage estimator (LASSO), random forest, and multivariate adaptive splines (MARS). Any parametric or non-parametric supervised machine learning algorithm can be included as a base learner.</span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 3: Obtain predictions for first CV-fold</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_steps/step3.png)</span>{width="50%"}</span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>We can then get use our validation data, <span class="in">`cv_index == 10`</span>, to obtain our first set of cross-validated predictions.</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>cv_valid_1 <span class="ot">&lt;-</span> obs[<span class="fu">which</span>(cv_index <span class="sc">==</span> <span class="dv">10</span>),] <span class="co"># make a data set that only contains observations except in k=10</span></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>pred_1a <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1a, <span class="at">newdata =</span> cv_valid_1) <span class="co"># use that data set as the validation for all the models in the SL library</span></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a>pred_1b <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1b, <span class="at">newdata =</span> cv_valid_1) </span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>pred_1c <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1c, <span class="at">newdata =</span> cv_valid_1)</span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>Since we have 5000 <span class="in">`obs`</span>ervations, that gives us three vectors of length 500: a set of predictions for each of our Learners A, B, and C.</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(pred_1a) <span class="co"># double check we only have n/k predictions ...we do :-)</span></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">cbind</span>(pred_1a, pred_1b, pred_1c)) <span class="sc">%&gt;%</span></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="fu">everything</span>(), <span class="at">decimals =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="st">"First CV round of predictions"</span>) </span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 4: Obtain CV predictions for entire data set</span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_steps/step4.png)</span>{width="32%"}</span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a>We'll want to get those predictions for *every* fold. So, using your favorite <span class="in">`for`</span> loop, <span class="in">`apply`</span> statement, or <span class="in">`map`</span>ping function, fit the base learners and obtain predictions for each of them, so that there are 1000 predictions -- one for every point in <span class="in">`obs`</span>ervations.</span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>The way I chose to code this was to make a generic function that combines Step 2 (base learners fit to the training data) and Step 3 (predictions on the validation data), then use <span class="in">`map_dfr()`</span> from the <span class="in">`purrr`</span> package to repeat over all 10 CV folds. I saved the results in a new data frame called <span class="in">`cv_preds`</span>.</span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a>cv_folds <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="dv">1</span><span class="sc">:</span>k)</span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cv_folds) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"fold"</span>,<span class="dv">1</span><span class="sc">:</span>k)</span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>get_preds <span class="ot">&lt;-</span> <span class="cf">function</span>(fold){   <span class="co"># function that does the same procedure as step 2 and 3 for any CV fold</span></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>  cv_train <span class="ot">&lt;-</span> obs[<span class="sc">-</span><span class="fu">which</span>(cv_index <span class="sc">==</span> fold),]  <span class="co"># make a training data set that contains all data except fold k</span></span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>  fit_a <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x2 <span class="sc">+</span> x4, <span class="at">data=</span>cv_train)  <span class="co"># fit all the base learners to that data</span></span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a>  fit_b <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x1<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4), <span class="at">data=</span>cv_train)</span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>  fit_c <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1<span class="sc">*</span>x2<span class="sc">*</span>x3, <span class="at">data=</span>cv_train)</span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a>  cv_valid <span class="ot">&lt;-</span> obs[<span class="fu">which</span>(cv_index <span class="sc">==</span> fold),]  <span class="co"># make a validation data set that only contains data from fold k</span></span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a>  pred_a <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_a, <span class="at">newdata =</span> cv_valid)  <span class="co"># obtain predictions from all the base learners for that validation data</span></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a>  pred_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_b, <span class="at">newdata =</span> cv_valid)</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a>  pred_c <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_c, <span class="at">newdata =</span> cv_valid)</span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="st">"obs_id"</span> <span class="ot">=</span> cv_valid<span class="sc">$</span>id, <span class="st">"cv_fold"</span> <span class="ot">=</span> fold, pred_a, pred_b, pred_c))  <span class="co"># save the predictions and the ids of the observations in a data frame</span></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a>cv_preds <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_dfr</span>(cv_folds, <span class="sc">~</span><span class="fu">get_preds</span>(<span class="at">fold =</span> .x)) <span class="co"># map_dfr loops through every fold (1:k) and binds the rows of the listed results together</span></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>cv_preds <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(obs_id) <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(cv_fold<span class="sc">:</span>pred_c, <span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="st">"All CV predictions for all three base learners"</span>) </span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 5: Choose and compute loss function of interest via metalearner</span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_steps/step5.png)</span>{width="60%"}</span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; This is the key step of the superlearner algorithm: we will use a new learner, a **metalearner**, to take information from all of the base learners and create that new algorithm.</span></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a>Now that we have cross-validated predictions for every observation in the data set, we want to merge those CV predictions back into our main data set...</span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a>obs_preds <span class="ot">&lt;-</span> </span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(obs, cv_preds, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"obs_id"</span>))</span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a>...so that we can minimize a final loss function of interest between the true outcome and each CV prediction. This is how we're going to optimize our overall prediction algorithm: we want to make sure we're "losing the least" in the way we combine our base learners' predictions to ultimately make final predictions. We can do this efficiently by choosing a new learner, a metalearner, which reflects the final loss function of interest.</span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a>For simplicity, we'll use another linear regression as our metalearner. Using a linear regression as a metalearner will minimize the Cross-Validated Mean Squared Error (CV-MSE) when combining the base learner predictions. Note that we could use a variety of parametric or non-parametric regressions to minimize the CV-MSE.</span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>No matter what metalearner we choose, the predictors will always be the cross-validated predictions from each base learner, and the outcome will always be the true outcome, <span class="in">`y`</span>.</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a>sl_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> pred_a <span class="sc">+</span> pred_b <span class="sc">+</span> pred_c, <span class="at">data =</span> obs_preds)</span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(sl_fit) <span class="sc">%&gt;%</span> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(estimate<span class="sc">:</span>p.value, <span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="st">"Metalearner regression coefficients"</span>) </span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a>This metalearner provides us with the coefficients, or weights, to apply to each of the base learners. In other words, if we have a set of predictions from Learner A, B, and C, we can obtain our best possible predictions by starting with an intercept of <span class="in">`r round(sl_fit$coefficients[1],3)`</span>, then adding <span class="in">`r round(sl_fit$coefficients[[2]],3)`</span> $\times$ predictions from Learner A, <span class="in">`r round(sl_fit$coefficients[[3]],3)`</span> $\times$ predictions from Learner B, and <span class="in">`r round(sl_fit$coefficients[[4]],3)`</span> $\times$ predictions from Learner C.</span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a>*For more information on the metalearning step, check out the [Appendix](#appendix).*</span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 6: Fit base learners on entire data set</span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_steps/step6.png)</span>{width="50%"}</span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a>After we fit the metalearner, we officially have our superlearner algorithm, so it's time to input data and obtain predictions! To implement the algorithm and obtain final predictions, we first need to fit the base learners on the full data set.</span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a>fit_a <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x2 <span class="sc">+</span> x4, <span class="at">data=</span>obs)</span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a>fit_b <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x1<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4), <span class="at">data=</span>obs)</span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a>fit_c <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x1<span class="sc">*</span>x2<span class="sc">*</span>x3, <span class="at">data=</span>obs)</span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 7: Obtain predictions from each base learner on entire data set</span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_steps/step7.png)</span>{width="40%"}</span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>We'll use *those* base learner fits to get predictions from each of the base learners for the entire data set, and then we will plug those predictions into the metalearner fit. Remember, we were previously using cross-validated predictions, rather than fitting the base learners on the whole data set. This was to avoid overfitting.</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a>pred_a <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_a)</span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a>pred_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_b)</span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a>pred_c <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_c)</span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a>full_data_preds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(pred_a, pred_b, pred_c)</span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 8: Use metalearner fit to weight base learners</span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_steps/step8.png)</span>{width="60%"}</span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a>Once we have the predictions from the full data set, we can input them to the metalearner, where the output will be a final prediction for <span class="in">`y`</span>.</span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a>sl_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(sl_fit, <span class="at">newdata =</span> full_data_preds)</span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">sl_predictions =</span> <span class="fu">head</span>(sl_predictions)) <span class="sc">%&gt;%</span></span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> <span class="fu">fmt_number</span>(sl_predictions, <span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a><span class="fu">tab_header</span>(<span class="st">"Final SL predictions (manual)"</span>) </span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a>And... that's it! Those are our superlearner predictions for the full data set.</span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 9: Obtain predictions on new data</span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>We can now modify Step 7 and Step 8 to accommodate any new observation(s):</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **To predict on new data:**</span><span class="kw">&lt;br&gt;</span><span class="at">&nbsp;1. Use the fits from each base learner to obtain base learner predictions for the new observation(s).</span><span class="kw">&lt;br&gt;</span><span class="at">&nbsp;2. Plug those base learner predictions into the metalearner fit.</span></span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a>We can generate a single <span class="in">`new_obs`</span>ervation to see how this would work in practice.</span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a>new_obs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x1 =</span> .<span class="dv">5</span>, <span class="at">x2 =</span> <span class="dv">0</span>, <span class="at">x3 =</span> <span class="dv">0</span>, <span class="at">x4 =</span> <span class="sc">-</span><span class="dv">3</span>)</span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a>new_pred_a <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_a, new_obs)</span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a>new_pred_b <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_b, new_obs)</span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a>new_pred_c <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_c, new_obs)</span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a>new_pred_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">"pred_a"</span> <span class="ot">=</span> new_pred_a, <span class="st">"pred_b"</span> <span class="ot">=</span> new_pred_b, <span class="st">"pred_c"</span> <span class="ot">=</span> new_pred_c)</span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(sl_fit, <span class="at">newdata =</span> new_pred_df)</span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a>Our superlearner model predicts that an observation with predictors $X_1=.5$, $X_2=0$, $X_3=0$, and $X_4=-3$ will have an outcome of $Y=<span class="in">`r round(predict(sl_fit, newdata = new_pred_df), 3)`</span>$.</span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:#c30a0a"</span><span class="kw">&gt;</span></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;strong&gt;</span>Step 10 and beyond...</span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/h1&gt;</span></span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/strong&gt;</span></span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a>We could compute the MSE of the ensemble superlearner predictions.</span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a>sl_mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((obs<span class="sc">$</span>y <span class="sc">-</span> sl_predictions)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a>sl_mse</span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a>We could also add more algorithms to our base learner library (we definitely should, since we only used linear regressions!), and we could write functions to tune these algorithms' hyperparameters over various grids. For example, if we were to include random forest in our library, we may want to tune over a number of trees and maximum bucket sizes.</span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a>We can then cross-validate this entire process to evaluate the predictive performance of our superlearner algorithm. Alternatively, we could leave a hold-out training data set to evaluate the performance.</span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a><span class="fu"># Using the `SuperLearner` package</span></span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a>Or... we could use a package and avoid all the hand-coding. Here is how you would build an ensemble superlearner for our data with the base learner libraries of <span class="in">`ranger`</span> (random forests), <span class="in">`glmnet`</span> (LASSO, by default), and <span class="in">`earth`</span> (MARS) using the <span class="in">`SuperLearner`</span> package in <span class="in">`R`</span>:</span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=F, message = F}</span></span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a>x_df <span class="ot">&lt;-</span> obs <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1<span class="sc">:</span>x4) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a>sl_fit <span class="ot">&lt;-</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> obs<span class="sc">$</span>y, <span class="at">X =</span> x_df, <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.ranger"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.earth"</span>))</span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a>You can specify the metalearner with the <span class="in">`method`</span> argument. The default is <span class="co">[</span><span class="ot">Non-Negative Least Squares</span><span class="co">](##non-negative-least-squares)</span> (NNLS).</span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a><span class="fu">## CV-Risk and Coefficient Weights</span></span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a>We can examine the cross-validated <span class="in">`Risk`</span> (loss function), and the <span class="in">`Coef`</span>ficient (weight) given to each of the models.</span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a>sl_fit</span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a>From this summary we can see that the CV-risk (the default risk is MSE) in this library of base learners is smallest for <span class="in">`SL.Earth`</span>. This translates to the largest coefficient, or weight, given to the predictions from <span class="in">`earth`</span>.</span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a>The LASSO model implemented by <span class="in">`glmnet`</span> has the largest CV-risk, and after the metalearning step, those predictions receive a coefficient, or weight, of 0. This means that the predictions from LASSO will not be incorporated into the final predictions at all.</span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a><span class="fu">## Obtaining the predictions</span></span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a>We can extract the predictions easily via the <span class="in">`SL.predict`</span> element of the <span class="in">`SuperLearner`</span> fit object.</span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(<span class="at">sl_predictions =</span> sl_fit<span class="sc">$</span>SL.predict)) <span class="sc">%&gt;%</span> <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="fu">everything</span>(),<span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">tab_header</span>(<span class="st">"Final SL predictions (package)"</span>) </span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cross-validated Superlearner</span></span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a>Recall that we can cross-validate the entire model fitting process to evaluate the predictive performance of our superlearner algorithm. This is easy with the function <span class="in">`CV.SuperLearner()`</span>. Beware, this gets computationally burdensome very quickly!</span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a>cv_sl_fit <span class="ot">&lt;-</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> obs<span class="sc">$</span>y, <span class="at">X =</span> x_df, <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.ranger"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.earth"</span>))</span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a>For more information on the <span class="in">`SuperLearner`</span> package, take a look at this <span class="co">[</span><span class="ot">vignette</span><span class="co">](https://cran.r-project.org/web/packages/SuperLearner/vignettes/Guide-to-SuperLearner.html)</span>.</span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a><span class="fu">## Alternative packages to superlearn</span></span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a>Other packages freely available in <span class="in">`R`</span> that can be used to implement the superlearner algorithm include <span class="co">[</span><span class="ot">`sl3`</span><span class="co">](https://tlverse.org/tlverse-handbook/sl3.html)</span> (an update to the original <span class="in">`Superlearner`</span> package), <span class="co">[</span><span class="ot">`h2o`</span><span class="co">](https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/stacked-ensembles.html)</span>, and <span class="co">[</span><span class="ot">`caretEnsemble`</span><span class="co">](https://rdrr.io/cran/caretEnsemble/f/vignettes/caretEnsemble-intro.Rmd)</span>. I previously wrote a <span class="co">[</span><span class="ot">brief demo</span><span class="co">](https://www.khstats.com/blog/sl3_demo/sl/)</span> on using <span class="in">`sl3`</span> for an NYC R-Ladies demo.</span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a>The authors of <span class="in">`tidymodels`</span> -- a suite of packages for machine learning including <span class="in">`recipes`</span>, <span class="in">`parsnip`</span>, and <span class="in">`rsample`</span> -- recently came out with a new package to perform superlearning/stacking called <span class="co">[</span><span class="ot">`stacks`</span><span class="co">](%5Bhttps://stacks.tidymodels.org/articles/basics.html)</span>. Prior to this, Alex Hayes wrote a <span class="co">[</span><span class="ot">blog post</span><span class="co">](https://www.alexpghayes.com/blog/implementing-the-super-learner-with-tidymodels/)</span> on using <span class="in">`tidymodels`</span> infrastructure to implement superlearning.</span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a><span class="fu"># Coming soon... when prediction is not the end goal</span></span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>When prediction is not the end goal, superlearning combines well with semi-parametric estimation methods for statistical inference. This is the reason I was reading *Targeted Learning* in the first place; I am a statistician with collaborators who typically want estimates of treatment effects with confidence intervals, not predictions!</span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a>I'm working on a similar visual guide for one such semiparametric estimation method: <span class="co">[</span><span class="ot">Targeted Maximum Likelihood Estimation</span><span class="co">](https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/TMLE.pdf)</span> (TMLE)). TMLE allows the use of flexible statistical models like the superlearner algorithm when estimating treatment effects. If you found this superlearning tutorial helpful, you may be interested in this <span class="co">[</span><span class="ot">similarly visual tutorial</span><span class="co">](https://www.khstats.com/blog/tmle/tutorial/)</span> on TMLE.</span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;head&gt;</span></span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;title&gt;</span>HTML Image as link<span class="kw">&lt;/title&gt;</span></span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/head&gt;</span></span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://github.com/kathoffman/causal-inference-visual-guides/blob/master/visual-guides/TMLE.pdf"</span><span class="kw">&gt;</span> <span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">"/img/TMLE.jpg"</span> <span class="er">alt</span><span class="ot">=</span><span class="st">"cheatsheet"</span> <span class="er">width</span><span class="ot">=</span><span class="st">"100%</span><span class="dv">&amp;quot;</span><span class="st">"</span><span class="kw">/&gt;</span> <span class="kw">&lt;/a&gt;&lt;/body&gt;</span></span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a><span class="fu"># Appendix {#appendix}</span></span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a>These sections contain a bit of extra information on the superlearning algorithm, such as: intuition on manually computing the loss function of interest, explanation of the discrete superlearner, brief advice on choosing a metalearner, and a different summary visual provided in the *Targeted Learning* book.</span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a><span class="fu">### Manually computing the MSE</span></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a>Let's say we have chosen our loss function of interest to be the Mean Squared Error (MSE). We could first compute the squared error $(y - \hat{y})^2$ for each CV prediction A, B, and C.</span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a>cv_sq_error <span class="ot">&lt;-</span></span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a>  obs_preds <span class="sc">%&gt;%</span></span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cv_sqrd_error_a =</span> (y<span class="sc">-</span>pred_a)<span class="sc">^</span><span class="dv">2</span>,   <span class="co"># compute squared error for each observation</span></span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a>         <span class="at">cv_sqrd_error_b =</span> (y<span class="sc">-</span>pred_b)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a>         <span class="at">cv_sqrd_error_c =</span> (y<span class="sc">-</span>pred_c)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=5.5}</span></span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a>cv_sq_error <span class="sc">%&gt;%</span> </span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(cv_sqrd_error_a, cv_sqrd_error_b, cv_sqrd_error_c), <span class="co"># make the CV squared errors long form for plotting</span></span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"base_learner"</span>,</span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"squared_error"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">base_learner =</span> <span class="fu">toupper</span>(<span class="fu">str_remove</span>(base_learner, <span class="st">"cv_sqrd_error_"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(base_learner, squared_error, <span class="at">col=</span>base_learner)) <span class="sc">+</span> <span class="co"># make box plots</span></span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">col=</span>F) <span class="sc">+</span></span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Base Learner"</span>, <span class="at">y=</span><span class="st">"Squared Error"</span>, <span class="at">title=</span><span class="st">"Squared Errors of Learner A, B, and C"</span>)</span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a>And then take the mean of those three cross-validated squared error columns, grouped by <span class="in">`cv_fold`</span>, to get the CV-MSE for each fold.</span>
<span id="cb32-540"><a href="#cb32-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a>cv_risks <span class="ot">&lt;-</span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a>  cv_sq_error <span class="sc">%&gt;%</span></span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cv_fold) <span class="sc">%&gt;%</span></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">cv_mse_a =</span> <span class="fu">mean</span>(cv_sqrd_error_a),</span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>            <span class="at">cv_mse_b =</span> <span class="fu">mean</span>(cv_sqrd_error_b),</span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a>            <span class="at">cv_mse_c =</span> <span class="fu">mean</span>(cv_sqrd_error_c)</span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>cv_risks <span class="sc">%&gt;%</span></span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(cv_mse_a<span class="sc">:</span>cv_mse_c,</span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"base_learner"</span>,</span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"mse"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">base_learner =</span> <span class="fu">toupper</span>(<span class="fu">str_remove</span>(base_learner,<span class="st">"cv_mse_"</span>)))  <span class="sc">%&gt;%</span></span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(cv_fold, mse, <span class="at">col=</span>base_learner)) <span class="sc">+</span></span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()  <span class="sc">+</span></span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Cross-Validation (CV) Fold"</span>, <span class="at">y=</span><span class="st">"Mean Squared Error (MSE)"</span>, <span class="at">col =</span> <span class="st">"Base Learner"</span>, <span class="at">title=</span><span class="st">"CV-MSEs for Base Learners A, B, and C"</span>)</span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a>We see that across each fold, Learner B consistently has an MSE around 0.02, while Learner C hovers around 0.1, and Learner A varies between 0.35 and 0.45. We can take another mean to get the overall CV-MSE for each learner.</span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a>cv_risks <span class="sc">%&gt;%</span></span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>cv_fold) <span class="sc">%&gt;%</span></span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(mean) <span class="sc">%&gt;%</span></span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="fu">everything</span>(), <span class="at">decimals=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">tab_header</span>(<span class="st">"CV-MSE for each base learner"</span>)</span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a>The base learner that performs the best using our chosen loss function of interest is clearly Learner B. We can see from our data simulation code why this is true -- Learner B is almost exactly the mimicking the data generating mechanism of <span class="in">`y`</span>.</span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a>Our results align with the linear regression fit from our metalearning step; Learner B predictions received a much larger coefficient relative to Learners A and C.</span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a><span class="fu">### Discrete Superlearner</span></span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>We *could* stop after minimizing our loss function (MSE) and fit Learner B to our full data set, and that would be called using the **discrete superlearner**.</span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a>discrete_sl_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="fu">glm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x1<span class="sc">*</span>x3 <span class="sc">+</span> <span class="fu">sin</span>(x4), <span class="at">data=</span>obs))</span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a>However, we can almost always create an even better prediction algorithm if we use information from *all* of the algorithms' CV predictions.</span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a><span class="fu">### Choosing a metalearner</span></span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a>In the <span class="co">[</span><span class="ot">Reference</span><span class="co">](#references)</span> papers on superlearning, the metalearner which yields the best results theoretically and in practice is a **convex combination optimization** of learners. This means fitting the following regression, where $\alpha_1$, $\alpha_2$, and $\alpha_3$ are all non-negative and sum to 1.</span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>$\mathrm{E}<span class="co">[</span><span class="ot">Y|\hat{Y}_{LrnrA},\hat{Y}_{LrnrB},\hat{Y}_{LrnrC}</span><span class="co">]</span> = \alpha_1\hat{Y}_{LrnrA} + \alpha_2\hat{Y}_{LrnrB} + \alpha_3\hat{Y}_{LrnrC}$</span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>The default in the <span class="in">`Superlearner`</span> package is to fit a non-negative least squares (NNLS) regression. NNLS fits the above equation where the $\alpha$'s must be greater than or equal to 0 but do not necessarily sum to 1. The package then reweights the $\alpha$'s to force them to sum to 1. This makes the weights a convex combination, but may not yield the same optimal results as an initial convex combination optimization.</span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>The metalearner should change with the goals of the prediction algorithm and the loss function of interest. In these examples it is the MSE, but if the goal is to build a prediction algorithm that is best for binary classification, the loss function of interest may be the rank loss, or $1-AUC$. It is outside the scope of this post, but for more information, I recommend this <span class="co">[</span><span class="ot">paper</span><span class="co">](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4912128/)</span> by Erin Ledell on maximizing the Area Under the Curve (AUC) with superlearner algorithms.</span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a><span class="fu">### Another visual guide for superlearning</span></span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a>The steps of the superlearner algorithm are summarized nicely in this graphic in Chapter 3 of the *Targeted Learning* book:</span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a><span class="al">![](/img/sl_diagram.png)</span></span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a><span class="fu"># Acknowledgments</span></span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a>Thank you to Eric Polley, Iván Díaz, Nick Williams, Anjile An, and Adam Peterson for very helpful content (and design!) suggestions for this post.</span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a><span class="fu"># References {#references}</span></span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a>MJ Van der Laan, EC Polley, AE Hubbard, Super Learner, Statistical applications in genetics and molecular, 2007</span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a>Polley, Eric. "Chapter 3: Superlearning." Targeted Learning: Causal Inference for Observational and Experimental Data, by M. J. van der. Laan and Sherri Rose, Springer, 2011.</span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a>Polley E, LeDell E, Kennedy C, van der Laan M. Super Learner: Super Learner Prediction. 2016 URL https://CRAN.R-project.org/package=SuperLearner. R package version 2.0-22.</span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a>Naimi AI, Balzer LB. Stacked generalization: an introduction to super learning. *Eur J Epidemiol.* 2018;33(5):459-464. doi:10.1007/s10654-018-0390-z</span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a>LeDell, E. (2015). Scalable Ensemble Learning and Computationally Efficient Variance Estimation. UC Berkeley. ProQuest ID: LeDell_berkeley_0028E_15235. Merritt ID: ark:/13030/m5wt1xp7. Retrieved from https://escholarship.org/uc/item/3kb142r2</span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a>M. Petersen and L. Balzer. Introduction to Causal Inference. UC Berkeley, August 2014. <span class="co">[</span><span class="ot">www.ucbbiostat.com</span><span class="co">](www.ucbbiostat.com)</span></span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a><span class="fu"># Session Info</span></span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a><span class="in">```{r results='markup'}</span></span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>