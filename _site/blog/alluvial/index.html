<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Katherine Hoffman">
<meta name="dcterms.date" content="2023-01-02">

<title>KHstats - Alluvial Plots (AKA Sankey Diagrams) for Time-Varying Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/climbing_comic.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-136820093-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<style>html{ scroll-behavior: smooth; }</style>


<meta property="og:title" content="KHstats - Alluvial Plots (AKA Sankey Diagrams) for Time-Varying Data">
<meta property="og:description" content="">
<meta property="og:image" content="www.khstats.com/blog/alluvial/image.png">
<meta property="og:site-name" content="KHstats">
<meta name="twitter:title" content="KHstats - Alluvial Plots (AKA Sankey Diagrams) for Time-Varying Data">
<meta name="twitter:description" content="Thoughts and doodles on (bio)statistics, causal inference, data visualization, R programming, etc.">
<meta name="twitter:image" content="www.khstats.com/blog/alluvial/img/climbing_comic.jpg">
<meta name="twitter:card" content="summary">
</head>

<body class="docked nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">KHstats</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks.html" rel="" target="">
 <span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-illustrations" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Illustrations</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-illustrations">    
        <li>
    <a class="dropdown-item" href="../../art/illustrations_viz.html" rel="" target="">
 <span class="dropdown-text">Visual Guides for Causal Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../art/illustrations_draw.html" rel="" target="">
 <span class="dropdown-text">Educational Drawings and Comics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-research" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Research</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-research">    
        <li>
    <a class="dropdown-item" href="../../pubs/pubs_methods.html" rel="" target="">
 <span class="dropdown-text">Statistics Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubs/pubs_applications.html" rel="" target="">
 <span class="dropdown-text">Clinical Applications</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://scholar.google.com/citations?user=73RvTUoAAAAJ&amp;hl=en" rel="" target="">
 <span class="dropdown-text">Google Scholar Profile</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/kat_hoffman_" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kathoffman" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../static/KatherineHoffman_CV_Sept2023.pdf" rel="" target="">
 <span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:kathoffman.stats@gmail.com" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Alluvial Plots (AKA Sankey Diagrams) for Time-Varying Data</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">programming</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Katherine Hoffman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 2, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#step-0-load-long-form-data" id="toc-step-0-load-long-form-data" class="nav-link active" data-scroll-target="#step-0-load-long-form-data">Step 0: Load long-form data</a></li>
  <li><a href="#step-1-create-wide-form-data" id="toc-step-1-create-wide-form-data" class="nav-link" data-scroll-target="#step-1-create-wide-form-data">Step 1: Create wide-form data</a></li>
  <li><a href="#step-2-create-ggalluvial-compatible-data" id="toc-step-2-create-ggalluvial-compatible-data" class="nav-link" data-scroll-target="#step-2-create-ggalluvial-compatible-data">Step 2: Create <code>ggalluvial</code>-compatible data</a>
  <ul class="collapse">
  <li><a href="#step-2a-group_by_at" id="toc-step-2a-group_by_at" class="nav-link" data-scroll-target="#step-2a-group_by_at">Step 2a: <code>group_by_at</code></a></li>
  <li><a href="#step-2b-count" id="toc-step-2b-count" class="nav-link" data-scroll-target="#step-2b-count">Step 2b: <code>count</code></a></li>
  <li><a href="#step-2c-ggalluvialto_lodes_form" id="toc-step-2c-ggalluvialto_lodes_form" class="nav-link" data-scroll-target="#step-2c-ggalluvialto_lodes_form">Step 2c: <code>ggalluvial::to_lodes_form()</code></a></li>
  <li><a href="#step-2d-changes-x-axis-and-reorder-statusstratum-levels" id="toc-step-2d-changes-x-axis-and-reorder-statusstratum-levels" class="nav-link" data-scroll-target="#step-2d-changes-x-axis-and-reorder-statusstratum-levels">Step 2d: Changes x-axis and reorder status/stratum levels</a></li>
  </ul></li>
  <li><a href="#step-3-set-up-colors" id="toc-step-3-set-up-colors" class="nav-link" data-scroll-target="#step-3-set-up-colors">Step 3: Set up colors</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<blockquote class="blockquote">
<p><strong>Alluvial</strong> plots, or <strong>Sankey diagrams</strong>, can be used to show the <strong>movement of individual units across a single variable</strong>, such as time. In this post I’ll show the steps to make the below alluvial plot for a time-varying exposure and time-to-event outcome.</p>
</blockquote>
<p>I’ve been making alluvial plots, also known as Sankey diagrams, for my research in pulmonary and critical care for a few years now. For example, in a recent manuscript, I used an alluvial plot to show:</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../img/sofa_fig_alluvial.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Another example of an alluvial plot I’ve made for a manuscript is Figure 1A of <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8641830/">Schenck et al.&nbsp;(2022)</a>. It shows number of patients with each Serial Organ Failure Assessment pulmonary subscore (0,1,2,3,4) using various substitution methods for missing measurements.</figcaption>
</figure>
</div>
</div></div><ul>
<li>a time-varying categorical exposure: maximum level of respiratory support
<ul>
<li>no supplemental oxygen</li>
<li>non-invasive supplemental oxygen</li>
<li>invasive mechanical ventilation</li>
</ul></li>
<li>a time-to event outcome: time to acute kidney injury (AKI)</li>
<li>a censoring event: hospital discharge</li>
<li>a competing risk: death</li>
</ul>
<p>The below plot is from <a href="">Diaz et al.&nbsp;(2023)</a> and shows the exposure and outcome statuses over 14 days of study time in a cohort of 3,000 critically ill COVID-19 patients.</p>
<p><img src="../../img/diaz_alluvial_ex.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="What about swimmer plots?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What about swimmer plots?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Another option to show time-varying exposures is <a href="">swimmer plots</a>, however, the space required for these figures quickly becomes impractical as the number of individual study units grows.</p>
</div>
</div>

<!-- ::: {.column-margin} -->
<!-- ![Another example of an alluvial plot for applied research is in [Diaz et al. (2023)](). It shows the maximum level of respiratory support (no supplemental oxygen, non-invasive supplemental oxygen, and invasive mechanical ventilation) over 14 days of study time in a population of critically ill COVID-19 patients. Outcomes of interest are also shown (hospital discharge, acute kidney injury, and death).](../../img/diaz_alluvial_ex.png) -->
<!-- ::: -->
<!-- https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8641830/ -->
<!-- For example, I used them to show... -->
<!--  [`ggalluvial`](https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html#:~:text=The%20%7Bggalluvial%7D%20package%20is%20a,the%20feedback%20of%20many%20users.)  -->
<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../img/swimmer.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Swimmer plot from my blog post “Swimmer Plots for multiple treatments using ggplot2.”</figcaption>
</figure>
</div>
</div></div><p>In this post I’ll walk through making alluvial plots with the <code>R</code> package <a href="https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html#:~:text=The%20%7Bggalluvial%7D%20package%20is%20a,the%20feedback%20of%20many%20users."><code>{ggalluvial}</code></a> to display movement of study units in longitudinal data. The end product will show the movement of the following complexities over time in a simulated data set:</p>
<ul>
<li>Time-varying exposure (Treatment vs.&nbsp;No treatment)</li>
<li>Time-to-event outcome</li>
<li>Competing event</li>
<li>Loss to follow up</li>
</ul>
<p>I’ll show how these plots can be organized to look similar to Kaplan Meier plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggalluvial)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>max_time <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"blog/alluvial/aki_death_status.csv"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">case_when</span>(status <span class="sc">==</span> <span class="st">"Non-IMV supplemental oxygen"</span> <span class="sc">~</span> <span class="st">"Treatment B"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                            status <span class="sc">==</span> <span class="st">"IMV"</span> <span class="sc">~</span> <span class="st">"Treatment A"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>                            status <span class="sc">==</span> <span class="st">"Deceased"</span> <span class="sc">~</span> <span class="st">"Competing event"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>                            status <span class="sc">==</span> <span class="st">"Discharged"</span> <span class="sc">~</span> <span class="st">"Loss to follow up"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                            status <span class="sc">==</span> <span class="st">"AKI"</span> <span class="sc">~</span> <span class="st">"Outcome"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                            status <span class="sc">==</span> <span class="st">"No supplemental oxygen"</span> <span class="sc">~</span> <span class="st">"Treatment A"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&lt;=</span> max_time) <span class="sc">|&gt;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">fct_relevel</span>(status, <span class="st">"Loss to follow up"</span>))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>dat_wide <span class="ot">&lt;-</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  dat_long <span class="sc">|&gt;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> id, <span class="at">names_from =</span> time, <span class="at">values_from =</span> status, <span class="at">names_prefix =</span> <span class="st">"time_"</span>) </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>vars_to_group <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"time_"</span>, <span class="dv">0</span><span class="sc">:</span>max_time)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>type_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#6A6599"</span>, <span class="co"># purple</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"#B24745"</span>, <span class="co">#red</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"#00A1D5"</span>, <span class="co">#bluea,</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"#374E55"</span>, <span class="co"># gray</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"#79AF97"</span> <span class="co"># green</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>dat_alluvial <span class="ot">&lt;-</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  dat_wide <span class="sc">|&gt;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_at</span>(vars_to_group) <span class="sc">|&gt;</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_lodes_form</span>(<span class="at">key =</span> <span class="st">"month"</span>, <span class="at">axes =</span> <span class="dv">1</span><span class="sc">:</span>max_time) <span class="sc">|&gt;</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">factor</span>(<span class="fu">parse_number</span>(<span class="fu">as.character</span>(month))))</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>dat_alluvial <span class="sc">|&gt;</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> month,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">stratum =</span> stratum, </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> stratum,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">alluvium =</span> alluvium,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">y=</span>n,</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> stratum)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flow</span>() <span class="sc">+</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stratum</span>() <span class="sc">+</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_fill_manual(values = type_colors) +</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_color_manual(values = type_colors) +</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Study Month"</span>,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Patients"</span>,</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Number of Patients per Exposure-Outcome Status by Day"</span>,</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Status"</span>,</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">"Status"</span>) <span class="sc">+</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text=</span><span class="fu">element_text</span>(<span class="at">family=</span><span class="st">"Roboto"</span>),</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>          <span class="at">size=</span><span class="dv">9</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<section id="step-0-load-long-form-data" class="level1">
<h1>Step 0: Load long-form data</h1>
<p>We’ll first read in the data set from my Github. This data is in <strong>long-form</strong>, meaning there is one row for every patient at every time point of the study. There are 3,300 patients in this data, and there are 14 time points, so 14 * 3,300 = 49,500 rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"blog/alluvial/aki_death_status.csv"</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>dat_long</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 49,500 × 3
      id  time status                     
   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                      
 1     1     0 Non-IMV supplemental oxygen
 2     1     1 Non-IMV supplemental oxygen
 3     1     2 Non-IMV supplemental oxygen
 4     1     3 AKI                        
 5     1     4 AKI                        
 6     1     5 AKI                        
 7     1     6 AKI                        
 8     1     7 AKI                        
 9     1     8 AKI                        
10     1     9 AKI                        
# ℹ 49,490 more rows</code></pre>
</div>
</div>
<p>At each <code>time</code> point, there is a column <code>status</code> which indicates whether the patient was still in the study, and if so, what their supplemental oxygen status, where categories are:</p>
<ul>
<li><p><code>"No supplemental oxygen"</code></p></li>
<li><p><code>"Non-IMV supplemental oxygen"</code></p></li>
<li><p><code>"IMV"</code></p></li>
</ul>
<p>If they are not in the study any longer, the status indicates whether it is because they either:</p>
<ul>
<li>experienced the event of interest (<code>"AKI"</code>)</li>
<li>experienced a competing event, i.e.&nbsp;death (<code>"Deceased"</code>)</li>
<li>or they were informatively right-censored (<code>"Discharged"</code>).</li>
</ul>
</section>
<section id="step-1-create-wide-form-data" class="level1">
<h1>Step 1: Create wide-form data</h1>
<p>I’ve started with the long-form data because I think(!) it is the most common form for an analyst to start with in their time-varying exposure and/or time-to-event data analysis. However, we actually need the data to be in <strong>wide-form</strong> to make it compatible for plotting using the <code>ggalluvial</code> package. Wide-form data means we want one row per patient (n=3,300) and one column per time point (k=14), and the values of each cell is the patient’s status at that time point.</p>
<p>We will use the <code>pivot_wider()</code> function for this. Here are the breakdowns of the arguments we’ll use in <code>pivot_wider()</code>. For more information, type <code>?pivot_wider()</code> into your <code>R</code> console.</p>
<ul>
<li><p><code>id_col = id</code> specifies that the <code>id</code> column uniquely identifies each observation (each patient)</p></li>
<li><p><code>names_from = time</code> means the names of the new columns for each time point will come from the current <code>time</code> column</p></li>
<li><p><code>names_prefix = "time_"</code> will relabel our new time columns to be {<code>time_1</code>, <code>time_2</code>, …, <code>time_14</code>}</p></li>
<li><p><code>values_from = status</code> indicates we want the values in the cells of our new data frame to be the values that are currently in the <code>status</code> column of our long-form data.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dat_wide <span class="ot">&lt;-</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  dat_long <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> id,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> time, </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> status,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"time_"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>dat_wide</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,300 × 16
      id time_0   time_1 time_2 time_3 time_4 time_5 time_6 time_7 time_8 time_9
   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; 
 1     1 Non-IMV… Non-I… Non-I… AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 2     2 No supp… No su… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I…
 3     3 No supp… Disch… Disch… Disch… Disch… Disch… Disch… Disch… Disch… Disch…
 4     4 Non-IMV… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Decea… Decea…
 5     5 Non-IMV… Non-I… Non-I… Non-I… Non-I… No su… No su… No su… Disch… Disch…
 6     6 Non-IMV… Non-I… AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 7     7 Non-IMV… No su… AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 8     8 Non-IMV… Non-I… Non-I… No su… No su… No su… Disch… Disch… Disch… Disch…
 9     9 No supp… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Disch… Disch… Disch…
10    10 IMV      AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
# ℹ 3,290 more rows
# ℹ 5 more variables: time_10 &lt;chr&gt;, time_11 &lt;chr&gt;, time_12 &lt;chr&gt;,
#   time_13 &lt;chr&gt;, time_14 &lt;chr&gt;</code></pre>
</div>
</div>
</section>
<section id="step-2-create-ggalluvial-compatible-data" class="level1">
<h1>Step 2: Create <code>ggalluvial</code>-compatible data</h1>
<p>The next step after you have wide form data (with a status value for every observation and time point in your plot) is to get the data wrangled into the format that <code>ggalluvial</code> can handle for plotting.</p>
<p>First, we need to get the number of observations (patients) which have the same “flow” or “path” across all the time points in our study. In other words, we want to know how many patients are on no supplemental oxygen for times 1-10 and are then discharged at time 11. We <em>also</em> want to know how many patients have an exposure of IMV their first day of the study, and then die the second day. There are hundreds of possible “flows” that could be observed across our different statuses and time points, and the way we get the N’s for each flow that is to:</p>
<ol type="1">
<li><p><code>group_by</code> all the different columns indicating statuses per time point (here it is <code>time_1</code>, <code>time_2</code>, …, <code>time_14</code>)</p></li>
<li><p><code>count()</code> across all those different <code>time_*</code> columns.</p></li>
</ol>
<p>To implement this, I’m first going to create an objects that will make my code a bit more flexible. I’m going to create a vector denoting the <code>time_*</code> column names of my new wide-form data set. This will help me call the right variables to group very soon.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>vars_to_group <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"time_"</span>, <span class="dv">0</span><span class="sc">:</span>max_time) </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>vars_to_group</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "time_0"  "time_1"  "time_2"  "time_3"  "time_4"  "time_5"  "time_6" 
 [8] "time_7"  "time_8"  "time_9"  "time_10" "time_11" "time_12" "time_13"
[15] "time_14"</code></pre>
</div>
</div>
<section id="step-2a-group_by_at" class="level2">
<h2 class="anchored" data-anchor-id="step-2a-group_by_at">Step 2a: <code>group_by_at</code></h2>
<p>Now, we want to first group by the columns that contain the status of each observation. For me, these are now in the vector <code>vars_to_group</code>. We will then use the dplyr function <code>group_by_at()</code> to group by <strong>all</strong> of those status-per-time columns. Let’s look at the data after we do that. It shouldn’t look any different from our <code>dat_wide</code>, except for the invisible “GROUPS:” of <code>time_1</code>, <code>time_2</code>, and so on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>dat_wide <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_at</span>(vars_to_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,300 × 16
# Groups:   time_0, time_1, time_2, time_3, time_4, time_5, time_6, time_7,
#   time_8, time_9, time_10, time_11, time_12, time_13, time_14 [701]
      id time_0   time_1 time_2 time_3 time_4 time_5 time_6 time_7 time_8 time_9
   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; 
 1     1 Non-IMV… Non-I… Non-I… AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 2     2 No supp… No su… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I…
 3     3 No supp… Disch… Disch… Disch… Disch… Disch… Disch… Disch… Disch… Disch…
 4     4 Non-IMV… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Decea… Decea…
 5     5 Non-IMV… Non-I… Non-I… Non-I… Non-I… No su… No su… No su… Disch… Disch…
 6     6 Non-IMV… Non-I… AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 7     7 Non-IMV… No su… AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 8     8 Non-IMV… Non-I… Non-I… No su… No su… No su… Disch… Disch… Disch… Disch…
 9     9 No supp… Non-I… Non-I… Non-I… Non-I… Non-I… Non-I… Disch… Disch… Disch…
10    10 IMV      AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
# ℹ 3,290 more rows
# ℹ 5 more variables: time_10 &lt;chr&gt;, time_11 &lt;chr&gt;, time_12 &lt;chr&gt;,
#   time_13 &lt;chr&gt;, time_14 &lt;chr&gt;</code></pre>
</div>
</div>
</section>
<section id="step-2b-count" class="level2">
<h2 class="anchored" data-anchor-id="step-2b-count">Step 2b: <code>count</code></h2>
<p>Once the data is properly grouped, <code>count()</code> will return the N’s for each unique path or flow we observe in our data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dat_alluvial <span class="ot">&lt;-</span>  dat_wide <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_at</span>(vars_to_group) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s a bit hard to see what happened there, but a new column <code>n</code> was created with the N’s in each pathway. We can see this better if we <code>select(n, everything())</code> (meaning select n, then all the other columns).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dat_alluvial <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n, <span class="fu">everything</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 701 × 16
# Groups:   time_0, time_1, time_2, time_3, time_4, time_5, time_6, time_7,
#   time_8, time_9, time_10, time_11, time_12, time_13, time_14 [701]
       n time_0 time_1   time_2 time_3 time_4 time_5 time_6 time_7 time_8 time_9
   &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; 
 1    45 IMV    AKI      AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 2     3 IMV    Deceased Decea… Decea… Decea… Decea… Decea… Decea… Decea… Decea…
 3    18 IMV    IMV      AKI    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 4     2 IMV    IMV      Decea… Decea… Decea… Decea… Decea… Decea… Decea… Decea…
 5     5 IMV    IMV      IMV    AKI    AKI    AKI    AKI    AKI    AKI    AKI   
 6     3 IMV    IMV      IMV    IMV    AKI    AKI    AKI    AKI    AKI    AKI   
 7     3 IMV    IMV      IMV    IMV    IMV    AKI    AKI    AKI    AKI    AKI   
 8     2 IMV    IMV      IMV    IMV    IMV    Decea… Decea… Decea… Decea… Decea…
 9     2 IMV    IMV      IMV    IMV    IMV    IMV    AKI    AKI    AKI    AKI   
10     1 IMV    IMV      IMV    IMV    IMV    IMV    IMV    AKI    AKI    AKI   
# ℹ 691 more rows
# ℹ 5 more variables: time_10 &lt;chr&gt;, time_11 &lt;chr&gt;, time_12 &lt;chr&gt;,
#   time_13 &lt;chr&gt;, time_14 &lt;chr&gt;</code></pre>
</div>
</div>
<p>So, we can see that 45 patients have an exposure of Invasive Mechanical Ventilation (IMV) their index day of hospitalization, and then get Acute Kidney Injury (AKI), by their first full day of hospitalization.</p>
</section>
<section id="step-2c-ggalluvialto_lodes_form" class="level2">
<h2 class="anchored" data-anchor-id="step-2c-ggalluvialto_lodes_form">Step 2c: <code>ggalluvial::to_lodes_form()</code></h2>
<p>Now, we will use the <code>ggalluvial</code> package’s function <code>to_lodes_form</code> to transfer all the potential paths into what is called “lodes form.”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Titanic data in alluvia format</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>titanic_alluvia <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(Titanic)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(titanic_alluvia)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Class    Sex   Age Survived Freq
1   1st   Male Child       No    0
2   2nd   Male Child       No    0
3   3rd   Male Child       No   35
4  Crew   Male Child       No    0
5   1st Female Child       No    0
6   2nd Female Child       No    0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is_alluvia_form</span>(titanic_alluvia,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">weight =</span> <span class="st">"Freq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Titanic data in lodes format</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>titanic_lodes <span class="ot">&lt;-</span> <span class="fu">to_lodes_form</span>(titanic_alluvia,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">key =</span> <span class="st">"x"</span>, <span class="at">value =</span> <span class="st">"stratum"</span>, <span class="at">id =</span> <span class="st">"alluvium"</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">axes =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(titanic_lodes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Freq alluvium     x stratum
1    0        1 Class     1st
2    0        2 Class     2nd
3   35        3 Class     3rd
4    0        4 Class    Crew
5    0        5 Class     1st
6    0        6 Class     2nd</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>titanic_lodes2 <span class="ot">&lt;-</span> <span class="fu">to_lodes_form</span>(titanic_alluvia,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">key =</span> variable, <span class="at">value =</span> value,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">id =</span> cohort,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">diffuse =</span> Class)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(titanic_lodes2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  cohort Class Survived Freq variable value
1      1   1st       No    0    Class   1st
2      1   1st       No    0      Sex  Male
3      1   1st       No    0      Age Child
4      2   2nd       No    0    Class   2nd
5      2   2nd       No    0      Sex  Male
6      2   2nd       No    0      Age Child</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>dat_alluvial <span class="ot">&lt;-</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>   dat_alluvial<span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_lodes_form</span>(<span class="at">key =</span> <span class="st">"time"</span>, <span class="at">axes =</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(vars_to_group)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2d-changes-x-axis-and-reorder-statusstratum-levels" class="level2">
<h2 class="anchored" data-anchor-id="step-2d-changes-x-axis-and-reorder-statusstratum-levels">Step 2d: Changes x-axis and reorder status/stratum levels</h2>
<p>Now, we want the x-axis on our plot to show time in numbers, rather than <code>time_0</code>, <code>time_1</code>, etc., so we will use <code>parse_number()</code> to extract the number from our new column <code>time</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>dat_alluvial <span class="ot">&lt;-</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  dat_alluvial <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">factor</span>(<span class="fu">parse_number</span>(<span class="fu">as.character</span>(time)))) <span class="co"># time column is a factor, so first change to character, then parse_number, then change it back to a factor</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, we will organize the</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dat_alluvial <span class="ot">&lt;-</span> dat_alluvial <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stratum =</span> <span class="fu">fct_relevel</span>(stratum,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"No supplemental oxygen"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"Non-IMV supplemental oxygen"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"IMV"</span>, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"AKI"</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"Deceased"</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"Discharged"</span>))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>dat_alluvial</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,515 × 4
       n alluvium time  stratum
   &lt;int&gt;    &lt;int&gt; &lt;fct&gt; &lt;fct&gt;  
 1    45        1 0     IMV    
 2     3        2 0     IMV    
 3    18        3 0     IMV    
 4     2        4 0     IMV    
 5     5        5 0     IMV    
 6     3        6 0     IMV    
 7     3        7 0     IMV    
 8     2        8 0     IMV    
 9     2        9 0     IMV    
10     1       10 0     IMV    
# ℹ 10,505 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="step-3-set-up-colors" class="level1">
<h1>Step 3: Set up colors</h1>
<p>Now, we want to create a vector of colors, which I’ll call <code>type_colors</code>, that follows the same order of our <code>stratum</code> factor levels we defined above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>type_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#374E55"</span>, <span class="co"># gray</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"#79AF97"</span>, <span class="co"># green</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"#DF8F44"</span>, <span class="co">#orange</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"#00A1D5"</span>, <span class="co">#bluea,</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"#B24745"</span>, <span class="co">#red</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"#6A6599"</span> <span class="co"># purple</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                 ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once our colors are defined, we will add start with a standard ggplot function and add in the relevant arguments, e.g.&nbsp;x axis is <code>time</code> and y axis is the counts in column <code>n</code>. The color and fill of our plot’s bars will be determined by the <code>stratum</code> column. The …… will also be determined by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> dat_alluvial <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">stratum =</span> stratum, </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> stratum,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">alluvium =</span> alluvium,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">y=</span>n,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> stratum)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>Now, we will usse the function <code>geom_flow()</code> to…..??</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flow</span>() </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stratum</span>() </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>We can change the fill of the columns to match our selected colors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> type_colors) </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>We can change the outline of the columns to match our selected colors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> type_colors) </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>We can remove extra white space with <code>theme_classic()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Study Day"</span>, <span class="at">y =</span> <span class="st">"Number of Patients"</span>, <span class="at">title =</span> <span class="st">"Number of Patients per Exposure-Outcome Status by Day"</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Status"</span>, <span class="at">col =</span> <span class="st">"Status"</span>) </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text=</span><span class="fu">element_text</span>(<span class="at">family=</span><span class="st">"Times"</span>, <span class="at">size=</span><span class="dv">11</span>),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">size=</span><span class="dv">9</span>))</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<!-- ## Step 0: Load the data -->
<!-- ```{r} -->
<!-- sofa_wide <- read_csv(here::here("blog/alluvial/pseudo_sofa_khstats.csv")) |> -->
<!--   mutate(across(starts_with("day"), ~factor(.x, levels=c("Deceased", 0:4,"Missing","Discharged")))) |>   filter(score_type == "pulmonary_sofa") -->
<!-- ``` -->
<!-- The data structure we will use for each alluvial plot is **wide format**, i.e. one row per unit, and one column per time period. -->
<!-- The `sofa_wide` data set shows this wide format data with one row for each of the six SOFA subscore per patient. We will subset this data for now to one subscore, the pulmonary SOFA score, and use this data to make our first plot. -->
<!-- ```{r} -->
<!-- glimpse(sofa_wide) -->
<!-- head(sofa_wide) -->
<!-- ``` -->
<!-- ## Step 2 -->
<!-- ```{r} -->
<!-- sofa_wide |> -->
<!--       group_by(day0, day1, day2, day3) |> -->
<!--     count(.drop = F)  -->
<!-- ``` -->
<!-- # Step 3 -->
<!-- ```{r} -->
<!-- sofa_wide |> -->
<!--     group_by(day0, day1, day2, day3) |> -->
<!--     count(.drop = F) |> -->
<!--     ungroup() |> -->
<!--     to_lodes_form(key = "day", axes = 1:4) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- sofa_wide |> -->
<!--     group_by(day0, day1, day2, day3) |> -->
<!--     count(.drop = F) |> -->
<!--     ungroup() |> -->
<!--     to_lodes_form(key = "day", axes = 1:4)  |> -->
<!--     mutate(day = case_when(day == "day0" ~ "B", -->
<!--                            TRUE ~ as.character(parse_number(as.character(day)))), -->
<!--            day = fct_relevel(day, "B")) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- sofa_alluv <- sofa_wide |> -->
<!--     group_by(day0, day1, day2, day3) |> -->
<!--     count(.drop = F) |> -->
<!--     ungroup() |> -->
<!--     to_lodes_form(key = "day", axes = 1:4)  |> -->
<!--     mutate(day = case_when(day == "day0" ~ "B", -->
<!--                            TRUE ~ as.character(parse_number(as.character(day)))), -->
<!--            day = fct_relevel(day, "B")) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- p <- -->
<!--   sofa_alluv |> -->
<!--     ggplot(aes(x = day, -->
<!--                y = n, -->
<!--                stratum = stratum, -->
<!--                alluvium = alluvium, -->
<!--                fill = stratum)) -->
<!-- p -->
<!-- ``` -->
<!-- ```{r} -->
<!-- p <- p + geom_flow()  -->
<!-- p -->
<!-- ``` -->
<!-- ```{r} -->
<!-- p <- p + geom_stratum()  -->
<!-- p -->
<!-- ``` -->
<!-- ```{r} -->
<!-- p <- p + theme_classic()  -->
<!-- p -->
<!-- ``` -->
<!-- ```{r} -->
<!-- p <- p + coord_cartesian(xlim = c(.5,4.5), -->
<!--                          ylim = c(0,100), -->
<!--                          expand=F)  -->
<!-- p -->
<!-- ``` -->
<!-- ```{r} -->
<!-- p <- p + -->
<!--   labs(x = "Day", -->
<!--        y = "Count", -->
<!--        fill = "Subscore",  -->
<!--        title = "Pulmonary SOFA Score by Day") -->
<!-- p -->
<!-- ``` -->
<!-- ```{r} -->
<!-- my_pal <- ggsci::pal_nejm("default", alpha = 0.6)(8) -->
<!-- p <- p +   scale_fill_manual(values = my_pal, drop=F)  -->
<!-- p -->
<!-- ``` -->
<!-- ```{r} -->
<!-- p <- sofa_wide |> -->
<!--     group_by(day0, day1, day2, day3) |> -->
<!--     count(.drop = F) |> -->
<!--     ungroup() |> -->
<!--     to_lodes_form(key = "day", axes = 1:4)  |> -->
<!--     mutate(day = case_when(day == "day0" ~ "B", -->
<!--                            TRUE ~ as.character(parse_number(as.character(day)))), -->
<!--            day = fct_relevel(day, "B")) |> -->
<!--     ggplot(aes(x = day, y = n, -->
<!--                stratum = stratum, -->
<!--                alluvium = alluvium, -->
<!--                fill = stratum)) + -->
<!--     geom_flow() + -->
<!--     geom_stratum() + -->
<!--     theme_classic() + -->
<!--     scale_x_discrete(expand = c(0.1,0.1)) + -->
<!--     scale_fill_manual(values = my_pal, drop=F) + -->
<!--     labs(x = "Day", y = "Count", -->
<!--          fill = "Subscore", title = "Pulmonary SOFA Score by Day") -->
<!-- p -->
<!-- ``` -->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("www\.khstats\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>